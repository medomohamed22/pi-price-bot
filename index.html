<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donate Way</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;700&display=swap" rel="stylesheet">
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* (Ù†ÙØ³ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© ØªÙ†Ø³ÙŠÙ‚ Ù„Ø²Ø± Ø§Ù„Ø¥ØµÙ„Ø§Ø­) */
        :root { --primary-purple: #8e44ad; --success: #2ecc71; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Tajawal', sans-serif; }
        body { background: #f0f2f5; padding-top: 110px; }
        header { position: fixed; top: 0; left: 0; right: 0; height: 75px; display: flex; justify-content: space-between; align-items: center; padding: 0 5%; background: rgba(255,255,255,0.85); backdrop-filter: blur(25px); z-index: 9999; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .user-pill { display: none; align-items: center; gap: 8px; background: white; padding: 4px 12px; border-radius: 50px; border: 1px solid var(--primary-purple); color: var(--primary-purple); font-size: 0.85rem; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .card { background: white; border-radius: 35px; padding: 25px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .donate-btn { width: 100%; padding: 15px; border-radius: 20px; border: none; background: var(--primary-purple); color: white; font-weight: 700; cursor: pointer; }
        .fix-btn { background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 50px; font-size: 0.7rem; cursor: pointer; margin-top: 5px; }
        #custom-alert { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #2d3436; color: white; padding: 15px 35px; border-radius: 50px; display: none; z-index: 10001; }
        .loader { display: none; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-purple); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 10px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="custom-alert"></div>

    <header>
        <div class="logo">Donate Way</div>
        <div style="display: flex; flex-direction: column; align-items: flex-end;">
            <div id="auth-section">
                <button id="login-button" onclick="login()" style="background:var(--primary-purple); color:white; border:none; padding:10px 20px; border-radius:50px; cursor:pointer;">Ø¯Ø®ÙˆÙ„</button>
                <div id="user-pill" class="user-pill"><span id="username-display"></span></div>
            </div>
            <button id="fix-payment-btn" class="fix-btn" style="display:none;" onclick="fixPendingPayment()">Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù…Ø¹Ù„Ù‚ ğŸ› ï¸</button>
        </div>
    </header>

    <div class="container">
        <div id="main-loader" class="loader"></div>
        <div id="campaigns-container"></div>
    </div>

    <script>
        const Pi = window.Pi;
        let currentUser = null;

        // 1. Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ© Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù…Ø¹Ù„Ù‚
        async function onIncompletePaymentFound(payment) {
            console.log("Incomplete payment detected:", payment);
            showMsg("ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø¯ÙØ¹ Ù…Ø¹Ù„Ù‚.. Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©");
            
            // Ø§Ù„Ø­Ù„ Ø§Ù„Ø¬Ø°Ø±ÙŠ: Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© ÙÙˆØ±Ø§Ù‹ Ù„Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù„Ø¹Ù…Ù„ Complete
            // Ù…Ù„Ø§Ø­Ø¸Ø©: ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù„Ø¯ÙŠÙƒ Backend ÙŠÙ‚ÙˆÙ… Ø¨Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ /payments/complete
            try {
                const response = await fetch('https://YOUR_BACKEND_URL/complete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ paymentId: payment.identifier, txid: payment.transaction.txid })
                });
                if (response.ok) showMsg("ØªÙ… Ø­Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ¨Ø±Ø¹ Ø§Ù„Ø¢Ù†.");
            } catch (e) {
                console.error("Fix failed", e);
                showMsg("ÙØ´Ù„ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ. ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù….");
            }
        }

        // Ø²Ø± ÙŠØ¯ÙˆÙŠ Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚
        function fixPendingPayment() {
            showMsg("Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø¹Ù† Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø¹Ø§Ù„Ù‚Ø©...");
            Pi.authenticate(['payments'], onIncompletePaymentFound)
              .then(() => showMsg("Ø§Ù„ÙØ­Øµ Ø§ÙƒØªÙ…Ù„. Ø¥Ø°Ø§ Ø§Ø³ØªÙ…Ø±Øª Ø§Ù„Ù…Ø´ÙƒÙ„Ø©ØŒ Ø§Ù†ØªØ¸Ø± Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ†."))
              .catch(() => showMsg("ØªØ£ÙƒØ¯ Ù…Ù† ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¯Ø§Ø®Ù„ Ù…ØªØµÙØ­ Pi"));
        }

        async function login() {
            try {
                const auth = await Pi.authenticate(['username', 'payments'], onIncompletePaymentFound);
                currentUser = auth.user;
                document.getElementById('login-button').style.display = 'none';
                document.getElementById('user-pill').style.display = 'flex';
                document.getElementById('fix-payment-btn').style.display = 'block';
                document.getElementById('username-display').textContent = currentUser.username;
            } catch (e) {
                showMsg("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„: " + e.message);
            }
        }

        function showMsg(text) {
            const alertBox = document.getElementById('custom-alert');
            alertBox.innerText = text; alertBox.style.display = 'block';
            setTimeout(() => { alertBox.style.display = 'none'; }, 5000);
        }

        // Ø¹Ù†Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¯ÙØ¹ ÙˆÙØ´Ù„Ù‡Ø§ Ø¨Ø³Ø¨Ø¨ "Pending"
        function handleDonate(id) {
            if (!currentUser) return showMsg("Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ø£ÙˆÙ„Ø§Ù‹");
            const amt = 1.0; // Ù…Ø«Ø§Ù„

            Pi.createPayment({
                amount: amt,
                memo: "ØªØ¨Ø±Ø¹ Ù„Ù„Ù…Ù†ØµØ©",
                metadata: { campaignId: id }
            }, {
                onReadyForServerApproval: (id) => {/* Ø§ØªØµÙ„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ± Ù„Ø¹Ù…Ù„ approve */},
                onReadyForServerCompletion: (id, tx) => {/* Ø§ØªØµÙ„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ± Ù„Ø¹Ù…Ù„ complete */},
                onCancel: () => {},
                onError: (error) => {
                    if (error.message.includes("pending payment")) {
                        showMsg("Ù„Ø¯ÙŠÙƒ Ø¯ÙØ¹ Ù…Ø¹Ù„Ù‚. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± 'Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø¯ÙØ¹' ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ ğŸ› ï¸");
                        document.getElementById('fix-payment-btn').style.background = '#f1c40f';
                    }
                }
            });
        }

        window.onload = () => { 
            Pi.init({ version: "2.0" });
            // ÙØ­Øµ ÙÙˆØ±ÙŠ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
            setTimeout(() => {
                if(window.Pi) Pi.authenticate(['payments'], onIncompletePaymentFound).catch(()=>{});
            }, 1000);
        };
    </script>
</body>
</html>

