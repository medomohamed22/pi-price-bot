<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ø·Ù„Ø¨Ø§Øª Ø¨Ø±Ùˆ | Pi (iOS 26 UI)</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Pi SDK -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap');

    :root{
      --bg1:#0b1220;
      --bg2:#0f172a;
      --glass: rgba(255,255,255,.08);
      --glass2: rgba(255,255,255,.12);
      --stroke: rgba(255,255,255,.12);
      --txt: #e5e7eb;
      --muted: rgba(229,231,235,.7);
      --accent:#ff7a1a;
      --accent2:#a78bfa;
      --ok:#22c55e;
      --bad:#ef4444;
      --warn:#f59e0b;
      --chip: rgba(255,255,255,.06);
    }

    body{
      font-family:Tajawal,system-ui;
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(167,139,250,.35), transparent 60%),
        radial-gradient(1200px 600px at 90% 0%, rgba(255,122,26,.28), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      color: var(--txt);
    }

    .glass{
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border: 1px solid var(--stroke);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      box-shadow: 0 18px 60px rgba(0,0,0,.35);
      border-radius: 22px;
    }

    .soft{
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 18px;
    }

    .chip{
      font-size:12px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: var(--chip);
      color: var(--txt);
      display:inline-flex;
      align-items:center;
      gap:8px;
    }

    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace
    }

    .row{display:flex;justify-content:space-between;gap:12px;align-items:center}

    .btn{
      border-radius:16px;
      padding:12px 14px;
      font-weight:800;
      transition:.2s;
      user-select:none;
    }
    .btn:active{transform:scale(.98)}
    .btnA{
      background: linear-gradient(135deg, rgba(255,122,26,.95), rgba(255,122,26,.65));
      border: 1px solid rgba(255,255,255,.12);
      color:white;
      box-shadow: 0 14px 40px rgba(255,122,26,.18);
    }
    .btnP{
      background: linear-gradient(135deg, rgba(167,139,250,.95), rgba(167,139,250,.65));
      border: 1px solid rgba(255,255,255,.12);
      color:white;
      box-shadow: 0 14px 40px rgba(167,139,250,.18);
    }
    .btnG{
      background: linear-gradient(135deg, rgba(34,197,94,.95), rgba(34,197,94,.65));
      border: 1px solid rgba(255,255,255,.12);
      color:white;
    }
    .btnB{
      background: linear-gradient(135deg, rgba(59,130,246,.95), rgba(59,130,246,.65));
      border: 1px solid rgba(255,255,255,.12);
      color:white;
    }
    .btnS{
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      color: var(--txt);
    }

    input,textarea,select{
      background: rgba(255,255,255,.06) !important;
      border: 1px solid rgba(255,255,255,.10) !important;
      color: var(--txt) !important;
      border-radius: 18px !important;
      outline: none !important;
    }
    input::placeholder, textarea::placeholder{color: rgba(229,231,235,.55)}
    textarea{min-height:90px}

    .msg{
      max-width:78%;
      padding:10px 12px;
      border-radius:18px;
      font-size:13px;
      word-break:break-word;
      border:1px solid rgba(255,255,255,.10);
    }
    .c{background: rgba(255,122,26,.22); color:#fff; align-self:flex-start}
    .d{background: rgba(255,255,255,.10); color: var(--txt); align-self:flex-end}

    .tiny{font-size:11px;color:rgba(229,231,235,.65)}
    .muted{color:rgba(229,231,235,.7)}
  </style>
</head>

<body class="pb-24">
  <!-- HEADER -->
  <header class="sticky top-0 z-50 px-3 pt-3">
    <div class="max-w-lg mx-auto glass p-4 flex items-center justify-between">
      <div class="font-extrabold text-lg flex items-center gap-2">
        <span class="w-9 h-9 rounded-2xl flex items-center justify-center soft">ğŸš€</span>
        Ø·Ù„Ø¨Ø§Øª Ø¨Ø±Ùˆ
      </div>
      <div class="flex items-center gap-2">
        <span id="piTag" class="chip">â€¦</span>
      </div>
    </div>
  </header>

  <div class="max-w-lg mx-auto p-3 space-y-3">

    <!-- PI STATUS + RATES -->
    <div class="glass p-4 space-y-3">
      <div class="row">
        <div class="text-sm">
          <b>Ø­Ø§Ù„Ø© Pi:</b> <span id="piStateText" class="muted">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...</span>
        </div>
        <span class="chip">â±ï¸ ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ</span>
      </div>

      <div class="grid grid-cols-2 gap-2 text-xs">
        <div class="soft p-3">
          <div class="muted">Ø³Ø¹Ø± Pi (USDT)</div>
          <div class="font-extrabold mono text-base"><span id="piUsdt">â€”</span></div>
          <div class="tiny">Ù…ØµØ¯Ø±: OKX</div>
        </div>
        <div class="soft p-3">
          <div class="muted">Ø³Ø¹Ø± USD (EGP)</div>
          <div class="font-extrabold mono text-base"><span id="usdEgp">â€”</span></div>
          <div class="tiny">Ù…ØµØ¯Ø±: open.er-api.com</div>
        </div>
      </div>

      <div class="tiny">
        Pi ÙƒÙ„ <b>30 Ø«Ø§Ù†ÙŠØ©</b> â€” USD/EGP ÙƒÙ„ <b>60 Ø«Ø§Ù†ÙŠØ©</b>. | 1 Pi â‰ˆ <span class="mono" id="piEgpOne">â€”</span> Ø¬
      </div>
    </div>

    <!-- LOGIN -->
    <div id="loginBox" class="glass p-4 text-center space-y-3">
      <div class="text-sm muted">Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ø¨Ø­Ø³Ø§Ø¨ Pi Ø¹Ø´Ø§Ù† ØªÙ‚Ø¯Ø± ØªØ·Ù„Ø¨/ØªØ´ØªØºÙ„ Ø¯Ù„ÙŠÙØ±ÙŠ.</div>
      <button id="loginBtn" onclick="piLogin()" class="btn btnP w-full">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Pi</button>
      <button onclick="devLogin()" class="text-xs underline muted">Ø¯Ø®ÙˆÙ„ ØªØ¬Ø±ÙŠØ¨ÙŠ (Ø§Ø®ØªØ¨Ø§Ø± Ø®Ø§Ø±Ø¬ Pi Browser)</button>
    </div>

    <!-- TABS -->
    <div id="tabs" class="hidden glass p-2 flex gap-2">
      <button id="btnC" onclick="showTab('customer')" class="btn btnS flex-1">Ø¹Ù…ÙŠÙ„</button>
      <button id="btnD" onclick="showTab('delivery')" class="btn btnS flex-1">Ø¯Ù„ÙŠÙØ±ÙŠ</button>
      <a id="adminLink" href="./admin.html" class="btn btnS">Admin</a>
    </div>

    <!-- ================= CUSTOMER ================= -->
    <div id="customer" class="hidden space-y-3">

      <div class="glass p-4 space-y-3">
        <div class="row">
          <div class="text-sm">Ø£Ù‡Ù„Ù‹Ø§ <b id="custName">â€”</b></div>
          <span class="chip">ğŸ’³ Pi Pay</span>
        </div>

        <select id="orderType" class="w-full p-3">
          <option value="any">Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨: Ø£ÙŠ Ø­Ø§Ø¬Ø©</option>
          <option value="market">Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª</option>
          <option value="pharmacy">ØµÙŠØ¯Ù„ÙŠØ©</option>
          <option value="restaurant">Ù…Ø·Ø¹Ù…</option>
        </select>

        <input id="prod" class="w-full p-3" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" />
        <input id="price" type="number" class="w-full p-3" placeholder="Ø³Ø¹Ø± Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ø§Ù„Ø¬Ù†ÙŠÙ‡ Ø§Ù„Ù…ØµØ±ÙŠ" oninput="recalcInvoice()" />
        <textarea id="notes" class="w-full p-3" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª/Ø¨Ø¯Ø§Ø¦Ù„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>

        <!-- INVOICE -->
        <div class="soft p-3 space-y-2">
          <div class="row">
            <b class="text-sm">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨</b>
            <span class="chip">ØªÙˆØµÙŠÙ„: <b>20</b>Ø¬ | Ù…ÙˆÙ‚Ø¹: <b>10</b>Ø¬</span>
          </div>

          <div class="text-sm space-y-1">
            <div class="row"><span class="muted">Ø³Ø¹Ø± Ø§Ù„Ù…Ù†ØªØ¬</span><b><span id="invProdEgp">0</span> Ø¬</b></div>
            <div class="row"><span class="muted">Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„</span><b><span id="invDelFeeEgp">20</span> Ø¬</b></div>
            <div class="row"><span class="muted">Ø±Ø³ÙˆÙ… Ø§Ù„Ù…ÙˆÙ‚Ø¹</span><b><span id="invPlatFeeEgp">10</span> Ø¬</b></div>
            <div class="border-t border-white/10 pt-2 row">
              <span class="font-extrabold">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
              <b class="text-emerald-300"><span id="invTotalEgp">0</span> Ø¬</b>
            </div>

            <div class="soft p-3 mt-2">
              <div class="tiny">Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Pi (ØªÙ‚Ø±ÙŠØ¨ÙŠ):</div>
              <div class="row text-sm mt-1">
                <span class="muted">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ù€ Pi</span>
                <b class="mono text-purple-300"><span id="invTotalPi">0</span> Pi</b>
              </div>
            </div>
          </div>
        </div>

        <button onclick="payAndCreate()" class="btn btnA w-full">Ø§Ø¯ÙØ¹ Ø¨Ù€ Pi ÙˆØ§Ø·Ù„Ø¨ ğŸš€</button>
      </div>

      <!-- TRACK -->
      <div id="custTrack" class="hidden glass p-4 space-y-2">
        <div class="row">
          <b>Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨:</b>
          <b id="custStatus" class="text-orange-300">pending</b>
        </div>
        <div id="otpBox" class="hidden text-sm">
          ÙƒÙˆØ¯ Ø§Ù„ØªØ³Ù„ÙŠÙ…: <b id="otp" class="text-orange-200 text-lg mono"></b>
        </div>
      </div>

      <!-- CHAT -->
      <div id="custChat" class="hidden glass p-4 space-y-2">
        <div class="row">
          <b class="text-sm">Ø§Ù„Ø´Ø§Øª</b>
          <div class="flex gap-2">
            <button class="chip" onclick="quick('customer','Ø£Ù†Ø§ ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚ØŸ')">ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚ØŸ</button>
            <button class="chip" onclick="quick('customer','Ù„Ùˆ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ØŒ Ø¨Ø¯ÙŠÙ„ØŸ')">Ø¨Ø¯ÙŠÙ„ØŸ</button>
          </div>
        </div>

        <div id="chatC" class="flex flex-col gap-2 h-52 overflow-y-auto soft p-3"></div>

        <div class="flex gap-2 items-center">
          <input id="msgC" class="flex-1 p-3" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." />
          <input type="file" id="imgC" accept="image/*" class="text-xs w-28" />
          <button onclick="sendMsg('customer')" class="btn btnA">â¤</button>
        </div>
        <div class="tiny">âœ… = Ø§ØªØ¨Ø¹Øª | âœ…âœ… = Ø§ØªÙ‚Ø±ÙŠØª</div>
      </div>

      <!-- CUSTOMER HISTORY -->
      <div class="glass p-4 space-y-2">
        <div class="row">
          <b class="text-sm">Ø³Ø¬Ù„ Ø·Ù„Ø¨Ø§ØªÙŠ</b>
          <button class="chip" onclick="loadCustomerHistory()">ØªØ­Ø¯ÙŠØ«</button>
        </div>
        <div id="custHistory" class="space-y-2 text-sm"></div>
      </div>

    </div>

    <!-- ================= DELIVERY ================= -->
    <div id="delivery" class="hidden space-y-3">

      <div class="glass p-4">
        <div class="row">
          <div class="text-sm">Ø§Ù„ÙƒØ§Ø¨ØªÙ†: <b id="delName">â€”</b></div>
          <button onclick="loadOrders()" class="chip">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
        </div>
      </div>

      <div id="ordersBox" class="space-y-2"></div>

      <!-- DELIVERY CHAT -->
      <div id="delChat" class="hidden glass p-4 space-y-2">
        <div class="row">
          <b class="text-sm">Ø´Ø§Øª Ø§Ù„Ø·Ù„Ø¨</b>
          <div class="flex gap-2">
            <button class="chip" onclick="quick('delivery','Ø£Ù†Ø§ ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚ ğŸ›µ')">ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚</button>
            <button class="chip" onclick="quick('delivery','Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ØªÙˆÙØ±ØŒ Ø¨Ø¯ÙŠÙ„ØŸ')">ØºÙŠØ± Ù…ØªÙˆÙØ±</button>
          </div>
        </div>

        <div class="soft p-3 text-sm space-y-1" id="delOrderDetails">
          <div class="row"><span class="muted">Ø§Ù„Ù…Ù†ØªØ¬</span><b id="dProd">â€”</b></div>
          <div class="row"><span class="muted">Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨</span><b id="dType">â€”</b></div>
          <div class="row"><span class="muted">Ø³Ø¹Ø± Ø§Ù„Ù…Ù†ØªØ¬</span><b><span id="dProdEgp">â€”</span> Ø¬</b></div>
          <div class="row"><span class="muted">ØªÙˆØµÙŠÙ„</span><b><span id="dDelFeeEgp">20</span> Ø¬</b></div>
          <div class="row"><span class="muted">Ø±Ø³ÙˆÙ… Ù…ÙˆÙ‚Ø¹</span><b><span id="dPlatFeeEgp">10</span> Ø¬</b></div>
          <div class="border-t border-white/10 pt-2 row"><span class="font-extrabold">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span><b class="text-emerald-300"><span id="dTotalEgp">â€”</span> Ø¬</b></div>
          <div class="row"><span class="muted">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ù€ Pi</span><b class="mono text-purple-300"><span id="dTotalPi">â€”</span> Pi</b></div>
          <div class="tiny">Ù…Ù„Ø§Ø­Ø¸Ø§Øª: <span id="dNotes">â€”</span></div>
        </div>

        <div id="chatD" class="flex flex-col gap-2 h-52 overflow-y-auto soft p-3"></div>

        <div class="flex gap-2 items-center">
          <input id="msgD" class="flex-1 p-3" placeholder="Ø±Ø³Ø§Ù„Ø©..." />
          <input type="file" id="imgD" accept="image/*" class="text-xs w-28" />
          <button onclick="sendMsg('delivery')" class="btn btnB">â¤</button>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <button onclick="setOrderStatus('arrived')" class="btn btnA">ÙˆØµÙ„Øª</button>
          <button onclick="finishWithOtp()" class="btn btnG">ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</button>
        </div>
      </div>

      <!-- WALLET + WITHDRAW -->
      <div class="glass p-4 space-y-2">
        <b class="text-sm">Ù…Ø­ÙØ¸ØªÙŠ (Pi)</b>
        <div class="text-sm">
          Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø­:
          <b class="mono text-purple-300"><span id="walletPi">0.000000</span> Pi</b>
        </div>

        <input id="wdAmountPi" type="number" step="0.000001" class="w-full p-3" placeholder="ÙƒÙ… Pi Ù‡ØªØ³Ø­Ø¨ØŸ" />
        <input id="wdWallet" class="w-full p-3" placeholder="Ø¹Ù†ÙˆØ§Ù† Ù…Ø­ÙØ¸Ø© Pi" />

        <button onclick="withdrawPi()" class="btn btnP w-full">Ø·Ù„Ø¨ Ø³Ø­Ø¨ Pi</button>
        <div class="tiny">Ø³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø·Ù„Ø¨ ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù‚Ø¨Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„</div>
      </div>

      <!-- WITHDRAW HISTORY -->
      <div class="glass p-4 space-y-2">
        <div class="row">
          <b class="text-sm">Ø³Ø¬Ù„ Ø§Ù„Ø³Ø­Ø¨</b>
          <button class="chip" onclick="loadWithdrawHistory()">ØªØ­Ø¯ÙŠØ«</button>
        </div>
        <div id="wdHistory" class="space-y-2 text-sm"></div>
      </div>

      <!-- DELIVERY HISTORY -->
      <div class="glass p-4 space-y-2">
        <div class="row">
          <b class="text-sm">Ø³Ø¬Ù„ Ø·Ù„Ø¨Ø§ØªÙŠ ÙƒØ¯Ù„ÙŠÙØ±ÙŠ</b>
          <button class="chip" onclick="loadDeliveryHistory()">ØªØ­Ø¯ÙŠØ«</button>
        </div>
        <div id="delHistory" class="space-y-2 text-sm"></div>
      </div>

    </div>

  </div>

<script>
/* ================== CONFIG ================== */
Pi.init({ version: "2.0", sandbox: false });

const SUPABASE_URL = 'https://axjkwrssmofzavaoqutq.supabase.co';
const SUPABASE_KEY = 'sb_publishable_tiuMncgWhf1YRWoD-uYQ3Q_ziI8OKci';
const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ================== FEES ================== */
const DELIVERY_FEE_EGP = 20;
const PLATFORM_FEE_EGP = 10;

/* ================== GLOBALS ================== */
let PI_USER = null;
let PI_USERNAME = null;
let ACTIVE_ORDER = null;

/* ================== RATES ================== */
let PI_USDT = 0;     // 1 PI in USDT
let USD_EGP = 0;     // 1 USD in EGP

/* ================== DETECT ================== */
function detectPi() {
  const hasPi = typeof window.Pi !== 'undefined';
  const ua = (navigator.userAgent || '').toLowerCase();
  const isPiBrowser = ua.includes('pibrowser') || hasPi;

  document.getElementById('piStateText').innerText = hasPi ? 'SDK Ù…ÙˆØ¬ÙˆØ¯ ÙˆØ¬Ø§Ù‡Ø²' : 'SDK ØºÙŠØ± Ù…ØªØ§Ø­';
  document.getElementById('piTag').innerText = isPiBrowser ? 'Pi Browser' : 'Web';
}

document.addEventListener('DOMContentLoaded', () => {
  detectPi();
  refreshRates();
  setInterval(fetchPiFromOKX, 30000);
  setInterval(fetchUsdEgp, 60000);
});

/* ================== RATES ================== */
async function refreshRates(){
  await Promise.allSettled([fetchPiFromOKX(), fetchUsdEgp()]);
  recalcInvoice();
}

async function fetchPiFromOKX(){
  try{
    const r = await fetch("https://www.okx.com/api/v5/market/ticker?instId=PI-USDT", { cache: "no-store" });
    const j = await r.json();
    const last = parseFloat(j?.data?.[0]?.last || "0");
    if(last > 0) PI_USDT = last;

    document.getElementById('piUsdt').innerText = PI_USDT ? PI_USDT.toFixed(6) : 'â€”';
    updatePiEgpOne();
  }catch(e){
    console.warn('OKX PI ticker failed:', e);
  }
}

async function fetchUsdEgp(){
  try{
    const r = await fetch("https://open.er-api.com/v6/latest/USD", { cache: "no-store" });
    const j = await r.json();
    const rate = parseFloat(j?.rates?.EGP || "0");
    if(rate > 0) USD_EGP = rate;

    document.getElementById('usdEgp').innerText = USD_EGP ? USD_EGP.toFixed(4) : 'â€”';
    updatePiEgpOne();
  }catch(e){
    console.warn('USD/EGP failed:', e);
    document.getElementById('usdEgp').innerText = 'ÙØ´Ù„';
  }
}

function updatePiEgpOne(){
  const piEgp = (PI_USDT && USD_EGP) ? (PI_USDT * USD_EGP) : 0;
  document.getElementById('piEgpOne').innerText = piEgp ? piEgp.toFixed(3) : 'â€”';
}

function egpToPi(egp){
  const piEgp = PI_USDT * USD_EGP;
  if(!piEgp || piEgp <= 0) return 0;
  return egp / piEgp;
}

/* ================== LOGIN ================== */
async function piLogin() {
  try {
    if (!window.Pi || !Pi.authenticate) {
      return Swal.fire({ icon: 'warning', title: 'Pi SDK ØºÙŠØ± Ù…ØªØ§Ø­', text: 'Ø§ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¯Ø§Ø®Ù„ Pi Browser.' });
    }

    const ua = (navigator.userAgent || '').toLowerCase();
    if (!ua.includes('pibrowser')) {
      const r = await Swal.fire({
        icon: 'info',
        title: 'Ù…Ù„Ø§Ø­Ø¸Ø©',
        text: 'Ø§Ù„Ø£ÙØ¶Ù„ ØªÙØªØ­ Ø¯Ø§Ø®Ù„ Pi Browser Ø¹Ø´Ø§Ù† Ø§Ù„Ø¯ÙØ¹ ÙŠØ´ØªØºÙ„ 100%.',
        showCancelButton: true,
        confirmButtonText: 'ÙƒÙ…Ù‘Ù„',
        cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
      });
      if (!r.isConfirmed) return;
    }

    Swal.fire({ title: 'Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...', didOpen: () => Swal.showLoading(), allowOutsideClick: false });

    const scopes = ['username', 'payments'];
    const auth = await Pi.authenticate(scopes, onIncompletePaymentFound);

    const username = auth?.user?.username || auth?.username || null;
    if (!username) throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªÙ„Ø§Ù… username Ù…Ù† Pi');

    PI_USER = auth;
    PI_USERNAME = username;

    document.getElementById('custName').innerText = PI_USERNAME;
    document.getElementById('delName').innerText = PI_USERNAME;

    document.getElementById('loginBox').classList.add('hidden');
    document.getElementById('tabs').classList.remove('hidden');

    // Ø²Ø± Admin ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ù„Ø£Ø¯Ù…Ù†
    if (PI_USERNAME === 'medomohamed22') {
      document.getElementById('adminLink').classList.remove('hidden');
    } else {
      document.getElementById('adminLink').classList.add('hidden');
    }

    showTab('customer');
    Swal.close();

    await refreshRates();
    loadOrders();
    loadWalletPi();
    loadCustomerHistory();
    loadDeliveryHistory();
    loadWithdrawHistory();

  } catch (e) {
    console.error('piLogin error:', e);
    Swal.fire({ icon: 'error', title: 'ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„', text: e?.message || 'Ø­ØµÙ„ Ø®Ø·Ø£' });
  }
}

function devLogin(){
  PI_USERNAME = 'dev_user_' + Math.floor(Math.random()*9999);

  document.getElementById('custName').innerText = PI_USERNAME;
  document.getElementById('delName').innerText = PI_USERNAME;

  document.getElementById('loginBox').classList.add('hidden');
  document.getElementById('tabs').classList.remove('hidden');

  document.getElementById('adminLink').classList.add('hidden');

  showTab('customer');
  refreshRates();
  loadOrders();
  loadWalletPi();
  loadCustomerHistory();
  loadDeliveryHistory();
  loadWithdrawHistory();
}

function onIncompletePaymentFound(payment) {
  console.log('incomplete payment found:', payment);
}

/* ================== INVOICE UI ================== */
function recalcInvoice(){
  const prodEgp = parseFloat(document.getElementById('price').value || "0") || 0;
  const totalEgp = prodEgp + DELIVERY_FEE_EGP + PLATFORM_FEE_EGP;
  const totalPi = egpToPi(totalEgp);

  document.getElementById('invProdEgp').innerText = prodEgp.toFixed(2);
  document.getElementById('invDelFeeEgp').innerText = DELIVERY_FEE_EGP.toFixed(2);
  document.getElementById('invPlatFeeEgp').innerText = PLATFORM_FEE_EGP.toFixed(2);
  document.getElementById('invTotalEgp').innerText = totalEgp.toFixed(2);
  document.getElementById('invTotalPi').innerText = totalPi ? totalPi.toFixed(6) : '0.000000';
}

/* ================== CUSTOMER: PAY + CREATE ORDER ================== */
async function payAndCreate() {
  try {
    if (!PI_USERNAME) return Swal.fire('Ù„Ø§Ø²Ù… ØªØ³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£ÙˆÙ„');

    const product = document.getElementById('prod').value.trim();
    const orderType = document.getElementById('orderType').value;
    const notes = document.getElementById('notes').value.trim();
    const prodEgp = parseFloat(document.getElementById('price').value || "0") || 0;

    if (!product || prodEgp <= 0) return Swal.fire('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ ÙˆØ³Ø¹Ø± ØµØ­ÙŠØ­');

    if (!(PI_USDT > 0 && USD_EGP > 0)) {
      await refreshRates();
      if (!(PI_USDT > 0 && USD_EGP > 0)) return Swal.fire('Ù…Ù‚Ø¯Ø±Ù†Ø§Ø´ Ù†Ø¬ÙŠØ¨ USD/EGP Ø¯Ù„ÙˆÙ‚ØªÙŠØŒ Ø¬Ø±Ù‘Ø¨ ØªØ§Ù†ÙŠ');
    }

    const totalEgp = prodEgp + DELIVERY_FEE_EGP + PLATFORM_FEE_EGP;
    const totalPi = egpToPi(totalEgp);
    const amountPi = Number(totalPi || 0).toFixed(6);

    const otp = String(Math.floor(1000 + Math.random() * 9000));

    const confirm = await Swal.fire({
      title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹',
      html: `
        <div style="text-align:right">
          <div>Ø³Ø¹Ø± Ø§Ù„Ù…Ù†ØªØ¬: <b>${prodEgp.toFixed(2)} Ø¬</b></div>
          <div>Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„: <b>${DELIVERY_FEE_EGP.toFixed(2)} Ø¬</b></div>
          <div>Ø±Ø³ÙˆÙ… Ø§Ù„Ù…ÙˆÙ‚Ø¹: <b>${PLATFORM_FEE_EGP.toFixed(2)} Ø¬</b></div>
          <hr/>
          <div>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <b style="color:#16a34a">${totalEgp.toFixed(2)} Ø¬</b></div>
          <div>ÙŠØ¹Ø§Ø¯Ù„ ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§: <b style="color:#a78bfa">${amountPi} Pi</b></div>
          <div style="font-size:12px;opacity:.75;margin-top:6px">
            (1 Pi â‰ˆ ${(PI_USDT*USD_EGP).toFixed(3)} Ø¬)
          </div>
        </div>
      `,
      showCancelButton: true,
      confirmButtonText: 'Ø§Ø¯ÙØ¹',
      cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
    });
    if (!confirm.isConfirmed) return;

    if (!window.Pi || !Pi.createPayment) {
      return Swal.fire('Pi Payment ØºÙŠØ± Ù…ØªØ§Ø­.. Ø§ÙØªØ­ Ø¯Ø§Ø®Ù„ Pi Browser');
    }

    Swal.fire({ title: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯ÙØ¹...', didOpen: () => Swal.showLoading(), allowOutsideClick: false });

    await Pi.createPayment({
      amount: amountPi,
      memo: `Talabat Pro | ${product} | Total ${totalEgp.toFixed(2)} EGP`,
      metadata: {
        product, orderType, prodEgp,
        deliveryFee: DELIVERY_FEE_EGP,
        platformFee: PLATFORM_FEE_EGP,
        totalEgp,
        pi_usdt: PI_USDT,
        usd_egp: USD_EGP
      }
    }, {
      onReadyForServerApproval: async (paymentId) => {
        await fetch('/api/pi/approve', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ paymentId })
        });
      },
      onReadyForServerCompletion: async (paymentId, txid) => {
        await fetch('/api/pi/complete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ paymentId, txid })
        });
      },
      onCancel: (paymentId) => console.log('payment canceled:', paymentId),
      onError: (err, p) => console.error('payment error:', err, p)
    });

    // Ø¨Ø¹Ø¯ Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¯ÙØ¹: Ù†ÙƒØªØ¨ Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ DB
    const deliveryFeePi = egpToPi(DELIVERY_FEE_EGP);
    const platformFeePi = egpToPi(PLATFORM_FEE_EGP);

    const { data, error } = await db.from('orders').insert([{
      product_name: product,
      order_type: orderType,
      notes: notes || null,

      price: prodEgp,
      delivery_fee: DELIVERY_FEE_EGP,
      platform_fee: PLATFORM_FEE_EGP,

      total_price: totalEgp,
      status: 'pending',
      otp_code: otp,
      customer_pi_username: PI_USERNAME,
      can_modify_until: new Date(Date.now() + 60_000).toISOString(),

      pricing_snapshot: {
        pi_usdt: PI_USDT,
        usd_egp: USD_EGP,
        pi_egp: (PI_USDT * USD_EGP),
        total_pi: Number(amountPi),

        delivery_fee_pi: deliveryFeePi ? Number(deliveryFeePi.toFixed(6)) : 0,
        platform_fee_pi: platformFeePi ? Number(platformFeePi.toFixed(6)) : 0
      }
    }]).select();

    if (error) throw error;

    ACTIVE_ORDER = data?.[0]?.id;

    document.getElementById('custTrack').classList.remove('hidden');
    document.getElementById('custChat').classList.remove('hidden');
    document.getElementById('custStatus').innerText = 'pending';
    document.getElementById('otp').innerText = otp;
    document.getElementById('otpBox').classList.remove('hidden');

    Swal.close();

    listenStatus();
    startChat();
    loadCustomerHistory();

  } catch (e) {
    console.error(e);
    Swal.fire({ icon: 'error', title: 'ÙØ´Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©', text: e?.message || 'Ø­ØµÙ„ Ø®Ø·Ø£' });
  }
}

/* ================== DELIVERY: LOAD + ACCEPT (RPC Lock) ================== */
async function loadOrders(){
  try{
    const box = document.getElementById('ordersBox');
    box.innerHTML = `<div class="glass p-4 text-center muted">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>`;

    const { data, error } = await db.from('orders')
      .select('id,product_name,order_type,notes,price,delivery_fee,platform_fee,total_price,status,created_at,pricing_snapshot')
      .eq('status','pending')
      .order('created_at',{ascending:false});

    if (error) throw error;

    if (!data?.length) {
      box.innerHTML = `<div class="glass p-4 text-center muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</div>`;
      return;
    }

    box.innerHTML = data.map(o => {
      const delFee = (o.delivery_fee ?? DELIVERY_FEE_EGP);
      const platFee = (o.platform_fee ?? PLATFORM_FEE_EGP);
      const totalEgp = (o.total_price ?? ((o.price||0)+delFee+platFee));
      const totalPi = egpToPi(totalEgp);

      return `
      <div class="glass p-4 space-y-2">
        <div class="row">
          <div>
            <b class="text-base">${escapeHtml(o.product_name)}</b>
            <div class="tiny">${new Date(o.created_at).toLocaleString('ar-EG')}</div>
            <div class="tiny">Ù†ÙˆØ¹: <b>${escapeHtml(o.order_type || 'any')}</b></div>
          </div>
          <div class="text-sm font-extrabold text-emerald-300">${Number(totalEgp).toFixed(2)} Ø¬</div>
        </div>

        <div class="soft p-3 text-sm space-y-1">
          <div class="row"><span class="muted">Ø³Ø¹Ø± Ø§Ù„Ù…Ù†ØªØ¬</span><b>${Number(o.price||0).toFixed(2)} Ø¬</b></div>
          <div class="row"><span class="muted">ØªÙˆØµÙŠÙ„</span><b>${Number(delFee).toFixed(2)} Ø¬</b></div>
          <div class="row"><span class="muted">Ø±Ø³ÙˆÙ… Ù…ÙˆÙ‚Ø¹</span><b>${Number(platFee).toFixed(2)} Ø¬</b></div>
          <div class="border-t border-white/10 pt-2 row"><span class="font-extrabold">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span><b class="text-emerald-300">${Number(totalEgp).toFixed(2)} Ø¬</b></div>
          <div class="row"><span class="muted">ÙŠØ¹Ø§Ø¯Ù„ Ø¨Ù€ Pi</span><b class="mono text-purple-300">${totalPi ? totalPi.toFixed(6) : 'â€”'} Pi</b></div>
        </div>

        <button onclick="acceptOrder('${o.id}')" class="btn btnG w-full">Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨</button>
      </div>
      `;
    }).join('');

  }catch(e){
    console.error(e);
    document.getElementById('ordersBox').innerHTML =
      `<div class="glass p-4 text-center" style="color:#fca5a5">Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª: ${escapeHtml(e?.message||'')}</div>`;
  }
}

async function acceptOrder(id){
  try{
    if(!PI_USERNAME) return Swal.fire('Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„ ÙƒØ§Ø¨ØªÙ† Ø§Ù„Ø£ÙˆÙ„');

    Swal.fire({ title:'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù‚Ø¨ÙˆÙ„...', didOpen:()=>Swal.showLoading(), allowOutsideClick:false });

    const { error } = await db.rpc('accept_order_once', {
      p_order_id: id,
      p_delivery_id: PI_USERNAME
    });

    if (error) throw error;

    ACTIVE_ORDER = id;
    await loadOrderDetailsForDelivery(id);

    document.getElementById('delChat').classList.remove('hidden');
    Swal.close();

    startChat();
    markSeen('delivery');
    loadDeliveryHistory();

  }catch(e){
    console.error(e);
    Swal.fire({ icon:'error', title:'ÙØ´Ù„ Ø§Ù„Ù‚Ø¨ÙˆÙ„', text: e?.message || 'Ø­ØµÙ„ Ø®Ø·Ø£' });
  }
}

async function loadOrderDetailsForDelivery(orderId){
  const { data, error } = await db.from('orders')
    .select('product_name,order_type,notes,price,delivery_fee,platform_fee,total_price')
    .eq('id', orderId)
    .single();

  if(error){ console.warn(error); return; }

  const delFee = (data.delivery_fee ?? DELIVERY_FEE_EGP);
  const platFee = (data.platform_fee ?? PLATFORM_FEE_EGP);
  const totalEgp = (data.total_price ?? ((data.price||0)+delFee+platFee));
  const totalPi = egpToPi(totalEgp);

  document.getElementById('dProd').innerText = data.product_name || 'â€”';
  document.getElementById('dType').innerText = data.order_type || 'any';
  document.getElementById('dProdEgp').innerText = Number(data.price||0).toFixed(2);
  document.getElementById('dDelFeeEgp').innerText = Number(delFee).toFixed(2);
  document.getElementById('dPlatFeeEgp').innerText = Number(platFee).toFixed(2);
  document.getElementById('dTotalEgp').innerText = Number(totalEgp).toFixed(2);
  document.getElementById('dTotalPi').innerText = totalPi ? totalPi.toFixed(6) : 'â€”';
  document.getElementById('dNotes').innerText = data.notes ? data.notes : 'â€”';
}

/* ================== CHAT: text + image + seen ================== */
let chatChannel = null;

function startChat(){
  if(!ACTIVE_ORDER) return;

  if (chatChannel) {
    try { db.removeChannel(chatChannel); } catch {}
    chatChannel = null;
  }

  loadMessages();

  chatChannel = db.channel('chat-room-' + ACTIVE_ORDER)
    .on('postgres_changes', {
      event: 'INSERT', schema: 'public', table: 'chat_messages',
      filter: `order_id=eq.${ACTIVE_ORDER}`
    }, (payload) => {
      appendMsg(payload.new);
      markSeen(currentRole());
    })
    .subscribe();
}

async function loadMessages(){
  const { data, error } = await db.from('chat_messages')
    .select('*')
    .eq('order_id', ACTIVE_ORDER)
    .order('created_at', { ascending: true });

  if(error){ console.error(error); return; }

  document.getElementById('chatC').innerHTML = '';
  document.getElementById('chatD').innerHTML = '';
  (data||[]).forEach(appendMsg);

  markSeen(currentRole());
}

function currentRole(){
  return (!document.getElementById('delivery').classList.contains('hidden')) ? 'delivery' : 'customer';
}

async function uploadChatImage(file){
  // Bucket: chat
  const path = `chat/${ACTIVE_ORDER}/${Date.now()}_${file.name}`;
  const up = await db.storage.from('chat').upload(path, file, { upsert: false });
  if (up.error) throw up.error;
  return db.storage.from('chat').getPublicUrl(path).data.publicUrl;
}

async function sendMsg(sender){
  try{
    if(!ACTIVE_ORDER) return Swal.fire('Ù…ÙÙŠØ´ Ø·Ù„Ø¨ Ù†Ø´Ø·');

    const input = sender === 'customer' ? document.getElementById('msgC') : document.getElementById('msgD');
    const fileEl = sender === 'customer' ? document.getElementById('imgC') : document.getElementById('imgD');

    const text = (input.value || '').trim();
    const file = fileEl.files?.[0];

    if(!text && !file) return;

    let image_url = null;
    if(file){
      try{
        image_url = await uploadChatImage(file);
      }catch(e){
        console.warn("Image upload failed:", e);
        image_url = null; // fallback Ø¨Ø¯ÙˆÙ† ÙØ´Ù„
      }
    }

    const { error } = await db.from('chat_messages').insert([{
      order_id: ACTIVE_ORDER,
      sender,
      message_text: text || null,
      image_url,
      seen_at: null
    }]);
    if(error) throw error;

    input.value = '';
    fileEl.value = '';

  }catch(e){
    console.error(e);
    Swal.fire({ icon:'error', title:'ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©', text: e?.message || 'Ø­ØµÙ„ Ø®Ø·Ø£' });
  }
}

function quick(role, txt){
  if(role==='customer') document.getElementById('msgC').value = txt;
  else document.getElementById('msgD').value = txt;
}

function appendMsg(m){
  const bubble = `
    <div class="msg ${m.sender==='customer'?'c':'d'}">
      ${m.message_text ? escapeHtml(m.message_text) : ''}
      ${m.image_url ? `<img src="${m.image_url}" class="mt-2 rounded-xl border border-white/10" />` : ''}
      <div class="mt-1 tiny">${m.seen_at ? 'âœ…âœ…' : 'âœ…'}</div>
    </div>
  `;
  document.getElementById('chatC').insertAdjacentHTML('beforeend', bubble);
  document.getElementById('chatD').insertAdjacentHTML('beforeend', bubble);

  document.getElementById('chatC').scrollTop = document.getElementById('chatC').scrollHeight;
  document.getElementById('chatD').scrollTop = document.getElementById('chatD').scrollHeight;
}

async function markSeen(viewerRole){
  try{
    if(!ACTIVE_ORDER) return;
    await db.from('chat_messages')
      .update({ seen_at: new Date().toISOString() })
      .eq('order_id', ACTIVE_ORDER)
      .neq('sender', viewerRole)
      .is('seen_at', null);
  }catch(e){
    console.warn('markSeen failed:', e);
  }
}

/* ================== STATUS ================== */
let statusChannel = null;

function listenStatus(){
  if(!ACTIVE_ORDER) return;

  if (statusChannel) {
    try { db.removeChannel(statusChannel); } catch {}
    statusChannel = null;
  }

  statusChannel = db.channel('order-status-' + ACTIVE_ORDER)
    .on('postgres_changes', {
      event: 'UPDATE', schema:'public', table:'orders',
      filter: `id=eq.${ACTIVE_ORDER}`
    }, (payload) => {
      const s = payload.new.status;
      document.getElementById('custStatus').innerText = s;

      if(['accepted','shipping','arrived','delivered'].includes(s)){
        document.getElementById('custChat').classList.remove('hidden');
      }

      if(s === 'delivered'){
        Swal.fire({ icon:'success', title:'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ… âœ…', text:'Ø´ÙƒØ±Ø§Ù‹ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø·Ù„Ø¨Ø§Øª Ø¨Ø±Ùˆ' });
        loadCustomerHistory();
      }
    }).subscribe();
}

/* ================== DELIVERY STATUS + OTP ================== */
async function setOrderStatus(st){
  if(!ACTIVE_ORDER) return Swal.fire('Ø§Ø®ØªØ± Ø·Ù„Ø¨ Ø£ÙˆÙ„Ø§Ù‹');
  await db.from('orders').update({ status: st }).eq('id', ACTIVE_ORDER);
}

async function finishWithOtp(){
  try{
    if(!ACTIVE_ORDER) return;
    if(!PI_USERNAME) return Swal.fire('Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„');

    const { value: code } = await Swal.fire({
      title: 'ÙƒÙˆØ¯ Ø§Ù„ØªØ³Ù„ÙŠÙ…',
      input: 'text',
      inputPlaceholder: 'Ø§ÙƒØªØ¨ ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„',
      showCancelButton: true,
      confirmButtonText: 'ØªØ£ÙƒÙŠØ¯',
      cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
    });
    if(!code) return;

    const { error } = await db.rpc('complete_delivery', {
      p_order_id: ACTIVE_ORDER,
      p_otp: String(code).trim(),
      p_delivery_id: PI_USERNAME
    });

    if(error) throw error;

    Swal.fire({ icon:'success', title:'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ… âœ…' });
    await loadWalletPi();
    await loadDeliveryHistory();

  }catch(e){
    console.error(e);
    Swal.fire({ icon:'error', title:'ÙØ´Ù„ Ø§Ù„ØªØ³Ù„ÙŠÙ…', text: e?.message || 'OTP ØºÙ„Ø· Ø£Ùˆ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­' });
  }
}

/* ================== WALLET (Pi) ================== */
/**
 * âœ… Ù†Ø­Ø§ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† Ø¬Ø¯ÙˆÙ„ delivery_wallet.balance_pi
 * âœ… Ù„Ùˆ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯/Ø£Ùˆ ØµÙ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ â†’ fallback: Ù†Ø¬Ù…Ø¹ Ø£Ø±Ø¨Ø§Ø­Ùƒ Ù…Ù† Ø§Ù„Ø·Ù„Ø¨Ø§Øª delivered (delivery_fee_pi)
 */
async function loadWalletPi(){
  try{
    if(!PI_USERNAME) return;

    // 1) Ø­Ø§ÙˆÙ„ Ù…Ù† delivery_wallet
    try{
      const { data, error } = await db.from('delivery_wallet')
        .select('balance_pi')
        .eq('delivery_id', PI_USERNAME)
        .maybeSingle();

      if(!error && data && typeof data.balance_pi !== 'undefined'){
        document.getElementById('walletPi').innerText = Number(data.balance_pi || 0).toFixed(6);
        return;
      }
    }catch(e){
      // ØªØ¬Ø§Ù‡Ù„ ÙˆÙƒÙ…Ù‘Ù„ fallback
    }

    // 2) fallback Ù…Ù† orders delivered
    const { data: orders, error: e2 } = await db.from('orders')
      .select('pricing_snapshot,status,delivery_id')
      .eq('delivery_id', PI_USERNAME)
      .eq('status', 'delivered')
      .limit(500);

    if(e2) throw e2;

    let sum = 0;
    (orders||[]).forEach(o=>{
      const pi = Number(o?.pricing_snapshot?.delivery_fee_pi || 0);
      if(!isNaN(pi)) sum += pi;
    });

    document.getElementById('walletPi').innerText = sum.toFixed(6);

  }catch(e){
    console.warn(e);
    document.getElementById('walletPi').innerText = '0.000000';
  }
}

/* ================== WITHDRAW ================== */
async function withdrawPi() {
  try {
    if (!PI_USERNAME) return Swal.fire('Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„');

    const amount = parseFloat(document.getElementById('wdAmountPi').value || "0");
    const wallet = (document.getElementById('wdWallet').value || '').trim();

    if (!amount || amount <= 0) return Swal.fire('Ø§ÙƒØªØ¨ ÙƒÙ…ÙŠØ© Pi ØµØ­ÙŠØ­Ø©');
    if (!wallet || wallet.length < 10) return Swal.fire('Ø§ÙƒØªØ¨ Ø¹Ù†ÙˆØ§Ù† Ù…Ø­ÙØ¸Ø© Pi ØµØ­ÙŠØ­');

    // Ø±ØµÙŠØ¯ (Ù…Ù† walletPi Ø§Ù„Ø¸Ø§Ù‡Ø±)
    const available = parseFloat(document.getElementById('walletPi').innerText || "0") || 0;
    if (amount > available) return Swal.fire('Ø§Ù„Ù…Ø¨Ù„Øº Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø­');

    const { error } = await db.from('withdraw_requests').insert([{
      delivery_id: PI_USERNAME,
      amount_pi: amount,
      wallet_address: wallet,
      status: 'pending'
    }]);
    if (error) throw error;

    Swal.fire({ icon: 'success', title: 'ØªÙ…', text: 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©' });

    document.getElementById('wdAmountPi').value = '';
    document.getElementById('wdWallet').value = '';

    loadWithdrawHistory();

  } catch (e) {
    console.error(e);
    Swal.fire({ icon: 'error', title: 'ÙØ´Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨', text: e?.message || 'Ø­ØµÙ„ Ø®Ø·Ø£' });
  }
}

async function loadWithdrawHistory(){
  try{
    if(!PI_USERNAME) return;
    const box = document.getElementById('wdHistory');
    box.innerHTML = `<div class="tiny">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>`;

    const { data, error } = await db.from('withdraw_requests')
      .select('id,amount_pi,wallet_address,status,created_at,note')
      .eq('delivery_id', PI_USERNAME)
      .order('created_at', { ascending:false })
      .limit(50);

    if(error) throw error;

    if(!data?.length){
      box.innerHTML = `<div class="tiny">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø³Ø­Ø¨.</div>`;
      return;
    }

    box.innerHTML = data.map(w => `
      <div class="soft p-3">
        <div class="row">
          <b class="mono text-purple-300">${Number(w.amount_pi||0).toFixed(6)} Pi</b>
          <span class="chip">${escapeHtml(w.status)}</span>
        </div>
        <div class="tiny mt-1">${new Date(w.created_at).toLocaleString('ar-EG')}</div>
        <div class="tiny mt-1">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: <span class="mono">${escapeHtml(w.wallet_address||'-')}</span></div>
        ${w.note ? `<div class="tiny mt-1">Ù…Ù„Ø§Ø­Ø¸Ø©: ${escapeHtml(w.note)}</div>` : ``}
      </div>
    `).join('');

  }catch(e){
    console.error(e);
    document.getElementById('wdHistory').innerHTML = `<div class="tiny" style="color:#fca5a5">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø³Ø­Ø¨</div>`;
  }
}

/* ================== HISTORY: CUSTOMER + DELIVERY ================== */
async function loadCustomerHistory(){
  try{
    if(!PI_USERNAME) return;
    const box = document.getElementById('custHistory');
    box.innerHTML = `<div class="tiny">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>`;

    const { data, error } = await db.from('orders')
      .select('id,product_name,order_type,total_price,status,created_at,pricing_snapshot,delivery_id')
      .eq('customer_pi_username', PI_USERNAME)
      .order('created_at', { ascending:false })
      .limit(50);

    if(error) throw error;

    if(!data?.length){
      box.innerHTML = `<div class="tiny">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¨Ø¹Ø¯.</div>`;
      return;
    }

    box.innerHTML = data.map(o => {
      const totalEgp = Number(o.total_price||0);
      const totalPi = Number(o?.pricing_snapshot?.total_pi || (egpToPi(totalEgp) || 0));
      const s = o.status || 'pending';

      const color =
        s==='delivered' ? 'text-emerald-300' :
        s==='canceled' ? 'text-red-300' :
        'text-orange-200';

      return `
        <div class="soft p-3">
          <div class="row">
            <b>${escapeHtml(o.product_name)}</b>
            <span class="chip ${color}">${escapeHtml(s)}</span>
          </div>
          <div class="tiny mt-1">Ù†ÙˆØ¹: <b>${escapeHtml(o.order_type||'any')}</b>${o.delivery_id ? ` | ÙƒØ§Ø¨ØªÙ†: <b>${escapeHtml(o.delivery_id)}</b>` : ``}</div>
          <div class="row mt-1">
            <span class="tiny">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
            <b class="text-emerald-300">${totalEgp.toFixed(2)} Ø¬</b>
          </div>
          <div class="row mt-1">
            <span class="tiny">Ø¨Ø§Ù„Ù€ Pi</span>
            <b class="mono text-purple-300">${Number(totalPi||0).toFixed(6)} Pi</b>
          </div>
          <div class="tiny mt-1">${new Date(o.created_at).toLocaleString('ar-EG')}</div>
        </div>
      `;
    }).join('');

  }catch(e){
    console.error(e);
    document.getElementById('custHistory').innerHTML = `<div class="tiny" style="color:#fca5a5">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>`;
  }
}

async function loadDeliveryHistory(){
  try{
    if(!PI_USERNAME) return;
    const box = document.getElementById('delHistory');
    box.innerHTML = `<div class="tiny">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>`;

    const { data, error } = await db.from('orders')
      .select('id,product_name,order_type,total_price,status,created_at,pricing_snapshot,customer_pi_username')
      .eq('delivery_id', PI_USERNAME)
      .order('created_at', { ascending:false })
      .limit(50);

    if(error) throw error;

    if(!data?.length){
      box.innerHTML = `<div class="tiny">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ø¹Ù„ÙŠÙƒ Ø¨Ø¹Ø¯.</div>`;
      return;
    }

    box.innerHTML = data.map(o => {
      const totalEgp = Number(o.total_price||0);
      const totalPi = Number(o?.pricing_snapshot?.total_pi || (egpToPi(totalEgp) || 0));
      const profitPi = Number(o?.pricing_snapshot?.delivery_fee_pi || 0);
      const s = o.status || 'pending';

      return `
        <div class="soft p-3">
          <div class="row">
            <b>${escapeHtml(o.product_name)}</b>
            <span class="chip">${escapeHtml(s)}</span>
          </div>
          <div class="tiny mt-1">Ø¹Ù…ÙŠÙ„: <b>${escapeHtml(o.customer_pi_username||'â€”')}</b></div>
          <div class="row mt-1">
            <span class="tiny">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
            <b class="text-emerald-300">${totalEgp.toFixed(2)} Ø¬</b>
          </div>
          <div class="row mt-1">
            <span class="tiny">Ø¨Ø§Ù„Ù€ Pi</span>
            <b class="mono text-purple-300">${Number(totalPi||0).toFixed(6)} Pi</b>
          </div>
          <div class="row mt-1">
            <span class="tiny">Ø±Ø¨Ø­Ùƒ</span>
            <b class="mono text-purple-300">${profitPi.toFixed(6)} Pi</b>
          </div>
          <div class="tiny mt-1">${new Date(o.created_at).toLocaleString('ar-EG')}</div>
        </div>
      `;
    }).join('');

  }catch(e){
    console.error(e);
    document.getElementById('delHistory').innerHTML = `<div class="tiny" style="color:#fca5a5">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø¯Ù„ÙŠÙØ±ÙŠ</div>`;
  }
}

/* ================== UI ================== */
function showTab(t){
  // tabs style
  document.getElementById('btnC').classList.remove('btnA');
  document.getElementById('btnD').classList.remove('btnA');
  document.getElementById('btnC').classList.add('btnS');
  document.getElementById('btnD').classList.add('btnS');

  document.getElementById('customer').classList.add('hidden');
  document.getElementById('delivery').classList.add('hidden');

  if(t==='customer'){
    document.getElementById('customer').classList.remove('hidden');
    document.getElementById('btnC').classList.remove('btnS');
    document.getElementById('btnC').classList.add('btnA');
    loadCustomerHistory();
  } else {
    document.getElementById('delivery').classList.remove('hidden');
    document.getElementById('btnD').classList.remove('btnS');
    document.getElementById('btnD').classList.add('btnA');
    loadOrders();
    loadWalletPi();
    loadWithdrawHistory();
    loadDeliveryHistory();
  }
}

/* ================== HELPERS ================== */
function escapeHtml(str){
  return String(str ?? '').replace(/[&<>"']/g, s => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[s]));
}
</script>

</body>
</html>
