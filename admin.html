<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم | الإدارة</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #6c5ce7; --accent: #00b894; --bg: #f0f2f5; --card: #ffffff; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg); color: #2d3436; padding: 20px; }
        
        .admin-wrapper { max-width: 1100px; margin: 0 auto; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        
        /* Stats */
        .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-box { background: var(--card); padding: 25px; border-radius: 20px; text-align: center; box-shadow: 0 10px 20px rgba(0,0,0,0.05); border-bottom: 4px solid var(--primary); }
        .stat-box i { font-size: 2rem; color: var(--primary); margin-bottom: 10px; }
        .stat-box h3 { font-size: 1.8rem; }

        /* Forms & Cards */
        .main-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px; }
        .card { background: var(--card); padding: 25px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        h2 { font-size: 1.2rem; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; color: var(--primary); }
        
        input, select, textarea { width: 100%; padding: 14px; margin-top: 8px; margin-bottom: 15px; border: 1px solid #e0e0e0; border-radius: 12px; outline: none; background: #fdfdfd; }
        input:focus { border-color: var(--primary); }
        
        .btn { width: 100%; padding: 15px; border-radius: 15px; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-main { background: var(--primary); color: white; }
        .btn-accent { background: var(--accent); color: white; }
        .btn:hover { opacity: 0.9; transform: translateY(-2px); }

        .list-item { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #eee; font-size: 0.9rem; }
    </style>
</head>
<body>

<div class="admin-wrapper">
    <div class="top-bar">
        <h1>إدارة جمعيتي <span style="color:var(--primary)">PRO</span></h1>
        <button class="btn" style="width:auto; background:white; color:var(--primary)" onclick="location.reload()">
            <i class="fas fa-sync-alt"></i> تحديث البيانات
        </button>
    </div>

    <div class="stats-row">
        <div class="stat-box">
            <i class="fas fa-users-rectangle"></i>
            <p>الجمعيات</p>
            <h3 id="stat-circles">0</h3>
        </div>
        <div class="stat-box">
            <i class="fas fa-coins"></i>
            <p>المبالغ المجموعة</p>
            <h3 id="stat-total">0.00 <small>π</small></h3>
        </div>
        <div class="stat-box">
            <i class="fas fa-hand-holding-dollar"></i>
            <p>المستحقات المعتمدة</p>
            <h3 id="stat-payouts">0</h3>
        </div>
    </div>

    <div class="main-grid">
        <div class="card">
            <h2><i class="fas fa-plus-circle"></i> إضافة جمعية جديدة</h2>
            <input type="text" id="c-title" placeholder="اسم الجمعية">
            <input type="number" id="c-amount" placeholder="مبلغ القسط (π)">
            <input type="number" id="c-slots" placeholder="عدد المشتركين">
            <textarea id="c-desc" rows="3" placeholder="وصف الجمعية..."></textarea>
            <button class="btn btn-main" onclick="createCircle()">
                <i class="fas fa-paper-plane"></i> نشر الجمعية الآن
            </button>
        </div>

        <div class="card">
            <h2><i class="fas fa-award"></i> تحديد الفائز (توزيع π)</h2>
            <label>1. اختر الجمعية</label>
            <select id="sel-circle" onchange="loadParticipants(this.value)">
                <option value="">-- اختر الجمعية --</option>
            </select>
            
            <label>2. اختر الفائز بالدور</label>
            <select id="sel-user">
                <option value="">-- المشتركين سيتظهرون هنا --</option>
            </select>
            
            <label>3. المبلغ المستحق صرفه</label>
            <input type="number" id="p-amount" placeholder="0.00 π">
            
            <button class="btn btn-accent" onclick="approveWinnerPayout()">
                <i class="fas fa-check-double"></i> اعتماد صرف الدور للفائز
            </button>
        </div>
    </div>
</div>

<script>
    const SB_URL = 'https://axjkwrssmofzavaoqutq.supabase.co';
    const SB_KEY = 'sb_publishable_tiuMncgWhf1YRWoD-uYQ3Q_ziI8OKci';
    const _db = supabase.createClient(SB_URL, SB_KEY);

    async function initAdmin() {
        // تحميل الجمعيات في القائمة
        const { data: circles } = await _db.from('circles').select('*');
        const { data: participants } = await _db.from('participants').select('amount');
        const { data: payouts } = await _db.from('payouts').select('id');

        // تحديث الإحصائيات
        document.getElementById('stat-circles').innerText = circles ? circles.length : 0;
        document.getElementById('stat-payouts').innerText = payouts ? payouts.length : 0;
        const total = participants ? participants.reduce((s, p) => s + Number(p.amount), 0) : 0;
        document.getElementById('stat-total').innerText = total.toFixed(2);

        // ملء القائمة المنسدلة
        const selCircle = document.getElementById('sel-circle');
        circles.forEach(c => {
            selCircle.innerHTML += `<option value="${c.id}">${c.title}</option>`;
        });
    }

    async function loadParticipants(circleId) {
        if (!circleId) return;
        const { data } = await _db.from('participants').select('pi_user_id, username').eq('circle_id', circleId);
        const selUser = document.getElementById('sel-user');
        selUser.innerHTML = '<option value="">-- اختر المستخدم --</option>';
        data.forEach(u => {
            selUser.innerHTML += `<option value="${u.pi_user_id}">${u.username}</option>`;
        });
    }

    async function createCircle() {
        const title = document.getElementById('c-title').value;
        const amount = document.getElementById('c-amount').value;
        const slots = document.getElementById('c-slots').value;
        const desc = document.getElementById('c-desc').value;

        if (!title || !amount) return alert("أكمل البيانات!");

        await _db.from('circles').insert([{ title, installment_amount: amount, total_slots: slots, description: desc }]);
        alert("تم إنشاء الجمعية بنجاح!");
        location.reload();
    }

    async function approveWinnerPayout() {
        const cid = document.getElementById('sel-circle').value;
        const uid = document.getElementById('sel-user').value;
        const amount = document.getElementById('p-amount').value;
        const name = document.getElementById('sel-user').options[document.getElementById('sel-user').selectedIndex].text;

        if (!uid || !amount) return alert("اختر المستخدم والمبلغ!");

        const { error } = await _db.from('payouts').insert([{
            circle_id: cid,
            pi_user_id: uid,
            username: name,
            amount: amount,
            status: 'approved'
        }]);

        if (!error) {
            alert(`تم اعتماد صرف ${amount} π للمستخدم ${name}`);
            location.reload();
        } else {
            alert("خطأ: " + error.message);
        }
    }

    window.onload = initAdmin;
</script>
</body>
</html>
