<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة الصور | Donate Way</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #8e44ad; --bg: #f8f9fa; }
        body { font-family: 'Tajawal', sans-serif; background: var(--bg); padding: 20px; direction: rtl; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); max-width: 600px; margin: 0 auto 20px; }
        input, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; }
        .btn-add { background: var(--primary); color: white; }
        .campaign-item { background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px; display: flex; align-items: center; gap: 15px; border-right: 5px solid var(--primary); }
        .img-preview { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; }
        .actions { display: flex; gap: 5px; }
        .btn-del { background: #e74c3c; color: white; padding: 5px 10px; border-radius: 5px; font-size: 0.8rem; }
        #login-screen { position: fixed; inset: 0; background: var(--primary); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="card" style="width: 300px;">
            <h2 style="text-align:center">دخول الإدارة</h2>
            <input type="email" id="email-input" placeholder="البريد">
            <input type="password" id="pass-input" placeholder="كلمة السر">
            <button class="btn btn-add" onclick="login()">دخول</button>
        </div>
    </div>

    <div id="admin-panel" style="display:none">
        <div class="card">
            <h2>إضافة حملة بالصورة</h2>
            <input type="hidden" id="edit-id">
            <input type="text" id="title" placeholder="عنوان الحملة">
            <textarea id="desc" placeholder="الوصف"></textarea>
            <input type="number" id="target" placeholder="المبلغ المطلوب (Pi)">
            <label>اختر صورة الحملة:</label>
            <input type="file" id="image-file" accept="image/*">
            <button id="save-btn" class="btn btn-add" onclick="handleSave()">نشر الحملة</button>
        </div>

        <div id="list" class="card">
            <h3>الحملات الحالية</h3>
            <div id="campaigns-list"></div>
        </div>
        <button class="btn" style="background:#ccc; margin-top:10px" onclick="logout()">خروج</button>
    </div>

    <script>
        const SUPABASE_URL = 'https://xncapmzlwuisupkjlftb.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_zPECXAiI_bDbeLtRYe3vIw_IEt_p_AS';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function login() {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('pass-input').value;
            const { data, error } = await _supabase.auth.signInWithPassword({ email, password });
            if (error) alert(error.message); else showPanel();
        }

        function showPanel() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'block';
            load();
        }

        async function handleSave() {
            const id = document.getElementById('edit-id').value;
            const title = document.getElementById('title').value;
            const desc = document.getElementById('desc').value;
            const target = document.getElementById('target').value;
            const file = document.getElementById('image-file').files[0];

            let imageUrl = "";

            if (file) {
                const fileExt = file.name.split('.').pop();
                const fileName = `${Math.random()}.${fileExt}`;
                const { data, error } = await _supabase.storage.from('campaign-images').upload(fileName, file);
                if (error) return alert("خطأ في رفع الصورة");
                imageUrl = `${SUPABASE_URL}/storage/v1/object/public/campaign-images/${fileName}`;
            }

            const payload = { title, description: desc, target_amount: parseFloat(target) };
            if (imageUrl) payload.image_url = imageUrl;

            if (id) {
                await _supabase.from('campaigns').update(payload).eq('id', id);
            } else {
                await _supabase.from('campaigns').insert([payload]);
            }
            alert("تم الحفظ");
            location.reload();
        }

        async function load() {
            const { data } = await _supabase.from('campaigns').select('*').order('created_at', {ascending: false});
            const listDiv = document.getElementById('campaigns-list');
            listDiv.innerHTML = data.map(c => `
                <div class="campaign-item">
                    <img src="${c.image_url || 'https://via.placeholder.com/60'}" class="img-preview">
                    <div style="flex:1"><strong>${c.title}</strong></div>
                    <button class="btn-del" onclick="deleteCamp(${c.id})">حذف</button>
                </div>
            `).join('');
        }

        async function deleteCamp(id) {
            if(confirm("حذف؟")) {
                await _supabase.from('campaigns').delete().eq('id', id);
                load();
            }
        }

        async function logout() { await _supabase.auth.signOut(); location.reload(); }

        window.onload = async () => {
            const { data } = await _supabase.auth.getSession();
            if (data.session) showPanel();
        };
    </script>
</body>
</html>
