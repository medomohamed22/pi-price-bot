<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BNPi</title>

<script src="https://sdk.minepi.com/pi-sdk.js"></script>

<style>
:root{
  --primary:#7f5cff;
  --bg:#0b0b14;
  --card:#141428;
  --text:#ffffff;
  --muted:#a0a0c0;
}

*{
  box-sizing:border-box;
  font-family:Inter, Arial, sans-serif;
}

body{
  margin:0;
  min-height:100vh;
  background:
    radial-gradient(circle at top,#1b1045,transparent 60%),
    var(--bg);
  display:flex;
  justify-content:center;
  align-items:center;
  color:var(--text);
}

.app{
  width:100%;
  max-width:460px;
  padding:20px;
}

.header{
  text-align:center;
  margin-bottom:28px;
}

.logo{
  font-size:32px;
  font-weight:700;
  color:var(--primary);
}

.subtitle{
  color:var(--muted);
  margin-top:6px;
}

.card{
  background:linear-gradient(180deg,#181832,#111126);
  border-radius:22px;
  padding:26px;
  box-shadow:0 20px 50px rgba(0,0,0,.6);
}

label{
  display:block;
  margin-top:16px;
  color:var(--muted);
}

input{
  width:100%;
  padding:15px;
  margin-top:8px;
  border-radius:14px;
  border:none;
  background:#0d0d1f;
  color:#fff;
}

button{
  width:100%;
  padding:16px;
  margin-top:18px;
  border:none;
  border-radius:16px;
  font-size:16px;
  font-weight:600;
  cursor:pointer;
}

.login{
  background:#24244a;
}

.pay{
  background:linear-gradient(135deg,#7f5cff,#9a7bff);
}

.status{
  margin-top:18px;
  text-align:center;
  font-size:14px;
  color:var(--muted);
}

.loader{
  display:none;
  text-align:center;
  margin-top:12px;
}

.loader span{
  width:8px;
  height:8px;
  background:var(--primary);
  border-radius:50%;
  display:inline-block;
  margin:0 3px;
  animation:bounce 1.2s infinite ease-in-out;
}

.loader span:nth-child(2){animation-delay:.15s}
.loader span:nth-child(3){animation-delay:.3s}

@keyframes bounce{
  0%,80%,100%{transform:scale(0)}
  40%{transform:scale(1)}
}

.footer{
  text-align:center;
  margin-top:20px;
  font-size:12px;
  color:#666;
}
</style>
</head>

<body>

<div class="app">

  <div class="header">
    <div class="logo">BNPi</div>
    <div class="subtitle">Instant Pi Network Payments</div>
  </div>

  <div class="card">

    <button class="login" onclick="login()">Login with Pi</button>

    <label>Amount (Pi)</label>
    <input id="amount" type="number" min="0.1" step="0.1" value="1">

    <button class="pay" onclick="pay()">Pay with Pi</button>

    <div class="loader" id="loader">
      <span></span><span></span><span></span>
    </div>

    <div id="status" class="status"></div>

  </div>

  <div class="footer">
    Powered by Pi Network
  </div>

</div>

<script>
const Pi = window.Pi;
Pi.init({ version:"2.0" });

function setStatus(msg){
  document.getElementById("status").innerText = msg;
}

function loading(state){
  document.getElementById("loader").style.display = state ? "block" : "none";
}

/* LOGIN */
async function login(){
  try{
    const user = await Pi.authenticate(
      ["username","payments"],
      onIncompletePaymentFound
    );
    setStatus("Welcome, " + user.user.username);
  }catch{
    setStatus("Login cancelled");
  }
}

/* PAY */
async function pay(){
  const amount = document.getElementById("amount").value;
  if(!amount || amount <= 0) return alert("Invalid amount");

  try{
    loading(true);
    setStatus("Waiting for Pi confirmation...");

    await Pi.createPayment({
      amount: amount,
      memo: "BNPi Payment",
      metadata: { orderId: Date.now() },

      /* üîó USING REDIRECT PATHS */
      onReadyForServerApproval: async (paymentId) => {
        await fetch("/api/pi/approve", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ paymentId })
        });
      },

      onReadyForServerCompletion: async (paymentId, txid) => {
        const res = await fetch("/api/pi/complete", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ paymentId, txid })
        });

        const data = await res.json();
        loading(false);

        if(data.completed){
          setStatus("‚úÖ Payment completed successfully");
        }else{
          setStatus("‚ö†Ô∏è Payment not completed");
        }
      },

      onCancel: () => {
        loading(false);
        setStatus("‚ùå Payment cancelled");
      },

      onError: (err) => {
        console.error(err);
        loading(false);
        setStatus("‚ùå Payment error");
      }
    });

  }catch(err){
    console.error(err);
    loading(false);
    setStatus("‚ùå Payment failed");
  }
}

function onIncompletePaymentFound(payment){
  console.log("Incomplete payment:", payment);
}
</script>

</body>
</html>
