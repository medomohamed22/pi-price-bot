<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pi Elite Hub 2026</title>
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --glass: rgba(255, 255, 255, 0.2);
            --glass-border: rgba(255, 255, 255, 0.3);
            --pi-grad: linear-gradient(135deg, #4a148c, #7b1fa2);
            --accent: #00d2ff;
        }

        body {
            margin: 0; padding: 0; min-height: 100vh;
            background: linear-gradient(45deg, #1a0a2e, #311b92, #1a0a2e);
            background-attachment: fixed;
            color: white; font-family: 'Segoe UI', Tahoma, sans-serif;
            padding-bottom: 90px;
        }

        /* Glass Cards */
        .glass {
            background: var(--glass);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        header {
            padding: 20px; text-align: center;
            border-bottom: 1px solid var(--glass-border);
            margin-bottom: 20px; position: sticky; top: 0; z-index: 100;
            background: rgba(26, 10, 46, 0.8);
        }

        .container { padding: 15px; max-width: 600px; margin: auto; }

        /* Login Screen */
        #login-screen {
            position: fixed; inset: 0; z-index: 2000;
            background: #1a0a2e; display: flex; flex-direction: column;
            justify-content: center; align-items: center; text-align: center;
        }

        .pi-btn {
            background: #ffc107; color: #4a148c; border: none;
            padding: 15px 40px; border-radius: 30px; font-weight: bold;
            font-size: 1.2rem; cursor: pointer; transition: 0.3s;
            box-shadow: 0 0 20px rgba(255, 193, 7, 0.4);
        }

        /* Ads Grid */
        .ads-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        
        .ad-card { 
            position: relative; overflow: hidden; transition: 0.4s;
            cursor: pointer; display: flex; flex-direction: column;
        }
        .ad-card:hover { transform: translateY(-5px); }
        .ad-card img { width: 100%; height: 140px; object-fit: cover; border-radius: 20px 20px 0 0; }
        .ad-info { padding: 12px; }
        .ad-price { color: var(--accent); font-weight: 900; }

        /* Forms */
        input, textarea {
            width: 100%; background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border);
            padding: 15px; border-radius: 12px; color: white; margin-bottom: 15px;
        }

        /* Navigation */
        .nav-bar {
            position: fixed; bottom: 20px; left: 20px; right: 20px;
            display: flex; justify-content: space-around; padding: 15px;
        }
        .nav-btn { color: white; text-align: center; border: none; background: none; font-size: 12px; cursor: pointer; opacity: 0.6; }
        .nav-btn.active { opacity: 1; color: var(--accent); }
        .nav-btn i { font-size: 20px; display: block; margin-bottom: 5px; }

        /* Delete Badge */
        .del-badge {
            background: rgba(255, 77, 77, 0.9); border: none; color: white;
            padding: 5px 10px; border-radius: 8px; font-size: 10px; margin-top: 5px; width: 100%;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .view { display: none; animation: fadeIn 0.4s; }
        .view.active { display: block; }
    </style>
</head>
<body>

    <div id="login-screen">
        <i class="fab fa-pi-network" style="font-size: 80px; color: #ffc107; margin-bottom: 20px;"></i>
        <h1>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Pi Elite</h1>
        <p style="margin-bottom: 30px;">ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªØ¯Ø§ÙˆÙ„</p>
        <button class="pi-btn" onclick="loginWithPi()">Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Pi Network</button>
    </div>

    <header class="glass" style="border-radius: 0 0 25px 25px;">
        <h2 id="header-title">ØªØµÙØ­ Ø§Ù„Ù†Ø®Ø¨Ø©</h2>
    </header>

    <div class="container">
        <div id="view-browse" class="view active">
            <input type="text" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø´ÙŠØ¡ Ù…Ù…ÙŠØ²..." onkeyup="search(this.value)">
            <div id="ads-list" class="ads-grid"></div>
        </div>

        <div id="view-post" class="view glass" style="padding: 20px;">
            <form id="postForm">
                <input type="file" id="f-img" accept="image/*" required>
                <input type="text" id="f-title" placeholder="Ù…Ø§Ø°Ø§ ØªØ¨ÙŠØ¹ØŸ" required>
                <textarea id="f-desc" placeholder="ÙˆØµÙ Ù…ÙˆØ¬Ø² ÙˆØ¬Ø°Ø§Ø¨..." required></textarea>
                <input type="number" id="f-price" placeholder="Ø§Ù„Ø³Ø¹Ø± Ø¨Ø¹Ù…Ù„Ø© Pi" step="0.001" required>
                <input type="tel" id="f-phone" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ (Ø¨Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¯ÙˆÙ„ÙŠ)" required>
                <button type="submit" class="pi-btn" style="width: 100%; box-shadow: none;">Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</button>
            </form>
        </div>

        <div id="view-profile" class="view">
            <div class="glass" style="padding: 20px; margin-bottom: 20px; text-align: center;">
                <p>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ØªØµÙ„: <strong id="user-display">---</strong></p>
            </div>
            <h3>Ø¥Ø¹Ù„Ø§Ù†Ø§ØªÙŠ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©</h3>
            <div id="my-ads-list" class="ads-grid"></div>
        </div>

        <div id="view-details" class="view glass" style="padding: 20px;">
            <div id="details-box"></div>
        </div>
    </div>

    <nav class="nav-bar glass">
        <button class="nav-btn active" onclick="show('browse', this)"><i class="fas fa-gem"></i>Ø§Ù„Ø³ÙˆÙ‚</button>
        <button class="nav-btn" onclick="show('post', this)"><i class="fas fa-plus-circle"></i>Ø¥Ø¶Ø§ÙØ©</button>
        <button class="nav-btn" onclick="show('profile', this)"><i class="fas fa-user-astronaut"></i>Ø­Ø³Ø§Ø¨ÙŠ</button>
    </nav>

    <script>
        const _URL = 'https://axjkwrssmofzavaoqutq.supabase.co';
        const _KEY = 'sb_publishable_tiuMncgWhf1YRWoD-uYQ3Q_ziI8OKci';
        const sb = supabase.createClient(_URL, _KEY);
        let currentUser = null;

        // 1. Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„
        async function loginWithPi() {
            try {
                const Pi = window.Pi;
                Pi.init({ version: "2.0" });
                const auth = await Pi.authenticate(['username'], (p) => {});
                currentUser = auth.user;
                document.getElementById('user-display').innerText = currentUser.username;
                document.getElementById('login-screen').style.display = 'none';
                loadAds();
            } catch (err) { alert("ÙŠØ±Ø¬Ù‰ Ø§Ù„ÙØªØ­ Ù…Ù† Ù…ØªØµÙØ­ Ø¨Ø§ÙŠ Ø§Ù„Ø±Ø³Ù…ÙŠ"); }
        }

        // 2. Ø§Ù„ØªÙ†Ù‚Ù„
        function show(view, btn) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById('view-' + view).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
            if(view === 'profile') loadMyAds();
        }

        // 3. Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (Ø¬Ù„Ø¨ØŒ Ø­Ø°ÙØŒ Ø¥Ø¶Ø§ÙØ©)
        async function loadAds() {
            const { data } = await sb.from('ads').select('*').order('created_at', {ascending: false});
            render(data, 'ads-list', false);
        }

        async function loadMyAds() {
            const { data } = await sb.from('ads').select('*').eq('seller_username', currentUser.username);
            render(data, 'my-ads-list', true);
        }

        function render(data, container, isOwner) {
            const list = document.getElementById(container);
            list.innerHTML = data.map(ad => `
                <div class="ad-card glass">
                    <img src="${_URL}/storage/v1/object/public/ads-images/${ad.image_url}" onclick="showDetail('${ad.id}')">
                    <div class="ad-info">
                        <div style="font-size:14px; font-weight:bold; margin-bottom:5px;">${ad.title}</div>
                        <div class="ad-price">${ad.price} Ï€</div>
                        ${isOwner ? `<button class="del-badge" onclick="handleDelete('${ad.id}', '${ad.image_url}')"><i class="fas fa-trash"></i> Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ</button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        async function handleDelete(id, path) {
            if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) return;
            
            // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø­Ø°Ù Ù…Ù‡Ù…: Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø§Ù„ØµÙˆØ±Ø©
            const { error: dataError } = await sb.from('ads').delete().match({ id: id });
            
            if(!dataError) {
                await sb.storage.from('ads-images').remove([path]);
                alert("ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­");
                loadMyAds();
                loadAds();
            } else {
                alert("ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù: " + dataError.message);
            }
        }

        document.getElementById('postForm').onsubmit = async (e) => {
            e.preventDefault();
            const file = document.getElementById('f-img').files[0];
            const path = `img_${Date.now()}.png`;

            const { error: upErr } = await sb.storage.from('ads-images').upload(path, file);
            if(upErr) return alert("Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©");

            await sb.from('ads').insert([{
                title: document.getElementById('f-title').value,
                description: document.getElementById('f-desc').value,
                price: document.getElementById('f-price').value,
                phone: document.getElementById('f-phone').value,
                image_url: path,
                seller_username: currentUser.username
            }]);

            alert("ØªÙ… Ø§Ù„Ù†Ø´Ø± Ø¨Ù†Ø¬Ø§Ø­!");
            document.getElementById('postForm').reset();
            show('browse');
            loadAds();
        }

        function showDetail(id) {
            // Ù…Ù†Ø·Ù‚ Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ù€ Details
        }
    </script>
</body>
</html>
