<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donate Way</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;700&display=swap" rel="stylesheet">
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root { --primary-purple: #8e44ad; --success: #2ecc71; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Tajawal', sans-serif; }
        body { background: #f0f2f5; padding-top: 100px; }
        header { position: fixed; top: 0; left: 0; right: 0; height: 70px; display: flex; justify-content: space-between; align-items: center; padding: 0 5%; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 9999; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .card { background: white; border-radius: 25px; padding: 20px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .donate-btn { width: 100%; padding: 15px; border-radius: 15px; border: none; background: var(--primary-purple); color: white; font-weight: 700; cursor: pointer; }
        .donate-btn:disabled { background: #ccc; }
        #custom-alert { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 12px 25px; border-radius: 50px; display: none; z-index: 10001; }
        .loader { display: none; border: 3px solid #f3f3f3; border-top: 3px solid var(--primary-purple); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 10px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="custom-alert"></div>

    <header>
        <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary-purple);">Donate Way</div>
        <div id="user-info">
            <button id="login-btn" onclick="login()" style="background:var(--primary-purple); color:white; border:none; padding:8px 20px; border-radius:50px; cursor:pointer;">دخول</button>
            <span id="username-display" style="display:none; font-weight:bold; color:var(--primary-purple);"></span>
        </div>
    </header>

    <div class="container">
        <div id="main-loader" class="loader"></div>
        <div id="campaigns-list"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://xncapmzlwuisupkjlftb.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_zPECXAiI_bDbeLtRYe3vIw_IEt_p_AS';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const Pi = window.Pi;

        let currentUser = null;
        let isProcessing = false;

        // --- الحل الجذري: وظيفة معالجة المعاملات العالقة ---
        const onIncompletePaymentFound = async (payment) => {
            console.log("Incomplete payment found:", payment);
            showMsg("جاري تنظيف معاملة معلقة سابقة...");
            
            // نرسل المعاملة العالقة للسيرفر فوراً ليغلقها
            try {
                await fetch('https://YOUR_BACKEND_SERVER.com/pi-callback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'complete', 
                        paymentId: payment.identifier, 
                        txid: payment.transaction.txid 
                    })
                });
                showMsg("تم حل التعليق! حاول التبرع الآن.");
            } catch (e) {
                console.error("Failed to fix:", e);
            }
        };

        function showMsg(m) {
            const a = document.getElementById('custom-alert');
            a.innerText = m; a.style.display = 'block';
            setTimeout(() => a.style.display = 'none', 5000);
        }

        async function login() {
            try {
                // نمرر onIncompletePaymentFound هنا ليتم فحص التعليق فور الدخول
                const auth = await Pi.authenticate(['username', 'payments'], onIncompletePaymentFound);
                currentUser = auth.user;
                document.getElementById('login-btn').style.display = 'none';
                const nameDisplay = document.getElementById('username-display');
                nameDisplay.innerText = "@" + currentUser.username;
                nameDisplay.style.display = 'block';
                loadCamps();
            } catch (e) {
                showMsg("الرجاء استخدام متصفح Pi");
            }
        }

        async function loadCamps() {
            const { data } = await _supabase.from('campaigns').select('*');
            if (data) {
                document.getElementById('campaigns-list').innerHTML = data.map(c => `
                    <div class="card">
                        <h3>${c.title}</h3>
                        <p>${c.target_amount} π</p>
                        <input type="number" id="amt-${c.id}" placeholder="المبلغ" style="width:80%; padding:10px; margin:10px; border-radius:10px; border:1px solid #ddd;">
                        <button id="btn-${c.id}" class="donate-btn" onclick="handleDonate(${c.id}, '${c.title}')">تبرع</button>
                    </div>
                `).join('');
            }
        }

        async function handleDonate(id, title) {
            if (isProcessing) return;
            if (!currentUser) return login();

            const amount = parseFloat(document.getElementById(`amt-${id}`).value);
            if (!amount || amount <= 0) return showMsg("أدخل مبلغ صحيح");

            isProcessing = true;
            const btn = document.getElementById(`btn-${id}`);
            btn.disabled = true;
            btn.innerText = "جاري الاتصال بالمحفظة...";

            Pi.createPayment({
                amount: amount,
                memo: "تبرع لـ " + title,
                metadata: { campaignId: id }
            }, {
                onReadyForServerApproval: (paymentId) => {
                    // أخبر سيرفرك أن يوافق (Approve)
                    return fetch('https://YOUR_BACKEND_SERVER.com/pi-callback', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'approve', paymentId })
                    }).then(res => res.json());
                },
                onReadyForServerCompletion: (paymentId, txid) => {
                    // أخبر سيرفرك أن يكمل (Complete)
                    return fetch('https://YOUR_BACKEND_SERVER.com/pi-callback', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'complete', paymentId, txid })
                    }).then(async () => {
                        // الآن فقط نسجل في Supabase
                        await _supabase.from('donations').insert([{
                            username: currentUser.username,
                            amount: amount,
                            campaign_id: id
                        }]);
                        showMsg("تم التبرع بنجاح!");
                        reset(btn);
                        loadCamps();
                    });
                },
                onCancel: () => reset(btn),
                onError: (error) => {
                    console.error(e);
                    if (error.message.includes("pending")) {
                        showMsg("لديك دفع معلق.. أعد تحميل التطبيق وسيتم حله تلقائياً");
                    } else {
                        showMsg("حدث خطأ في الدفع");
                    }
                    reset(btn);
                }
            });
        }

        function reset(btn) {
            isProcessing = false;
            btn.disabled = false;
            btn.innerText = "تبرع";
        }

        window.onload = () => { 
            Pi.init({ version: "2.0" }); 
            loadCamps();
        };
    </script>
</body>
</html>
