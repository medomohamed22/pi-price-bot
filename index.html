<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Pi Elite Hub | 2026</title>

  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <style>
    :root {
      --bg: #030712;
      --card: rgba(17, 24, 39, 0.7);
      --stroke: rgba(255, 255, 255, 0.08);
      --primary: #8b5cf6;
      --primary-dark: #6d28d9;
      --accent: #22d3ee;
      --gold: #f59e0b;
      --text: #f9fafb;
      --muted: #9ca3af;
      --r-lg: 24px;
      --r-md: 16px;
      --nav-h: 70px;
      --safe: env(safe-area-inset-bottom);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
    
    body {
      margin: 0; color: var(--text); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: radial-gradient(circle at top left, #1e1b4b, #030712);
      min-height: 100vh; overflow-x: hidden;
    }

    /* Glass Effect */
    .glass { background: var(--card); border: 1px solid var(--stroke); backdrop-filter: blur(20px); border-radius: var(--r-md); }

    /* Layout */
    .app-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 15px 20px; position: sticky; top: 0; z-index: 1000;
      border-bottom: 1px solid var(--stroke); background: rgba(3, 7, 18, 0.8);
    }

    .page { display: none; padding: 20px 16px calc(var(--nav-h) + 40px + var(--safe)); max-width: 600px; margin: 0 auto; animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
    .page.active { display: block; }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    /* Ads Grid */
    .ads-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 14px; }
    .ad-card { position: relative; border-radius: var(--r-md); overflow: hidden; transition: transform 0.2s; background: var(--card); border: 1px solid var(--stroke); }
    .ad-card:active { transform: scale(0.96); }
    
    .featured-ring { border: 2px solid var(--gold); box-shadow: 0 0 20px rgba(245, 158, 11, 0.15); }
    .badge-gold {
      position: absolute; top: 10px; right: 10px; background: var(--gold);
      color: #000; padding: 4px 10px; border-radius: 8px; font-size: 10px; font-weight: 800; z-index: 10;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }

    .ad-image { width: 100%; height: 160px; object-fit: cover; }
    .ad-content { padding: 12px; }
    .ad-price { font-size: 18px; font-weight: 800; color: var(--accent); margin-bottom: 4px; }
    .ad-title { font-size: 14px; color: var(--text); opacity: 0.9; height: 38px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }

    /* Buttons */
    .btn {
      display: flex; align-items: center; justify-content: center; gap: 8px;
      padding: 12px 20px; border: none; border-radius: 14px; cursor: pointer;
      font-weight: 700; transition: all 0.2s; font-size: 14px; width: 100%;
    }
    .btn-primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; }
    .btn-gold { background: var(--gold); color: #000; margin-top: 10px; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* Bottom Navigation */
    .nav-bar {
      position: fixed; bottom: 0; left: 0; right: 0; height: calc(var(--nav-h) + var(--safe));
      background: rgba(17, 24, 39, 0.95); border-top: 1px solid var(--stroke);
      display: flex; align-items: center; justify-content: space-around; padding-bottom: var(--safe); z-index: 1000;
    }
    .nav-link { color: var(--muted); background: none; border: none; font-size: 12px; display: flex; flex-direction: column; align-items: center; gap: 4px; flex: 1; transition: 0.3s; }
    .nav-link.active { color: var(--primary); }
    .nav-link i { font-size: 22px; }

    /* Inputs */
    .input-group { margin-bottom: 15px; }
    .input-group label { display: block; margin-bottom: 8px; font-size: 13px; color: var(--muted); }
    input, textarea {
      width: 100%; background: rgba(255,255,255,0.05); border: 1px solid var(--stroke);
      padding: 14px; border-radius: 12px; color: white; font-size: 15px;
    }
    input:focus { border-color: var(--primary); }

    /* Toast */
    #toast {
      position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
      padding: 12px 24px; border-radius: 50px; background: #22c55e; color: white;
      font-weight: 600; font-size: 14px; z-index: 9999; display: none; box-shadow: 0 10px 25px rgba(0,0,0,0.5);
    }
  </style>
</head>
<body>

  <div id="toast"></div>

  <header class="app-header">
    <div style="display: flex; align-items: center; gap: 10px;">
      <div style="width: 35px; height: 35px; background: var(--primary); border-radius: 10px; display: grid; place-items: center;">
        <i class="fas fa-bolt"></i>
      </div>
      <b style="font-size: 18px; letter-spacing: 0.5px;">Elite Hub</b>
    </div>
    <div id="user-area">
      <button class="btn-primary btn" style="padding: 6px 14px; border-radius: 10px;" onclick="initPi()">
        <i class="fas fa-sign-in-alt"></i> Ø¯Ø®ÙˆÙ„
      </button>
    </div>
  </header>

  <main>
    <div id="home" class="page active">
      <div class="ads-grid" id="market-grid"></div>
    </div>

    <div id="add" class="page">
      <div class="glass" style="padding: 24px;">
        <h2 style="margin-top:0">Ø¥Ø¶Ø§ÙØ© Ø¥Ø¹Ù„Ø§Ù†</h2>
        <div class="input-group">
          <label>ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬</label>
          <input type="file" id="file" accept="image/*">
        </div>
        <div class="input-group">
          <input type="text" id="title" placeholder="Ù…Ø§Ø°Ø§ ØªØ¨ÙŠØ¹ØŸ">
        </div>
        <div class="input-group">
          <input type="number" id="price" placeholder="Ø§Ù„Ø³Ø¹Ø± Ø¨Ù€ Pi">
        </div>
        <div class="input-group">
          <textarea id="desc" rows="4" placeholder="ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬ ÙˆØ­Ø§Ù„ØªÙ‡..."></textarea>
        </div>
        <button class="btn btn-primary" id="up-btn" onclick="uploadAd()">
          <i class="fas fa-paper-plane"></i> Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†
        </button>
      </div>
    </div>

    <div id="profile" class="page">
      <div id="my-profile-info" style="margin-bottom: 20px;"></div>
      <h3 style="margin-bottom: 15px;"><i class="fas fa-box-open"></i> Ø¥Ø¹Ù„Ø§Ù†Ø§ØªÙŠ</h3>
      <div class="ads-grid" id="my-ads-grid"></div>
    </div>
  </main>

  <nav class="nav-bar">
    <button class="nav-link active" onclick="nav('home', this)"><i class="fas fa-home"></i><span>Ø§Ù„Ø³ÙˆÙ‚</span></button>
    <button class="nav-link" onclick="nav('add', this)"><i class="fas fa-plus-circle"></i><span>Ù†Ø´Ø±</span></button>
    <button class="nav-link" onclick="nav('profile', this)"><i class="fas fa-user"></i><span>Ø­Ø³Ø§Ø¨ÙŠ</span></button>
  </nav>

  <script>
    let _sb = null;
    let currentUser = null;

    // Boot App
    window.onload = async () => {
      try {
        const res = await fetch('/api/config');
        const config = await res.json();
        _sb = supabase.createClient(config.SB_URL, config.SB_ANON);
        loadAds();
      } catch (err) { showToast("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª", "#ef4444"); }
    };

    // Pi Authentication
    async function initPi() {
      try {
        const Pi = window.Pi;
        Pi.init({ version: "2.0", sandbox: false });
        
        const auth = await Pi.authenticate(['username'], (p) => {});
        currentUser = auth.user;
        
        document.getElementById('user-area').innerHTML = `
          <div style="text-align: right;">
            <div style="font-size: 12px; font-weight: 800;">@${currentUser.username}</div>
            <div style="font-size: 10px; color: var(--accent);">Ù…ØªØ­Ù‚Ù‚ Ù…Ù†Ù‡ âœ…</div>
          </div>
        `;
        showToast("Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ Ù…Ø¬Ø¯Ø¯Ø§Ù‹!");
        if(document.getElementById('profile').classList.contains('active')) loadMyAds();
      } catch (err) { alert("Ø¹Ø°Ø±Ø§Ù‹ØŒ ÙŠØ¬Ø¨ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ØªØµÙØ­ Pi"); }
    }

    // Navigation
    function nav(pageId, el) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
      document.getElementById(pageId).classList.add('active');
      el.classList.add('active');
      
      if(pageId === 'home') loadAds();
      if(pageId === 'profile') {
        if(!currentUser) showToast("Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ø£ÙˆÙ„Ø§Ù‹", "#f59e0b");
        else loadMyAds();
      }
    }

    // Load Ads
    async function loadAds() {
      if(!_sb) return;
      const { data } = await _sb.from('ads').select('*').order('created_at', {ascending: false});
      render(data || [], 'market-grid', false);
    }

    async function loadMyAds() {
      const { data } = await _sb.from('ads').select('*').eq('seller_username', currentUser.username);
      render(data || [], 'my-ads-grid', true);
    }

    function render(data, gridId, isOwner) {
      const grid = document.getElementById(gridId);
      const now = new Date();
      
      const sorted = data.sort((a,b) => {
        const bp = b.promoted_until && new Date(b.promoted_until) > now;
        const ap = a.promoted_until && new Date(a.promoted_until) > now;
        return bp - ap;
      });

      grid.innerHTML = sorted.map(ad => {
        const isPromoted = ad.promoted_until && new Date(ad.promoted_until) > now;
        return `
          <div class="ad-card ${isPromoted ? 'featured-ring' : ''}">
            ${isPromoted ? '<div class="badge-gold"><i class="fas fa-crown"></i> Ù…Ù…ÙŠØ²</div>' : ''}
            <img class="ad-image" src="${_sb.storageUrl}/object/public/ads-images/${ad.image_url}" onerror="this.src='https://via.placeholder.com/300x200?text=Elite+Hub'">
            <div class="ad-content">
              <div class="ad-price">${ad.price} Pi</div>
              <div class="ad-title">${ad.title}</div>
              ${isOwner ? `
                <button class="btn btn-gold" onclick="promoteAd('${ad.id}')">
                  <i class="fas fa-rocket"></i> ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†
                </button>
              ` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    // Upload Ad
    async function uploadAd() {
      if(!currentUser) return showToast("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„", "#f59e0b");
      
      const file = document.getElementById('file').files[0];
      const title = document.getElementById('title').value;
      const price = document.getElementById('price').value;
      const desc = document.getElementById('desc').value;

      if(!file || !title || !price) return showToast("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ ÙƒØ§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", "#f59e0b");

      const btn = document.getElementById('up-btn');
      btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...';

      try {
        const fileName = `${Date.now()}_${currentUser.username}.${file.name.split('.').pop()}`;
        const { error: upErr } = await _sb.storage.from('ads-images').upload(fileName, file);
        if(upErr) throw upErr;

        const { error: dbErr } = await _sb.from('ads').insert([{
          title, price: parseFloat(price), description: desc,
          image_url: fileName, seller_username: currentUser.username
        }]);
        if(dbErr) throw dbErr;

        showToast("âœ… ØªÙ… Ø§Ù„Ù†Ø´Ø± Ø¨Ù†Ø¬Ø§Ø­!");
        nav('home', document.querySelector('.nav-link'));
      } catch (err) { 
        showToast("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø±ÙØ¹", "#ef4444"); 
      } finally {
        btn.disabled = false; btn.innerHTML = '<i class="fas fa-paper-plane"></i> Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†';
      }
    }

    // Promotion / Payments
    async function promoteAd(adId) {
      if(!currentUser) return;
      
      try {
        showToast("Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨...", "#8b5cf6");
        
        await Pi.createPayment({
          amount: 5.0,
          memo: `PROMOTE_AD|${adId}`,
          metadata: { adId: adId, username: currentUser.username },
        }, {
          onReadyForServerApproval: async (paymentId) => {
            const res = await fetch('/api/pi/approve', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({ paymentId })
            });
            const info = await res.json();
            if(!res.ok) throw new Error(info.message || "ÙØ´Ù„ Ø§Ù„ØªØ£ÙƒÙŠØ¯");
            return info;
          },
          onReadyForServerCompletion: async (paymentId, txid) => {
            const res = await fetch('/api/pi/complete', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({ paymentId, txid })
            });
            const info = await res.json();
            if(!res.ok) throw new Error(info.message || "ÙØ´Ù„ Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„");
            showToast("ğŸš€ Ø¥Ø¹Ù„Ø§Ù†Ùƒ Ø§Ù„Ø¢Ù† ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©!");
            loadAds();
            return info;
          },
          onCancel: () => showToast("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¯ÙØ¹", "#6b7280"),
          onError: (err) => alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¯ÙØ¹: " + err.message)
        });
      } catch (err) {
        showToast("ÙØ´Ù„ Ø§Ù„Ø¨Ø¯Ø¡ Ø¨Ø§Ù„Ø¯ÙØ¹", "#ef4444");
      }
    }

    function showToast(msg, bg = "#22c55e") {
      const t = document.getElementById('toast');
      t.textContent = msg; t.style.background = bg;
      t.style.display = 'block';
      setTimeout(() => t.style.display = 'none', 3500);
    }
  </script>
</body>
</html>
