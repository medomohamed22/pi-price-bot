<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pi Second-Hand Hub 2026</title>
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #6d28d9;
            --accent: #00f2fe;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --card-grad: linear-gradient(135deg, rgba(255,255,255,0.2), rgba(255,255,255,0.05));
        }

        body {
            margin: 0; background: #0f172a; color: white;
            font-family: 'Segoe UI', Roboto, sans-serif;
            overflow-x: hidden; -webkit-font-smoothing: antialiased;
        }

        /* Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙØ­Ø§Øª */
        .page-container {
            display: none; min-height: 100vh; padding: 20px 15px 100px;
            animation: pageSlide 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .page-container.active { display: block; }

        @keyframes pageSlide {
            from { transform: translateX(30px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø²Ø¬Ø§Ø¬ÙŠØ© (Glass Cards) */
        .ad-card {
            background: var(--card-grad);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 24px; overflow: hidden;
            margin-bottom: 15px; transition: transform 0.2s;
        }
        .ad-card:active { transform: scale(0.97); }
        .ad-card img { width: 100%; height: 180px; object-fit: cover; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .ad-content { padding: 15px; }
        .ad-price { font-size: 1.3rem; font-weight: 800; color: var(--accent); }

        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø³ÙÙ„ÙŠ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ */
        .tab-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(20px);
            display: flex; justify-content: space-around;
            padding: 10px 0 25px; border-top: 1px solid rgba(255,255,255,0.1);
            z-index: 1000;
        }

        .tab-item {
            background: none; border: none; color: #64748b;
            display: flex; flex-direction: column; align-items: center;
            width: 25%; transition: 0.3s; position: relative;
        }

        .tab-item i { font-size: 22px; margin-bottom: 4px; transition: 0.3s; }
        .tab-item span { font-size: 11px; font-weight: 500; }

        .tab-item.active { color: var(--accent); }
        .tab-item.active i { transform: translateY(-5px); text-shadow: 0 0 15px var(--accent); }
        .tab-item.active::after {
            content: ''; position: absolute; bottom: -8px; width: 5px; height: 5px;
            background: var(--accent); border-radius: 50%;
        }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #login-view {
            background: radial-gradient(circle at top, #2e1065, #0f172a);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        .login-card {
            text-align: center; padding: 40px 20px; width: 85%;
            background: rgba(255,255,255,0.03); border-radius: 30px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* Ø£Ø²Ø±Ø§Ø± ÙˆØ­Ù‚ÙˆÙ„ */
        .btn-glow {
            background: linear-gradient(90deg, #7c3aed, #00f2fe);
            color: white; border: none; padding: 16px 30px;
            border-radius: 18px; font-weight: bold; width: 100%;
            box-shadow: 0 10px 20px rgba(124, 58, 237, 0.3);
        }

        .input-glass {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            color: white; padding: 15px; border-radius: 15px; width: 100%; margin-bottom: 12px;
        }

        .delete-btn {
            background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid #ef4444;
            padding: 8px; border-radius: 12px; font-size: 12px; width: 100%; margin-top: 10px;
        }
    </style>
</head>
<body>

    <div id="page-login" class="page-container active">
        <div class="login-card">
            <div style="font-size: 60px; margin-bottom: 20px;">ğŸª™</div>
            <h1>Pi Market Hub</h1>
            <p style="color: #94a3b8; margin-bottom: 30px;">ØªØ¯Ø§ÙˆÙ„ Ø¨Ø£Ù…Ø§Ù† ÙÙŠ Ù…Ø¬ØªÙ…Ø¹ Ø¨Ø§ÙŠ</p>
            <button class="btn-glow" onclick="initPi()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Pi</button>
        </div>
    </div>

    <div id="page-browse" class="page-container">
        <h2 style="margin-bottom: 20px;">Ø§ÙƒØªØ´Ù Ø§Ù„Ø¹Ø±ÙˆØ¶</h2>
        <input type="text" class="input-glass" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¬ÙˆØ§Ù„ØŒ Ø£Ø«Ø§Ø«..." onkeyup="filterAds(this.value)">
        <div id="ads-grid" style="display: grid; grid-template-columns: 1fr; gap: 10px;"></div>
    </div>

    <div id="page-add" class="page-container">
        <div class="ad-card" style="padding: 20px;">
            <h3>Ø£Ù†Ø´Ø¦ Ø¥Ø¹Ù„Ø§Ù†Ø§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹</h3>
            <form id="postForm">
                <label>ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬</label>
                <input type="file" id="p-file" class="input-glass" accept="image/*" required>
                <input type="text" id="p-title" class="input-glass" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù†ØªØ¬" required>
                <textarea id="p-desc" class="input-glass" rows="4" placeholder="ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬..." required></textarea>
                <input type="number" id="p-price" class="input-glass" placeholder="Ø§Ù„Ø³Ø¹Ø± Ø¨Ù€ Pi" step="0.001" required>
                <input type="tel" id="p-phone" class="input-glass" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨" required>
                <button type="submit" class="btn-glow">Ù†Ø´Ø± Ø§Ù„Ø¢Ù†</button>
            </form>
        </div>
    </div>

    <div id="page-profile" class="page-container">
        <div class="ad-card" style="padding: 20px; text-align: center; background: var(--primary);">
            <div id="user-avatar" style="font-size: 40px; margin-bottom: 10px;">ğŸ‘¤</div>
            <h3 id="username-tag">--</h3>
        </div>
        <h4>Ø¥Ø¹Ù„Ø§Ù†Ø§ØªÙƒ Ø§Ù„Ù†Ø´Ø·Ø©</h4>
        <div id="my-ads-grid"></div>
    </div>

    <nav class="tab-bar" id="bottom-nav" style="display: none;">
        <button class="tab-item active" onclick="switchPage('browse', this)">
            <i class="fas fa-house"></i>
            <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
        </button>
        <button class="tab-item" onclick="switchPage('add', this)">
            <i class="fas fa-circle-plus"></i>
            <span>Ø¥Ø¶Ø§ÙØ©</span>
        </button>
        <button class="tab-item" onclick="switchPage('profile', this)">
            <i class="fas fa-user-circle"></i>
            <span>Ø­Ø³Ø§Ø¨ÙŠ</span>
        </button>
    </nav>

    <script>
        const SB_URL = 'https://axjkwrssmofzavaoqutq.supabase.co';
        const SB_KEY = 'sb_publishable_tiuMncgWhf1YRWoD-uYQ3Q_ziI8OKci';
        const sb = supabase.createClient(SB_URL, SB_KEY);
        let currentUser = null;

        // Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙØ­Ø§Øª
        function switchPage(pageId, btn) {
            document.querySelectorAll('.page-container').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + pageId).classList.add('active');
            
            document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
            if(btn) btn.classList.add('active');

            if(pageId === 'browse') fetchAllAds();
            if(pageId === 'profile') fetchUserAds();
            window.scrollTo(0,0);
        }

        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        async function initPi() {
            try {
                const Pi = window.Pi;
                Pi.init({ version: "2.0" });
                const auth = await Pi.authenticate(['username'], (p) => {});
                currentUser = auth.user;
                document.getElementById('username-tag').innerText = currentUser.username;
                document.getElementById('bottom-nav').style.display = 'flex';
                switchPage('browse', document.querySelector('.tab-item'));
            } catch (e) {
                alert("ÙŠØ±Ø¬Ù‰ ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¯Ø§Ø®Ù„ Ù…ØªØµÙØ­ Pi Ø§Ù„Ø±Ø³Ù…ÙŠ");
            }
        }

        // Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª
        async function fetchAllAds() {
            const { data } = await sb.from('ads').select('*').order('created_at', {ascending: false});
            renderAds(data, 'ads-grid', false);
        }

        async function fetchUserAds() {
            const { data } = await sb.from('ads').select('*').eq('seller_username', currentUser.username);
            renderAds(data, 'my-ads-grid', true);
        }

        function renderAds(data, containerId, isOwner) {
            const container = document.getElementById(containerId);
            container.innerHTML = data.map(ad => `
                <div class="ad-card">
                    <img src="${SB_URL}/storage/v1/object/public/ads-images/${ad.image_url}">
                    <div class="ad-content">
                        <div class="ad-price">${ad.price} Pi</div>
                        <h4 style="margin: 5px 0;">${ad.title}</h4>
                        <p style="font-size: 13px; color: #94a3b8;">Ø§Ù„Ø¨Ø§Ø¦Ø¹: ${ad.seller_username}</p>
                        <a href="https://wa.me/${ad.phone}" style="text-decoration:none; color:var(--accent); font-weight:bold;">ØªÙˆØ§ØµÙ„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ â†</a>
                        ${isOwner ? `<button class="delete-btn" onclick="deleteAd('${ad.id}', '${ad.image_url}')">Ø­Ø°Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹</button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Ø­Ø°Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† (Ø¥ØµÙ„Ø§Ø­ ÙƒØ§Ù…Ù„)
        async function deleteAd(id, imgPath) {
            if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ")) return;
            const { error } = await sb.from('ads').delete().eq('id', id);
            if(!error) {
                await sb.storage.from('ads-images').remove([imgPath]);
                alert("ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­");
                fetchUserAds();
                fetchAllAds();
            }
        }

        // Ø±ÙØ¹ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†
        document.getElementById('postForm').onsubmit = async (e) => {
            e.preventDefault();
            const file = document.getElementById('p-file').files[0];
            const path = `file_${Date.now()}.png`;

            await sb.storage.from('ads-images').upload(path, file);
            await sb.from('ads').insert([{
                title: document.getElementById('p-title').value,
                description: document.getElementById('p-desc').value,
                price: document.getElementById('p-price').value,
                phone: document.getElementById('p-phone').value,
                image_url: path,
                seller_username: currentUser.username
            }]);

            alert("ØªÙ… Ø§Ù„Ù†Ø´Ø±!");
            document.getElementById('postForm').reset();
            switchPage('browse');
        };
    </script>
</body>
</html>
