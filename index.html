<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Pi Elite Hub 2026</title>

  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <style>
    :root{
      --bg:#070A16; --bg2:#0b1226; --card:rgba(255,255,255,.07);
      --stroke:rgba(255,255,255,.12); --primary:#7c3aed; --primary2:#a855f7;
      --accent:#00f2fe; --gold:#f59e0b; --text:#ffffff; --muted:#a7b0c3;
      --r:22px; --nav-h: 76px; --safe: env(safe-area-inset-bottom);
    }

    *{box-sizing:border-box; -webkit-tap-highlight-color:transparent; outline:none;}
    body{
      margin:0; color:var(--text); font-family: system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at top, #1e1b4b, var(--bg));
      min-height:100vh; overflow-x:hidden;
    }

    .glass{ background: var(--card); border: 1px solid var(--stroke); backdrop-filter: blur(16px); border-radius: var(--r); }
    
    /* Header */
    .app-bar {
      display: flex; justify-content: space-between; align-items: center;
      padding: 12px 16px; margin: 10px; position: sticky; top: 0; z-index: 1000;
    }
    .btn-login {
      background: var(--primary); color: white; border: none; padding: 8px 16px;
      border-radius: 12px; font-weight: bold; font-size: 13px; cursor: pointer;
    }

    /* Pages */
    .page{ display:none; padding: 10px 14px calc(var(--nav-h) + 30px + var(--safe)); animation: fade .3s ease; }
    .page.active{ display:block; }
    @keyframes fade{ from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:translateY(0)} }

    /* Ads Grid */
    .ads-grid{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .ad-card{ position:relative; overflow:hidden; transition: 0.2s; border: 1px solid var(--stroke); }
    .ad-card.featured { border: 2px solid var(--gold); box-shadow: 0 0 15px rgba(245, 158, 11, 0.2); }
    .featured-badge {
      position: absolute; top: 8px; left: 8px; background: var(--gold);
      color: #000; padding: 3px 8px; border-radius: 6px; font-size: 10px; font-weight: 900; z-index: 10;
    }
    .ad-thumb{ width:100%; height:140px; object-fit:cover; border-radius: var(--r) var(--r) 0 0; }
    .ad-info{ padding: 12px; }
    .ad-title{ font-size: 13px; font-weight: 600; height: 34px; overflow: hidden; margin-bottom: 4px; }
    .ad-price{ color: var(--accent); font-weight: 900; font-size: 16px; }

    /* Nav Bar */
    .tab-bar{
      position: fixed; bottom:0; left:0; right:0; height: var(--nav-h);
      background: rgba(7,10,22,0.95); border-top: 1px solid var(--stroke);
      display:flex; align-items:center; justify-content:space-around; z-index: 1000;
      padding-bottom: var(--safe); backdrop-filter: blur(10px);
    }
    .tab-item{ color: var(--muted); display:flex; flex-direction:column; align-items:center; font-size: 11px; background:none; border:none; flex:1; }
    .tab-item.active{ color: var(--accent); }
    .tab-item i{ font-size: 20px; margin-bottom: 4px; }

    .btn-main{
      width:100%; padding: 14px; border:none; border-radius: 16px;
      color: white; font-weight: 800; background: linear-gradient(90deg, var(--primary), var(--primary2));
      cursor:pointer; margin-top: 10px;
    }
    .btn-gold{ background: linear-gradient(90deg, #f59e0b, #d97706); color: #000; }
    
    input, textarea {
      width:100%; padding:12px; margin-bottom:10px; border-radius:12px; 
      background:rgba(255,255,255,0.05); border:1px solid var(--stroke); color:white;
    }

    .toast{
      position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
      background: rgba(0,0,0,0.9); color: #fff; padding: 10px 20px;
      border-radius: 20px; font-size: 14px; display: none; z-index: 9999; border: 1px solid var(--primary); text-align: center;
    }
  </style>
</head>
<body>

  <div id="toast" class="toast"></div>

  <header class="app-bar glass">
    <div style="display:flex; align-items:center; gap:8px;">
      <span style="font-size:24px;">ðŸ’ </span>
      <b style="font-size:18px;">Elite Hub</b>
    </div>
    <div id="auth-ui">
      <button class="btn-login" id="login-btn" onclick="initPi()">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
      <div id="user-info" style="display:none;">
        <span id="username-display" class="muted" style="font-size:12px; font-weight:bold;"></span>
      </div>
    </div>
  </header>

  <main>
    <div id="page-home" class="page active"><div id="ads-grid" class="ads-grid"></div></div>

    <div id="page-add" class="page">
      <div class="glass" style="padding: 20px;">
        <h3>Ø§Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù†Ùƒ</h3>
        <input type="file" id="p-img" accept="image/*" />
        <input type="text" id="p-title" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù†ØªØ¬" />
        <input type="number" id="p-price" placeholder="Ø§Ù„Ø³Ø¹Ø± Ø¨Ù€ Pi" />
        <textarea id="p-desc" placeholder="ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬..."></textarea>
        <button class="btn-main" id="upload-btn" onclick="uploadAd()">Ù†Ø´Ø± Ø§Ù„Ø¢Ù†</button>
      </div>
    </div>

    <div id="page-profile" class="page">
      <div class="glass" style="padding:15px; margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;">
          <h3 style="margin:0">Ø¥Ø¹Ù„Ø§Ù†Ø§ØªÙŠ</h3>
          <button class="btn-login btn-gold" onclick="requestWithdraw()">Ø³Ø­Ø¨ Pi</button>
      </div>
      <div id="my-ads-grid" class="ads-grid"></div>
    </div>
  </main>

  <nav class="tab-bar">
    <button class="tab-item active" onclick="nav('home', this)"><i class="fas fa-th-large"></i>Ø§Ù„Ø³ÙˆÙ‚</button>
    <button class="tab-item" onclick="nav('add', this)"><i class="fas fa-plus-circle"></i>Ù†Ø´Ø±</button>
    <button class="tab-item" onclick="nav('profile', this)"><i class="fas fa-user"></i>Ø­Ø³Ø§Ø¨ÙŠ</button>
  </nav>

  <script>
    let _sb = null;
    let user = null;

    // ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙˆØ¬Ù„Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    window.onload = async () => {
      try {
        const res = await fetch('/api/config');
        const config = await res.json();
        _sb = supabase.createClient(config.SB_URL, config.SB_ANON);
        loadAds();
      } catch (e) { toast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±"); }
    };

    async function initPi(){
      try {
        const Pi = window.Pi;
        Pi.init({ version: "2.0" });
        const auth = await Pi.authenticate(['username'], (p) => {});
        user = auth.user;
        document.getElementById('login-btn').style.display = 'none';
        document.getElementById('user-info').style.display = 'block';
        document.getElementById('username-display').textContent = `@${user.username}`;
        toast("Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ " + user.username);
      } catch (e) { alert("Ø§ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ù† Pi Browser"); }
    }

    function nav(id, btn){
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('page-' + id).classList.add('active');
      document.querySelectorAll('.tab-item').forEach(i => i.classList.remove('active'));
      if(btn) btn.classList.add('active');
      if(id === 'home') loadAds();
      if(id === 'profile') user ? loadMyAds() : toast("Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");
    }

    async function loadAds(){
      if(!_sb) return;
      const { data } = await _sb.from('ads').select('*').order('created_at', {ascending: false});
      if(data) renderGrid(data, 'ads-grid', false);
    }

    async function loadMyAds(){
      const { data } = await _sb.from('ads').select('*').eq('seller_username', user.username);
      renderGrid(data || [], 'my-ads-grid', true);
    }

    function renderGrid(data, containerId, isOwner){
      const container = document.getElementById(containerId);
      const now = new Date();
      const sorted = data.sort((a,b) => (b.featured_until && new Date(b.featured_until)>now) - (a.featured_until && new Date(a.featured_until)>now));

      container.innerHTML = sorted.map(ad => {
        const isFeatured = ad.featured_until && new Date(ad.featured_until) > now;
        return `
          <div class="glass ad-card ${isFeatured ? 'featured' : ''}">
            ${isFeatured ? '<div class="featured-badge">Ù…Ù…ÙŠØ²</div>' : ''}
            <img class="ad-thumb" src="${_sb.storageUrl}/object/public/ads-images/${ad.image_url}" onerror="this.src='https://via.placeholder.com/150'">
            <div class="ad-info">
              <div class="ad-title">${ad.title}</div>
              <div class="ad-price">${ad.price} Pi</div>
              ${isOwner ? `<button class="btn-login btn-gold" style="width:100%; margin-top:5px; font-size:10px" onclick="featureAd('${ad.id}')">ØªÙ…ÙŠÙŠØ² Ø¨Ù€ 5 Pi</button>` : ''}
            </div>
          </div>`;
      }).join('');
    }

    // --- Ø¯Ø§Ù„Ø© Ø§Ù„Ø±ÙØ¹ Ø§Ù„ÙØ¹Ù„ÙŠØ© ---
    async function uploadAd() {
      if (!user) return toast("Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");
      const fileInput = document.getElementById('p-img');
      const title = document.getElementById('p-title').value;
      const price = document.getElementById('p-price').value;
      const desc = document.getElementById('p-desc').value;

      if (!fileInput.files[0] || !title || !price) return toast("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„ØµÙˆØ±Ø©");

      const btn = document.getElementById('upload-btn');
      btn.disabled = true; btn.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...";

      try {
        const file = fileInput.files[0];
        const fileName = `${Date.now()}_${user.username}.${file.name.split('.').pop()}`;

        // 1. Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©
        const { error: upErr } = await _sb.storage.from('ads-images').upload(fileName, file);
        if (upErr) throw upErr;

        // 2. Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const { error: insErr } = await _sb.from('ads').insert([{
          title, price: parseFloat(price), description: desc,
          image_url: fileName, seller_username: user.username
        }]);
        if (insErr) throw insErr;

        toast("âœ… ØªÙ… Ø§Ù„Ù†Ø´Ø± Ø¨Ù†Ø¬Ø§Ø­");
        nav('home');
      } catch (e) { toast("Ø®Ø·Ø£: " + e.message); }
      finally { btn.disabled = false; btn.textContent = "Ù†Ø´Ø± Ø§Ù„Ø¢Ù†"; }
    }

    async function featureAd(adId) {
      if(!user) return toast("Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");
      try {
        await Pi.createPayment({
          amount: 5.0, memo: "ØªÙ…ÙŠÙŠØ² Ø¥Ø¹Ù„Ø§Ù†", metadata: { adId, type: "feature_ad" },
        }, {
          onReadyForServerApproval: (pId) => fetch('/api/pi/approve', {method:'POST', body: JSON.stringify({paymentId:pId, adId})}),
          onReadyForServerCompletion: (pId, txid) => fetch('/api/pi/complete', {method:'POST', body: JSON.stringify({paymentId:pId, txid, adId})}).then(()=>loadAds()),
        });
      } catch(e) { toast("ÙØ´Ù„ Ø§Ù„Ø¯ÙØ¹"); }
    }

    function toast(msg){
      const t = document.getElementById('toast');
      t.textContent = msg; t.style.display = 'block';
      setTimeout(() => t.style.display = 'none', 3000);
    }
  </script>
</body>
</html>
