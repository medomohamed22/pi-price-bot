<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منصة التبرع بـ Pi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white p-8 rounded-2xl shadow-xl max-w-md w-full text-center">
        <h1 class="text-3xl font-bold text-purple-700 mb-6">تبرع لدعم المشروع</h1>
        
        <div class="space-y-4">
            <div>
                <label class="block text-right text-gray-700 mb-2">الاسم (اختياري)</label>
                <input type="text" id="donorName" placeholder="أدخل اسمك" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
            </div>

            <div>
                <label class="block text-right text-gray-700 mb-2">مبلغ التبرع (Pi)</label>
                <input type="number" id="amount" value="1" min="0.1" step="0.1" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
            </div>

            <button onclick="startPayment()" id="payBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-lg transition duration-300">
                تبرع الآن باستخدام Pi
            </button>
        </div>

        <div id="status" class="mt-4 text-sm text-gray-600"></div>
    </div>

    <script>
        // --- إعدادات Supabase ---
        const SUPABASE_URL = 'https://xncapmzlwuisupkjlftb.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_zPECXAiI_bDbeLtRYe3vIw_IEt_p_AS'; // استبدل هذا بمفتاح ANON الخاص بك
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- إعدادات Pi Network ---
        const Pi = window.Pi;
        Pi.init({ version: "1.5", sandbox: false }); // اجعل sandbox: false عند النشر الفعلي

        async function startPayment() {
            const amount = document.getElementById('amount').value;
            const donorName = document.getElementById('donorName').value || "متبرع فاعل خير";
            const statusDiv = document.getElementById('status');
            const btn = document.getElementById('payBtn');

            if (!amount || amount <= 0) {
                alert("يرجى إدخال مبلغ صحيح");
                return;
            }

            try {
                btn.disabled = true;
                btn.innerText = "جاري الاتصال بالمحفظة...";

                const payment = await Pi.createPayment({
                    amount: parseFloat(amount),
                    memo: `تبرع من ${donorName}`,
                    metadata: { donorName: donorName },
                }, {
                    onReadyForServerApproval: (paymentId) => {
                        // إرسال المعرف إلى وظيفة Netlify التي كتبتها (Approve)
                        return fetch('/api/pi/approve', {
                            method: 'POST',
                            body: JSON.stringify({ paymentId }),
                        });
                    },
                    onReadyForServerCompletion: (paymentId, txid) => {
                        // إرسال المعرف و hash المعاملة إلى وظيفة Netlify (Complete)
                        return fetch('/api/pi/complete', {
                            method: 'POST',
                            body: JSON.stringify({ paymentId, txid }),
                        });
                    },
                    onCancel: (paymentId) => {
                        statusDiv.innerText = "تم إلغاء العملية.";
                        btn.disabled = false;
                    },
                    onError: (error, payment) => {
                        console.error(error);
                        statusDiv.innerText = "حدث خطأ أثناء الدفع.";
                        btn.disabled = false;
                    },
                });

                // بعد نجاح الدفع، سجل البيانات في Supabase
                if (payment) {
                    const { data, error } = await supabase
                        .from('donations') // تأكد من إنشاء جدول بهذا الاسم في Supabase
                        .insert([
                            { 
                                donor_name: donorName, 
                                amount: amount, 
                                pi_payment_id: payment.identifier 
                            }
                        ]);

                    statusDiv.innerHTML = "<span class='text-green-600 font-bold'>شكراً لك! تم استلام التبرع بنجاح.</span>";
                }

            } catch (err) {
                console.error(err);
                statusDiv.innerText = "فشلت العملية.";
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
