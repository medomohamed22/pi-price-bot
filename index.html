<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat - Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø°ÙƒÙŠ</title>
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <style>
        :root { --main-color: #6a0dad; --bg-color: #f0f2f5; --user-msg: #6a0dad; --ai-msg: #ffffff; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg-color); margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; }
        .chat-container { width: 100%; max-width: 450px; height: 90vh; background: white; border-radius: 15px; box-shadow: 0 5px 30px rgba(0,0,0,0.1); display: flex; flex-direction: column; position: relative; overflow: hidden; }
        .header { background: var(--main-color); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        #points-badge { background: #ffd700; color: #000; padding: 4px 12px; border-radius: 20px; font-size: 0.9em; }
        #chat-box { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; background: #f9f9f9; }
        .msg { padding: 12px 16px; border-radius: 18px; max-width: 80%; line-height: 1.5; font-size: 15px; position: relative; }
        .user { align-self: flex-end; background: var(--user-msg); color: white; border-bottom-right-radius: 2px; }
        .ai { align-self: flex-start; background: var(--ai-msg); color: #333; border-bottom-left-radius: 2px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .input-area { padding: 15px; background: white; border-top: 1px solid #eee; display: flex; gap: 10px; }
        input { flex: 1; border: 1px solid #ddd; padding: 12px; border-radius: 25px; outline: none; transition: 0.3s; }
        input:focus { border-color: var(--main-color); }
        button#send-btn { background: var(--main-color); border: none; width: 45px; height: 45px; border-radius: 50%; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .pay-overlay { position: absolute; inset: 0; background: rgba(255,255,255,0.95); z-index: 100; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 30px; text-align: center; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid var(--main-color); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="chat-container">
    <div class="header">
        <span>Gemini AI Chat</span>
        <div id="points-badge">âš¡ <span id="points-count">0</span> Ù†Ù‚Ø·Ø©</div>
    </div>

    <div id="chat-box">
        <div class="msg ai">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ! Ù„Ø¯ÙŠÙƒ 5 Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù…Ø¬Ø§Ù†ÙŠØ©. ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒØŸ</div>
    </div>

    <div id="pay-overlay" class="pay-overlay">
        <div style="font-size: 50px;">ğŸ’</div>
        <h2>Ø±ØµÙŠØ¯Ùƒ Ù†ÙØ°!</h2>
        <p>ÙƒÙ„ 1 Pi ÙŠÙ…Ù†Ø­Ùƒ <b>20 Ù†Ù‚Ø·Ø©</b> Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ.</p>
        <button onclick="handlePayment()" style="background:var(--main-color); color:white; border:none; padding:12px 25px; border-radius:25px; font-weight:bold; cursor:pointer;">Ø§Ø´Ø­Ù† 20 Ù†Ù‚Ø·Ø© Ø§Ù„Ø¢Ù†</button>
    </div>

    <div class="input-area">
        <input type="text" id="user-input" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§...">
        <button id="send-btn" onclick="askGemini()">
            <span id="btn-text">â¤</span>
            <div id="btn-loader" class="loader"></div>
        </button>
    </div>
</div>

<script>
    Pi.init({ version: "2.0" });

    let points = parseInt(localStorage.getItem('pi_ai_points')) || (localStorage.getItem('pi_ai_points') === null ? 5 : 0);

    function updateDisplay() {
        document.getElementById('points-count').innerText = points;
        document.getElementById('pay-overlay').style.display = points <= 0 ? 'flex' : 'none';
        localStorage.setItem('pi_ai_points', points);
    }

    updateDisplay();

    async function askGemini() {
        const input = document.getElementById('user-input');
        const text = input.value.trim();
        if (!text || points <= 0) return;

        // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø± ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
        toggleLoading(true);
        appendMessage('user', text);
        input.value = '';

        try {
            const response = await fetch('/api/gemini/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: text })
            });

            if (response.ok) {
                const data = await response.json();
                appendMessage('ai', data.reply);
                // Ø®ØµÙ… Ø§Ù„Ù†Ù‚Ø·Ø© ÙÙ‚Ø· Ø¹Ù†Ø¯ Ù†Ø¬Ø§Ø­ Ø§Ù„Ø±Ø¯
                points--;
                updateDisplay();
            } else {
                throw new Error();
            }
        } catch (err) {
            appendMessage('ai', 'Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
        } finally {
            toggleLoading(false);
        }
    }

    function appendMessage(role, text) {
        const box = document.getElementById('chat-box');
        const div = document.createElement('div');
        div.className = `msg ${role}`;
        div.innerText = text;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    function toggleLoading(isLoading) {
        document.getElementById('btn-text').style.display = isLoading ? 'none' : 'block';
        document.getElementById('btn-loader').style.display = isLoading ? 'block' : 'none';
        document.getElementById('send-btn').disabled = isLoading;
    }

    async function handlePayment() {
        try {
            const user = await Pi.authenticate(['username', 'payments']);
            Pi.createPayment({
                amount: 1,
                memo: "Ø´Ø±Ø§Ø¡ 20 Ù†Ù‚Ø·Ø© Ø´Ø§Øª",
                metadata: { points: 20 }
            }, {
                onReadyForServerApproval: (id) => fetch('/api/pi/approve', { method: 'POST', body: JSON.stringify({ paymentId: id }) }),
                onReadyForServerCompletion: (id, tx) => {
                    fetch('/api/pi/complete', { method: 'POST', body: JSON.stringify({ paymentId: id, txid: tx }) })
                    .then(res => {
                        if(res.ok) {
                            points += 20;
                            updateDisplay();
                            alert("ØªÙ… Ø§Ù„Ø´Ø­Ù† Ø¨Ù†Ø¬Ø§Ø­!");
                        }
                    });
                }
            });
        } catch (e) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¯ÙØ¹"); }
    }
</script>
</body>
</html>
