<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Pi Startups | Ù…Ù†ØµØ© Ø¯Ø¹Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹Ø§Øª</title>

  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet" />
  
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* --- CSS Variables & Reset --- */
    :root {
      --primary: #6f2fa0; /* Pi Purple */
      --primary-dark: #4b1e6e;
      --accent: #fbce3a; /* Pi Gold */
      --bg-body: #f8f9fe;
      --bg-card: #ffffff;
      --text-main: #2d2d2d;
      --text-muted: #6c757d;
      --border-radius: 16px;
      --shadow: 0 8px 30px rgba(0,0,0,0.06);
      --transition: all 0.3s ease;
    }

    * { box-sizing: border-box; outline: none; }
    body {
      margin: 0;
      padding: 0;
      font-family: 'Tajawal', sans-serif;
      background-color: var(--bg-body);
      color: var(--text-main);
      line-height: 1.6;
    }

    /* --- Header --- */
    header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid rgba(0,0,0,0.05);
      padding: 15px 0;
    }
    .container {
      width: 90%;
      max-width: 1200px;
      margin: 0 auto;
    }
    .nav-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logo {
      font-weight: 900;
      font-size: 24px;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .logo span { color: var(--text-main); font-size: 18px; font-weight: 700; }
    
    /* --- Buttons --- */
    .btn {
      padding: 10px 20px;
      border-radius: 50px;
      border: none;
      font-weight: 700;
      font-family: 'Tajawal', sans-serif;
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .btn-primary {
      background: var(--primary);
      color: #fff;
      box-shadow: 0 4px 15px rgba(111, 47, 160, 0.3);
    }
    .btn-primary:hover { background: var(--primary-dark); transform: translateY(-2px); }
    .btn-outline {
      background: transparent;
      border: 2px solid var(--primary);
      color: var(--primary);
    }
    .btn-outline:hover { background: var(--primary); color: #fff; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

    /* --- Hero Section --- */
    .hero {
      text-align: center;
      padding: 60px 0 40px;
    }
    .hero h1 { font-size: 2.5rem; margin-bottom: 10px; color: var(--primary-dark); }
    .hero p { font-size: 1.1rem; color: var(--text-muted); max-width: 600px; margin: 0 auto 30px; }

    /* --- User Info --- */
    #user-section {
      background: linear-gradient(135deg, #6f2fa0, #8e44ad);
      color: white;
      padding: 20px;
      border-radius: var(--border-radius);
      margin-bottom: 30px;
      display: none; /* Hidden by default */
      animation: fadeIn 0.5s ease;
    }
    .user-welcome { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
    .user-name { font-size: 1.2rem; font-weight: bold; display: flex; align-items: center; gap: 10px; }

    /* --- Forms --- */
    .form-card {
      background: var(--bg-card);
      padding: 25px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      margin-top: 20px;
    }
    .input-group { margin-bottom: 15px; }
    input, textarea, select {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #eee;
      border-radius: 12px;
      font-family: 'Tajawal', sans-serif;
      font-size: 15px;
      transition: var(--transition);
      background: #fdfdfd;
    }
    input:focus, textarea:focus { border-color: var(--primary); background: #fff; }
    textarea { resize: vertical; min-height: 100px; }
    .row-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    @media (max-width: 600px) { .row-inputs { grid-template-columns: 1fr; } }

    /* --- Projects Grid --- */
    .grid-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      padding: 20px 0;
    }
    .card {
      background: var(--bg-card);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      transition: var(--transition);
      border: 1px solid transparent;
      display: flex;
      flex-direction: column;
    }
    .card:hover { transform: translateY(-5px); border-color: rgba(111, 47, 160, 0.2); }
    .card-body { padding: 20px; flex-grow: 1; }
    .card-tag {
      background: #f3e5f5;
      color: var(--primary);
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
      display: inline-block;
      margin-bottom: 10px;
    }
    .card h3 { margin: 5px 0; font-size: 1.2rem; }
    .card p { color: var(--text-muted); font-size: 0.9rem; line-height: 1.5; }
    
    .progress-container { margin-top: 15px; }
    .progress-labels { display: flex; justify-content: space-between; font-size: 13px; font-weight: 700; margin-bottom: 5px; }
    .progress-bar {
      height: 8px;
      background: #eee;
      border-radius: 10px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      width: 0%;
      transition: width 1s ease;
    }

    /* --- Toast Notification --- */
    #toast {
      visibility: hidden;
      min-width: 250px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 50px;
      padding: 16px;
      position: fixed;
      z-index: 1000;
      left: 50%;
      bottom: 30px;
      transform: translateX(-50%);
      font-size: 14px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
    @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

  </style>
</head>
<body>

<header>
  <div class="container nav-content">
    <div class="logo">
      Ï€ <span>Pi Startups</span>
    </div>
    <div id="auth-btn-container">
      <button class="btn btn-primary" id="loginBtn" onclick="authenticateUser()">
        <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" /></svg>
        ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Pi
      </button>
    </div>
  </div>
</header>

<div class="container">
  
  <section class="hero">
    <h1>Ø§Ø¯Ø¹Ù… Ù…Ø´Ø±ÙˆØ¹Ø§Øª Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„</h1>
    <p>Ù…Ù†ØµØ© Ù„ØªÙ…ÙˆÙŠÙ„ ÙˆØ¯Ø¹Ù… Ø§Ù„Ø£ÙÙƒØ§Ø± Ø§Ù„Ù†Ø§Ø´Ø¦Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¹Ù…Ù„Ø© Pi. Ø´Ø§Ø±Ùƒ ÙÙƒØ±ØªÙƒ Ø£Ùˆ Ø§Ø¯Ø¹Ù… Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†.</p>
  </section>

  <div id="user-section">
    <div class="user-welcome">
      <div class="user-name">
        ğŸ‘‹ Ø£Ù‡Ù„Ø§Ù‹ØŒ <span id="display-username">Loading...</span>
      </div>
      <button class="btn btn-outline" style="border-color:white; color:white;" onclick="toggleAddProject()">
        + Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø±ÙˆØ¹ Ø¬Ø¯ÙŠØ¯
      </button>
    </div>

    <div id="add-project-box" class="form-card" style="display:none; color: var(--text-main); margin-top:20px;">
      <h3 style="margin-top:0">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</h3>
      <div class="row-inputs">
        <div class="input-group">
          <input type="text" id="pName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹">
        </div>
        <div class="input-group">
          <input type="text" id="pCategory" placeholder="Ø§Ù„ØªØµÙ†ÙŠÙ (Ù…Ø«Ø§Ù„: ØªÙ‚Ù†ÙŠØ©ØŒ ØªØ¹Ù„ÙŠÙ…)">
        </div>
      </div>
      <div class="input-group">
        <textarea id="pDesc" placeholder="ÙˆØµÙ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ÙˆØ±Ø¤ÙŠØªÙƒ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠØ©..."></textarea>
      </div>
      <div class="row-inputs">
        <div class="input-group">
          <input type="number" id="pGoal" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ (Pi)">
        </div>
        <div class="input-group">
          <input type="text" id="pOwner" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ø³Ø³" readonly>
        </div>
      </div>
      <div style="display:flex; gap:10px;">
        <button class="btn btn-primary" onclick="submitProject()">Ù†Ø´Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</button>
        <button class="btn btn-outline" onclick="toggleAddProject()">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>

  <div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px;">
    <h2 style="margin:0; color: var(--primary-dark);">Ø§Ù„Ù…Ø´Ø±ÙˆØ¹Ø§Øª Ø§Ù„Ù…Ù…ÙŠØ²Ø©</h2>
    <button class="btn btn-outline" style="padding:5px 15px; font-size:12px;" onclick="fetchProjects()">ØªØ­Ø¯ÙŠØ«</button>
  </div>
  
  <div id="projects-grid" class="grid-container">
    <div style="text-align:center; width:100%; grid-column: 1/-1; color:#999;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
  </div>

  <footer style="text-align:center; margin-top:50px; padding:20px; color:#999; font-size:13px;">
    Â© 2026 Pi Startups - All rights reserved
  </footer>

</div>

<div id="toast">Ø±Ø³Ø§Ù„Ø© ØªÙ†Ø¨ÙŠÙ‡</div>

<script>
  // --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Supabase ---
  // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø¸Ø§Ù‡Ø±Ø© Ù„Ø£Ù† Ù‡Ø°Ø§ ÙƒÙˆØ¯ Client-sideØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯ RLS ÙÙŠ Supabase Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  const supabase = window.supabase.createClient(
    "https://xncapmzlwuisupkjlftb.supabase.co",
    "sb_publishable_zPECXAiI_bDbeLtRYe3vIw_IEt_p_AS"
  );

  let currentUser = null;

  // --- Pi SDK Integration ---
  async function initPiSDK() {
    try {
      // 1. ØªÙ‡ÙŠØ¦Ø© SDK
      // ØºÙŠØ± sandbox Ø¥Ù„Ù‰ false Ø¹Ù†Ø¯ Ø§Ù„Ø±ÙØ¹ Ù„Ù„Ø¥Ù†ØªØ§Ø¬ (Production)
      Pi.init({ version: "2.0", sandbox: false }); 
      console.log("Pi SDK Initialized");
    } catch (err) {
      console.error("Pi SDK Init Error:", err);
    }
  }

  async function authenticateUser() {
    try {
      const loginBtn = document.getElementById("loginBtn");
      loginBtn.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
      loginBtn.disabled = true;

      // 2. Ø·Ù„Ø¨ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª (username)
      const scopes = ['username']; 
      
      // Ø¯Ø§Ù„Ø© callback Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„Ø¯ÙÙˆØ¹Ø§Øª ØºÙŠØ± Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© (Ø­ØªÙ‰ Ù„Ùˆ Ù„Ù… Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø¢Ù†)
      function onIncompletePaymentFound(payment) { 
        console.log("Incomplete payment found", payment);
      };

      const authResults = await Pi.authenticate(scopes, onIncompletePaymentFound);
      
      // 3. ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      currentUser = authResults.user;
      
      // 4. ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
      onLoginSuccess();
      
      // 5. Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
      saveUserToDB(currentUser);

    } catch (err) {
      console.error("Authentication failed:", err);
      showToast("ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„. ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ÙÙŠ Ù…ØªØµÙØ­ Pi.");
      const loginBtn = document.getElementById("loginBtn");
      loginBtn.innerHTML = `ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Pi`;
      loginBtn.disabled = false;
    }
  }

  function onLoginSuccess() {
    document.getElementById("auth-btn-container").style.display = "none";
    document.getElementById("user-section").style.display = "block";
    document.getElementById("display-username").textContent = currentUser.username;
    document.getElementById("pOwner").value = currentUser.username;
    showToast(`Ù…Ø±Ø­Ø¨Ø§Ù‹ ${currentUser.username} ğŸ‘‹`);
  }

  async function saveUserToDB(user) {
    const { error } = await supabase
      .from("pi_users")
      .upsert({ pi_uid: user.uid, username: user.username }, { onConflict: 'pi_uid' });
    if(error) console.warn("DB User Sync Error:", error.message);
  }

  // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹Ø§Øª (Supabase) ---

  async function submitProject() {
    if (!currentUser) return showToast("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹!");

    const name = document.getElementById("pName").value.trim();
    const category = document.getElementById("pCategory").value.trim();
    const desc = document.getElementById("pDesc").value.trim();
    const goal = document.getElementById("pGoal").value;

    if (!name || !desc || !goal) return showToast("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©");

    const payload = {
      owner_pi_uid: currentUser.uid,
      owner_username: currentUser.username,
      name: name,
      category: category,
      description: desc,
      goal_pi: Number(goal),
      raised_pi: 0
    };

    const btn = event.target;
    btn.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù†Ø´Ø±...";
    btn.disabled = true;

    const { error } = await supabase.from("projects").insert(payload);

    if (error) {
      console.error(error);
      showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†Ø´Ø±: " + error.message);
    } else {
      showToast("ØªÙ… Ù†Ø´Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ù†Ø¬Ø§Ø­! ğŸš€");
      toggleAddProject(); // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙÙˆØ±Ù…
      document.getElementById("pName").value = "";
      document.getElementById("pDesc").value = "";
      document.getElementById("pGoal").value = "";
      fetchProjects(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    }
    
    btn.textContent = "Ù†Ø´Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹";
    btn.disabled = false;
  }

  async function fetchProjects() {
    const grid = document.getElementById("projects-grid");
    
    const { data, error } = await supabase
      .from("projects")
      .select("*")
      .order("created_at", { ascending: false });

    if (error) {
      grid.innerHTML = `<div style="text-align:center; color:red">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</div>`;
      return;
    }

    if (!data || data.length === 0) {
      grid.innerHTML = `<div style="text-align:center; color:var(--text-muted); grid-column:1/-1;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø±ÙˆØ¹Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹. ÙƒÙ† Ø§Ù„Ø£ÙˆÙ„!</div>`;
      return;
    }

    grid.innerHTML = "";
    data.forEach(p => {
      const goal = p.goal_pi || 1;
      const raised = p.raised_pi || 0;
      const percent = Math.min(100, Math.round((raised / goal) * 100));
      
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <div class="card-body">
          <span class="card-tag">${escapeHtml(p.category)}</span>
          <h3>${escapeHtml(p.name)}</h3>
          <p>${escapeHtml(p.description)}</p>
          
          <div class="progress-container">
            <div class="progress-labels">
              <span>ØªÙ… Ø¬Ù…Ø¹: ${raised} Ï€</span>
              <span>Ø§Ù„Ù‡Ø¯Ù: ${goal} Ï€</span>
            </div>
            <div class="progress-bar" title="${percent}%">
              <div class="progress-fill" style="width: ${percent}%"></div>
            </div>
          </div>
          
          <div style="margin-top:15px; display:flex; justify-content:space-between; align-items:center; font-size:12px; color:#999;">
             <span>Ø¨ÙˆØ§Ø³Ø·Ø©: ${escapeHtml(p.owner_username || 'Ù…Ø¬Ù‡ÙˆÙ„')}</span>
             ${currentUser ? `<button class="btn btn-outline" style="padding:4px 10px; font-size:11px;" onclick="showToast('Ù‚Ø±ÙŠØ¨Ø§Ù‹: Ù…ÙŠØ²Ø© Ø§Ù„ØªØ¨Ø±Ø¹')">ØªØ¨Ø±Ø¹</button>` : ''}
          </div>
        </div>
      `;
      grid.appendChild(card);
    });
  }

  // --- UI Helpers ---
  function toggleAddProject() {
    const box = document.getElementById("add-project-box");
    box.style.display = (box.style.display === "none") ? "block" : "none";
  }

  function showToast(msg) {
    const x = document.getElementById("toast");
    x.textContent = msg;
    x.className = "show";
    setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
  }

  function escapeHtml(text) {
    if (!text) return "";
    return text
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  // ØªØ´ØºÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
  window.onload = function() {
    initPiSDK();
    fetchProjects();
  };

</script>

</body>
</html>
