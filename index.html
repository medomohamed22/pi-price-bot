<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بوابة دفع Pi الرسمية</title>
    
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root { --primary: #6d28d9; --accent: #f59e0b; --bg: #0f172a; --card: #1e293b; }
        body { margin: 0; font-family: sans-serif; background: var(--bg); color: white; display: flex; justify-content: center; align-items: center; height: 100vh; }
        .container { background: var(--card); padding: 2rem; border-radius: 20px; text-align: center; width: 350px; border: 1px solid rgba(255,255,255,0.1); }
        .pi-btn { background: linear-gradient(135deg, var(--primary), #4f46e5); color: white; border: none; width: 100%; padding: 1rem; border-radius: 12px; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 1rem; }
        .pi-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        #status { margin-top: 1rem; font-size: 0.8rem; color: var(--accent); }
    </style>
</head>
<body>

    <div class="container">
        <h2 id="user-name">تحميل...</h2>
        <p>ادفع 1 Pi ليتم تسجيلك في قاعدة البيانات</p>
        <button id="payButton" class="pi-btn" onclick="initiatePayment()">ادفع الآن 1 Pi</button>
        <div id="status">جاهز</div>
    </div>

    <script>
        // 1. إعداد Supabase (استخدم مفتاح anon المتاح للعامة)
        const supabaseUrl = 'https://xncapmzlwuisupkjlftb.supabase.co';
        const supabaseKey = 'xncapmzlwuisupkjlftb'; 
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        // 2. إعداد Pi SDK
        const Pi = window.Pi;
        Pi.init({ version: "2.0", sandbox: false });

        let currentUser = null;

        async function onStart() {
            try {
                const auth = await Pi.authenticate(['username', 'payments'], onIncompletePayment);
                currentUser = auth.user;
                document.getElementById('user-name').innerText = `أهلاً ${currentUser.username}`;
            } catch (e) {
                updateStatus("افتح الموقع من متصفح Pi", "red");
            }
        }

        async function initiatePayment() {
            const btn = document.getElementById('payButton');
            btn.disabled = true;
            updateStatus("جاري تحضير العملية...");

            try {
                const payment = await Pi.createPayment({
                    amount: 1.0,
                    memo: "تسجيل في قاعدة البيانات",
                    metadata: { type: "user_registration" }
                }, {
                    // الربط مع Netlify Function: Approve
                    onReadyForServerApproval: async (paymentId) => {
                        updateStatus("جاري الموافقة من السيرفر...");
                        const response = await fetch('/api/pi/approve', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ paymentId })
                        });
                        return response.json();
                    },
                    // الربط مع Netlify Function: Complete
                    onReadyForServerCompletion: async (paymentId, txid) => {
                        updateStatus("جاري إنهاء المعاملة...");
                        const response = await fetch('/api/pi/complete', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ paymentId, txid })
                        });
                        
                        if (response.ok) {
                            // 3. الخطوة الأخيرة: الحفظ في Supabase
                            await saveUserToDatabase(txid);
                            updateStatus("تم الدفع والحفظ بنجاح! ✅", "#22c55e");
                        }
                    },
                    onCancel: () => { updateStatus("تم الإلغاء"); btn.disabled = false; },
                    onError: (err) => { updateStatus("خطأ في العملية"); btn.disabled = false; }
                });
            } catch (err) {
                updateStatus("حدث خطأ غير متوقع");
                btn.disabled = false;
            }
        }

        async function saveUserToDatabase(txid) {
            const { error } = await _supabase
                .from('payments')
                .insert([{ 
                    username: currentUser.username, 
                    amount: 1.0, 
                    txid: txid 
                }]);
            if (error) console.error("Database Save Error:", error);
        }

        function onIncompletePayment(payment) {
            // يمكن استدعاء /api/pi/complete هنا إذا وجدت دفع معلق
        }

        function updateStatus(msg, color = "#f59e0b") {
            const s = document.getElementById('status');
            s.innerText = msg; s.style.color = color;
        }

        onStart();
    </script>
</body>
</html>
