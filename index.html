<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gemini AI Chat - Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ù‚Ø§Ø·</title>
<script src="https://sdk.minepi.com/pi-sdk.js"></script>
<style>
:root {
  --main-color: #6a0dad;
  --bg-color: #f4f4f9;
  --ai-color: #e0e0e0;
  --user-color: #6a0dad;
  --overlay-color: rgba(255, 255, 255, 0.95);
}
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: var(--bg-color);
  margin: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100vh;
}
.chat-container {
  width: 400px;
  height: 600px;
  background: white;
  border-radius: 20px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.15);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  position: relative;
}
.header {
  background: var(--main-color);
  color: white;
  font-weight: bold;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 20px;
  box-shadow: 0 3px 8px rgba(0,0,0,0.2);
  border-bottom-left-radius: 20px;
  border-bottom-right-radius: 20px;
}
#credits-display {
  background: rgba(255,255,255,0.2);
  padding: 5px 10px;
  border-radius: 10px;
  font-size: 14px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}
#chat-box {
  flex: 1;
  padding: 15px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 10px;
  background: #fafafa;
}
.message {
  padding: 12px 18px;
  border-radius: 20px;
  max-width: 80%;
  font-size: 14px;
  word-wrap: break-word;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  opacity: 0;
  transform: translateY(10px);
  animation: fadeInUp 0.4s forwards;
}
.user { background: var(--user-color); color: white; align-self: flex-end; }
.ai { background: var(--ai-color); color: #333; align-self: flex-start; }

/* ØªØ£Ø«ÙŠØ± Ù†Ø¨Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© */
.pulse {
  animation: pulse 1s ease-in-out 0s 3;
}
@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}

/* fade-in Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
@keyframes fadeInUp {
  to { opacity: 1; transform: translateY(0); }
}

.input-area {
  padding: 15px;
  border-top: 1px solid #ddd;
  display: flex;
  gap: 5px;
  background: #fff;
}
input {
  flex: 1;
  padding: 10px;
  border: 1px solid #ddd;
  border-radius: 10px;
  outline: none;
}
button {
  background: var(--main-color);
  color: white;
  border: none;
  padding: 10px 15px;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.2s ease-in-out;
}
button:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

/* overlay Ø§Ù„Ø¯ÙØ¹ */
.pay-overlay {
  position: absolute;
  top: 0; left: 0; width: 100%; height: 100%;
  background: var(--overlay-color);
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  z-index: 10;
  padding: 20px;
  box-sizing: border-box;
  border-radius: 20px;
  backdrop-filter: blur(5px);
  animation: fadeIn 0.4s ease-in-out;
}
.pay-overlay h3 { color: var(--main-color); margin-bottom: 10px; }
.pay-overlay p { font-size: 14px; margin: 5px 0; }
@keyframes fadeIn { from{opacity:0;} to{opacity:1;} }
</style>
</head>

<body>
<div class="chat-container">
  <div class="header">
    <span>Gemini AI</span>
    <div id="credits-display">Ø§Ù„Ù†Ù‚Ø§Ø·: <span id="points">0</span></div>
  </div>

  <div id="chat-box">
    <div class="message ai">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ! Ù„Ø¯ÙŠÙƒ 5 Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù…Ø¬Ø§Ù†ÙŠØ©. Ø§Ø³Ø£Ù„Ù†ÙŠ Ø£ÙŠ Ø´ÙŠØ¡.</div>
  </div>

  <div id="pay-overlay" class="pay-overlay">
    <h3>âš ï¸ Ø§Ù†ØªÙ‡Øª Ù†Ù‚Ø§Ø·Ùƒ!</h3>
    <p>Ø§Ø´Ø­Ù† Ø§Ù„Ø¢Ù† Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©:</p>
    <p><b>1 Pi = 20 Ù†Ù‚Ø·Ø© Ù…Ø­Ø§Ø¯Ø«Ø©</b></p>
    <button id="pay-btn" onclick="handlePayment()">Ø§Ø´Ø­Ù† 20 Ù†Ù‚Ø·Ø© Ø¨ÙˆØ§Ø³Ø·Ø© Pi</button>
  </div>

  <div class="input-area" id="input-area">
    <input type="text" id="user-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§...">
    <button onclick="askGemini()">Ø¥Ø±Ø³Ø§Ù„</button>
  </div>
</div>

<script>
Pi.init({ version: "2.0" });

let userPoints = localStorage.getItem('chat_points');
if (userPoints === null) {
  userPoints = 5;
  localStorage.setItem('chat_points', userPoints);
} else userPoints = parseInt(userPoints);

updateUI();

function updateUI() {
  document.getElementById('points').innerText = userPoints;
  const overlay = document.getElementById('pay-overlay');
  const inputArea = document.getElementById('input-area');
  
  if (userPoints <= 0) {
    overlay.style.display = 'flex';
    inputArea.style.opacity = '0.5';
    inputArea.querySelector('input').disabled = true;
  } else {
    overlay.style.display = 'none';
    inputArea.style.opacity = '1';
    inputArea.querySelector('input').disabled = false;
  }
}

async function handlePayment() {
  try {
    const user = await Pi.authenticate(['username', 'payments']);
    const paymentData = { amount:1, memo:"Ø´Ø±Ø§Ø¡ 20 Ù†Ù‚Ø·Ø©", metadata:{points:20} };
    const callbacks = {
      onReadyForServerApproval: async (paymentId)=>{
        await fetch('/api/pi/approve',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({paymentId})
        });
      },
      onReadyForServerCompletion: async (paymentId, txid)=>{
        await fetch('/api/pi/complete',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({paymentId, txid})
        });
        userPoints += 20;
        localStorage.setItem('chat_points', userPoints);
        updateUI();
        // Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø´Ø­Ù† Ù…Ø¹ Ù†Ø¨Ø¶ Pulse
        addMessage("âœ… ØªÙ… Ø´Ø­Ù† 20 Ù†Ù‚Ø·Ø© Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰", "ai", true);
      },
      onCancel:()=>{ alert("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¯ÙØ¹"); },
      onError:(err)=>{ alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¯ÙØ¹"); console.error(err); }
    };
    Pi.createPayment(paymentData, callbacks);
  } catch(err){ alert("ÙŠØ¬Ø¨ ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Ø¯Ø§Ø®Ù„ Pi Browser"); }
}

function addMessage(text, role, pulse=false){
  const chatBox = document.getElementById('chat-box');
  const div = document.createElement('div');
  div.className = `message ${role}`;
  if(pulse) div.classList.add('pulse');
  div.innerText = text;
  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
}

async function askGemini() {
  if (userPoints <= 0) { updateUI(); return; }

  const input = document.getElementById('user-input');
  const userText = input.value.trim();
  if (!userText) return;
  addMessage(userText,"user");
  input.value = '';

  userPoints--;
  localStorage.setItem('chat_points', userPoints);
  updateUI();

  try {
    const res = await fetch('/api/gemini/chat',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({prompt:userText})
    });
    const data = await res.json();
    addMessage(data.reply,"ai");
  } catch(e){
    addMessage("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±.","ai");
  }
}
</script>
</body>
</html>
