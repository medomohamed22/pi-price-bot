<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³ÙˆØ¨Ø± Ø·Ù„Ø¨Ø§Øª | Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø©</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #6c5ce7;
            --dark: #4834d4;
            --bg: #f4f4fb;
            --white: #ffffff;
            --gray: #b2bec3;
        }

        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; transition: 0.3s; }
        body { background: var(--bg); margin: 0; padding: 0; display: flex; justify-content: center; }

        .app-shell {
            width: 100%;
            max-width: 500px;
            background: var(--white);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 30px rgba(0,0,0,0.1);
        }

        header {
            background: linear-gradient(135deg, var(--primary), var(--dark));
            color: white;
            padding: 35px 20px;
            text-align: center;
            border-bottom-left-radius: 40px;
            border-bottom-right-radius: 40px;
        }

        /* Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª */
        .tabs {
            display: flex;
            background: #eee;
            margin: -25px 40px 15px;
            border-radius: 50px;
            padding: 5px;
            z-index: 10;
        }
        .tab-btn {
            flex: 1; border: none; padding: 12px; border-radius: 50px;
            cursor: pointer; font-weight: bold; background: none; color: #666;
        }
        .tab-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(108, 92, 231, 0.3); }

        .container { padding: 20px; flex: 1; }
        .card { background: white; border: 1px solid #f0f0f0; border-radius: 25px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.02); }

        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªØªØ¨Ø¹ */
        .stepper {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            position: relative;
        }
        .step {
            flex: 1;
            text-align: center;
            font-size: 0.8rem;
            color: var(--gray);
            position: relative;
            z-index: 2;
        }
        .step.active { color: var(--primary); font-weight: bold; }
        .dot {
            width: 15px; height: 15px; background: #dfe6e9; border-radius: 50%;
            margin: 0 auto 8px; border: 3px solid #fff; box-shadow: 0 0 0 2px #dfe6e9;
        }
        .step.active .dot { background: var(--primary); box-shadow: 0 0 0 2px var(--primary); }

        /* Ø§Ù„Ø´Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø´Ø± */
        .chat-wrap {
            border: 2px solid #f1f2f6;
            border-radius: 20px;
            height: 300px;
            display: flex;
            flex-direction: column;
            background: #fcfcfc;
        }
        .chat-msgs { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .m { padding: 10px 15px; border-radius: 18px; max-width: 80%; font-size: 0.9rem; line-height: 1.4; }
        .m.c { background: var(--primary); color: white; align-self: flex-start; border-bottom-right-radius: 4px; } /* Ø§Ù„Ø¹Ù…ÙŠÙ„ */
        .m.d { background: #eee; color: #333; align-self: flex-end; border-bottom-left-radius: 4px; } /* Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ */

        .chat-in-box { display: flex; padding: 10px; gap: 8px; border-top: 1px solid #eee; }
        .chat-in-box input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 12px; outline: none; }
        .send-btn { background: var(--primary); color: white; border: none; padding: 0 20px; border-radius: 12px; cursor: pointer; }

        /* Ø£Ø²Ø±Ø§Ø± ÙˆØ­Ù‚ÙˆÙ„ */
        input, textarea { width: 100%; padding: 15px; border-radius: 15px; border: 2px solid #f1f2f6; margin-top: 10px; outline: none; }
        .btn { width: 100%; padding: 16px; border: none; border-radius: 18px; font-weight: 800; cursor: pointer; margin-top: 10px; }
        .btn-p { background: var(--primary); color: white; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="app-shell">
    <header>
        <h2 style="margin:0">Ø³ÙˆØ¨Ø± Ø·Ù„Ø¨Ø§Øª ğŸš€</h2>
        <p style="margin:5px 0 0; opacity:0.8; font-size:0.8rem;">ØªØªØ¨Ø¹ Ù„Ø­Ø¸ÙŠ ÙˆØ´Ø§Øª Ù…Ø¨Ø§Ø´Ø±</p>
    </header>

    <div class="tabs">
        <button class="tab-btn active" id="u-tab" onclick="switchPage('user')">Ø£Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†</button>
        <button class="tab-btn" id="d-tab" onclick="switchPage('delivery')">Ø£Ù†Ø§ Ù…Ù†Ø¯ÙˆØ¨</button>
    </div>

    <div class="container">
        <div id="page-user">
            <div class="card" id="user-form">
                <label>ğŸ“ Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªÙˆØµÙŠÙ„</label>
                <input type="text" id="u-addr" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„...">
                <label style="display:block; margin-top:15px;">ğŸ›’ Ù…Ø§Ø°Ø§ ØªØ±ÙŠØ¯ Ø£Ù† Ù†Ø´ØªØ±ÙŠØŸ</label>
                <textarea id="u-items" rows="3" placeholder="Ø§ÙƒØªØ¨ Ø·Ù„Ø¨Ø§ØªÙƒ Ù‡Ù†Ø§..."></textarea>
                <button class="btn btn-p" onclick="placeOrder()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨</button>
            </div>

            <div class="card hidden" id="user-tracking">
                <div class="stepper">
                    <div id="us-1" class="step"><div class="dot"></div>Ø¥Ø±Ø³Ø§Ù„</div>
                    <div id="us-2" class="step"><div class="dot"></div>ØªØ¬Ù‡ÙŠØ²</div>
                    <div id="us-3" class="step"><div class="dot"></div>ØªÙˆØµÙŠÙ„</div>
                </div>
                
                <div id="u-chat-area" class="hidden">
                    <h5 style="margin:0 0 10px">ğŸ’¬ Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¨Ø§Ø´Ø±Ø©</h5>
                    <div class="chat-wrap">
                        <div id="u-msgs" class="chat-msgs"></div>
                        <div class="chat-in-box">
                            <input type="text" id="u-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©...">
                            <button class="send-btn" onclick="sendMessage('c')">Ø¥Ø±Ø³Ø§Ù„</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="page-delivery" class="hidden">
            <div id="delivery-orders-list">
                <p style="text-align:center; color:#999; margin-top:50px;">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ Ù…Ù†Ø·Ù‚ØªÙƒ...</p>
            </div>

            <div class="card hidden" id="delivery-active-panel">
                <div class="stepper">
                    <div id="ds-1" class="step"><div class="dot"></div>Ø¥Ø±Ø³Ø§Ù„</div>
                    <div id="ds-2" class="step"><div class="dot"></div>ØªØ¬Ù‡ÙŠØ²</div>
                    <div id="ds-3" class="step"><div class="dot"></div>ØªÙˆØµÙŠÙ„</div>
                </div>
                <button class="btn btn-p" id="status-btn" onclick="updateStatus()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©: ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚</button>
                
                <div class="chat-wrap" style="margin-top:15px;">
                    <div id="d-msgs" class="chat-msgs"></div>
                    <div class="chat-in-box">
                        <input type="text" id="d-input" placeholder="Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¹Ù…ÙŠÙ„...">
                        <button class="send-btn" onclick="sendMessage('d')">Ø¥Ø±Ø³Ø§Ù„</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // ØªÙ‡ÙŠØ¦Ø© Supabase
    const SB_URL = 'https://xncapmzlwuisupkjlftb.supabase.co';
    const SB_KEY = 'sb_publishable_zPECXAiI_bDbeLtRYe3vIw_IEt_p_AS';
    const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

    let activeOrderId = null;
    let chatLog = [];

    // --- Ø§Ù„Ø¹Ù…ÙŠÙ„: ØªÙ‚Ø¯ÙŠÙ… Ø·Ù„Ø¨ ---
    async function placeOrder() {
        const addr = document.getElementById('u-addr').value;
        const items = document.getElementById('u-items').value;
        if(!addr || !items) return alert("Ø§ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹");

        const { data } = await supabaseClient.from('orders').insert([{
            address: addr, items: items, status: 1, chat_messages: []
        }]).select();

        if (data) {
            activeOrderId = data[0].id;
            document.getElementById('user-form').classList.add('hidden');
            document.getElementById('user-tracking').classList.remove('hidden');
            document.getElementById('us-1').classList.add('active');
            startRealtimeSync();
        }
    }

    // --- Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨: Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ ---
    async function loadAvailableOrders() {
        const { data } = await supabaseClient.from('orders').select('*').eq('status', 1);
        const list = document.getElementById('delivery-orders-list');
        list.innerHTML = data.length ? '' : '<p style="text-align:center; margin-top:50px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</p>';
        data.forEach(o => {
            list.innerHTML += `<div class="card">
                <p>ğŸ“¦ <strong>Ø§Ù„Ø·Ù„Ø¨:</strong> ${o.items}</p>
                <button class="btn btn-p" onclick="acceptByDelivery(${o.id})">Ù‚Ø¨ÙˆÙ„ ÙˆÙØªØ­ Ø§Ù„Ø´Ø§Øª</button>
            </div>`;
        });
    }

    async function acceptByDelivery(id) {
        activeOrderId = id;
        await supabaseClient.from('orders').update({ status: 2 }).eq('id', id);
        document.getElementById('delivery-orders-list').classList.add('hidden');
        document.getElementById('delivery-active-panel').classList.remove('hidden');
        startRealtimeSync();
    }

    async function updateStatus() {
        const { data } = await supabaseClient.from('orders').select('status').eq('id', activeOrderId).single();
        const nextStatus = data.status + 1;
        await supabaseClient.from('orders').update({ status: nextStatus }).eq('id', activeOrderId);
        if(nextStatus === 4) { alert("ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„! Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ."); location.reload(); }
    }

    // --- Ø§Ù„Ø±Ø¨Ø· Ø§Ù„Ù„Ø­Ø¸ÙŠ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ ---
    function startRealtimeSync() {
        supabaseClient.channel('sync_channel').on('postgres_changes', 
        { event: 'UPDATE', schema: 'public', table: 'orders', filter: `id=eq.${activeOrderId}` }, 
        (payload) => {
            const status = payload.new.status;
            chatLog = payload.new.chat_messages || [];
            
            // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªØªØ¨Ø¹ Ù„Ù„Ø¹Ù…ÙŠÙ„ ÙˆØ§Ù„Ù…Ù†Ø¯ÙˆØ¨
            for(let i=1; i<=3; i++) {
                if(document.getElementById(`us-${i}`)) document.getElementById(`us-${i}`).classList.toggle('active', i <= status);
                if(document.getElementById(`ds-${i}`)) document.getElementById(`ds-${i}`).classList.toggle('active', i <= status);
            }

            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø´Ø§Øª Ù„Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù…Ø¬Ø±Ø¯ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ (Ø­Ø§Ù„Ø© 2)
            if(status >= 2) document.getElementById('u-chat-area').classList.remove('hidden');
            
            // ØªØ­Ø¯ÙŠØ« Ù†Øµ Ø²Ø± Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨
            const btn = document.getElementById('status-btn');
            if(status === 2) btn.innerText = "ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©: ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚";
            if(status === 3) btn.innerText = "ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©: ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…";

            renderMessages();
        }).subscribe();
    }

    async function sendMessage(role) {
        const inputId = role === 'c' ? 'u-input' : 'd-input';
        const msgText = document.getElementById(inputId).value;
        if(!msgText) return;

        chatLog.push({ role: role, text: msgText });
        await supabaseClient.from('orders').update({ chat_messages: chatLog }).eq('id', activeOrderId);
        document.getElementById(inputId).value = '';
    }

    function renderMessages() {
        const html = chatLog.map(m => `<div class="m ${m.role}">${m.text}</div>`).join('');
        document.getElementById('u-msgs').innerHTML = html;
        document.getElementById('d-msgs').innerHTML = html;
        document.querySelectorAll('.chat-msgs').forEach(c => c.scrollTop = c.scrollHeight);
    }

    function switchPage(p) {
        document.getElementById('page-user').classList.toggle('hidden', p !== 'user');
        document.getElementById('page-delivery').classList.toggle('hidden', p !== 'delivery');
        document.getElementById('u-tab').classList.toggle('active', p === 'user');
        document.getElementById('d-tab').classList.toggle('active', p === 'delivery');
        if(p === 'delivery' && !activeOrderId) loadAvailableOrders();
    }
</script>
</body>
</html>
