<div class="card">
    <h2><i class="fas fa-clock"></i> طلبات السحب المعلقة</h2>
    <div id="withdrawal-requests-list">
        </div>
</div>

<script>
async function loadWithdrawalRequests() {
    const { data } = await _db.from('withdrawal_requests').select('*').eq('status', 'pending');
    const container = document.getElementById('withdrawal-requests-list');
    container.innerHTML = '';

    data.forEach(req => {
        container.innerHTML += `
            <div style="padding: 15px; border: 1px solid #eee; border-radius: 10px; margin-bottom: 10px; background: #fafafa;">
                <p><b>المستخدم:</b> ${req.username}</p>
                <p><b>المبلغ:</b> ${req.amount} π</p>
                <p style="word-break: break-all;"><b>المحفظة:</b> ${req.wallet_address}</p>
                <button class="btn" style="background:#00b894; margin-top:10px;" 
                    onclick="executeAppToUserPayout('${req.id}', '${req.wallet_address}', ${req.amount})">
                    تنفيذ التحويل الآن (App-to-User)
                </button>
            </div>
        `;
    });
}

// تنفيذ التحويل الفعلي من محفظة التطبيق للمستخدم
async function executeAppToUserPayout(requestId, address, amount) {
    try {
        const payment = await Pi.createPayment({
            amount: amount,
            memo: "سحب أرباح من جمعيتي",
            metadata: { requestId: requestId, wallet: address }
        }, {
            onReadyForServerApproval: (id) => { console.log("Approved:", id); },
            onReadyForServerCompletion: async (id, txid) => {
                // تحديث حالة الطلب في قاعدة البيانات بعد نجاح التحويل
                await _db.from('withdrawal_requests').update({ status: 'completed' }).eq('id', requestId);
                alert("تم التحويل بنجاح للمحفظة المذكورة!");
                loadWithdrawalRequests();
            }
        });
    } catch (e) {
        alert("خطأ في التحويل: " + e.message);
    }
}

window.onload = function() {
    loadCircles();
    loadWithdrawalRequests();
};
</script>
