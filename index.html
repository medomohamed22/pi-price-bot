<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Pi Elite Hub | Chat</title>

  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <style>
    :root {
      --bg: #030712; --card: rgba(17, 24, 39, 0.85); --stroke: rgba(255, 255, 255, 0.1);
      --primary: #8b5cf6; --accent: #22d3ee; --gold: #f59e0b;
      --text: #f9fafb; --muted: #9ca3af; --nav-h: 75px; --safe: env(safe-area-inset-bottom);
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
    body {
      margin: 0; color: var(--text); font-family: 'Segoe UI', system-ui, sans-serif;
      background: radial-gradient(circle at top left, #1e1b4b, #030712);
      min-height: 100vh; overflow-x: hidden; padding-bottom: calc(var(--nav-h) + 10px);
    }

    .glass { background: var(--card); border: 1px solid var(--stroke); backdrop-filter: blur(15px); }

    /* Header */
    .app-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 15px 20px; position: sticky; top: 0; z-index: 1000;
      background: rgba(3, 7, 18, 0.9); backdrop-filter: blur(10px); border-bottom: 1px solid var(--stroke);
    }

    /* Pages */
    .page { display: none; padding: 15px 15px 80px; animation: slideUp 0.3s ease; }
    .page.active { display: block; }
    @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Ads Grid */
    .ads-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
    .ad-card { border-radius: 16px; overflow: hidden; background: var(--card); border: 1px solid var(--stroke); position: relative; }
    .ad-card.promoted { border: 2px solid var(--gold); box-shadow: 0 0 15px rgba(245, 158, 11, 0.15); }
    .crown-badge { position: absolute; top: 8px; right: 8px; background: var(--gold); color: #000; padding: 3px 8px; border-radius: 6px; font-size: 10px; font-weight: 900; z-index: 5; }
    .ad-img { width: 100%; height: 140px; object-fit: cover; }
    .ad-body { padding: 10px; }
    .ad-price { font-size: 16px; font-weight: 800; color: var(--accent); }
    .ad-title { font-size: 13px; margin: 4px 0; height: 36px; overflow: hidden; }

    /* Buttons */
    .btn { width: 100%; padding: 12px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 13px; transition: 0.2s; }
    .btn-main { background: var(--primary); color: white; }
    .btn-gold { background: var(--gold); color: black; }
    .btn-outline { background: transparent; border: 1px solid var(--stroke); color: var(--text); }
    
    /* Inputs */
    input, textarea { width: 100%; background: rgba(255,255,255,0.05); border: 1px solid var(--stroke); padding: 12px; border-radius: 12px; color: white; margin-bottom: 10px; }

    /* --- Chat Styles --- */
    .chat-list-item {
        display: flex; align-items: center; gap: 12px; padding: 12px;
        background: var(--card); border-radius: 12px; margin-bottom: 10px;
        border: 1px solid var(--stroke); cursor: pointer;
    }
    .avatar { width: 40px; height: 40px; background: var(--primary); border-radius: 50%; display: grid; place-items: center; font-weight: bold; color: white; }
    
    .chat-container { display: flex; flex-direction: column; height: calc(100vh - 140px); }
    .messages-area { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px; }
    
    .msg-bubble { max-width: 75%; padding: 10px 14px; border-radius: 16px; font-size: 14px; line-height: 1.4; position: relative; word-wrap: break-word; }
    .msg-mine { align-self: flex-end; background: var(--primary); color: white; border-bottom-left-radius: 4px; }
    .msg-theirs { align-self: flex-start; background: rgba(255,255,255,0.1); color: white; border-bottom-right-radius: 4px; }
    .msg-time { font-size: 9px; opacity: 0.7; margin-top: 4px; text-align: right; }

    .chat-input-area {
        display: flex; gap: 8px; padding: 10px; background: #111;
        border-top: 1px solid var(--stroke); position: fixed; bottom: var(--nav-h); left: 0; right: 0;
    }

    /* Bottom Nav */
    .nav-bar {
      position: fixed; bottom: 0; left: 0; right: 0; height: calc(var(--nav-h) + var(--safe));
      background: rgba(10, 10, 15, 0.95); border-top: 1px solid var(--stroke);
      display: flex; align-items: center; justify-content: space-around; padding-bottom: var(--safe); z-index: 2000;
    }
    .nav-btn { background: none; border: none; color: var(--muted); display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 10px; flex: 1; }
    .nav-btn.active { color: var(--primary); }
    .nav-btn i { font-size: 20px; }

    /* Toast */
    #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 8px 16px; border-radius: 20px; font-size: 12px; z-index: 9999; display: none; border: 1px solid var(--primary); }
  </style>
</head>
<body>

  <div id="toast"></div>

  <header class="app-header">
    <div style="font-weight: 800; font-size: 18px;"><i class="fas fa-gem" style="color:var(--primary)"></i> Elite Hub</div>
    <div id="auth-ui"><button class="btn-main btn" style="padding: 6px 12px;" onclick="initPi()">دخول</button></div>
  </header>

  <main>
    <div id="page-home" class="page active">
      <div class="ads-grid" id="main-ads-list"></div>
    </div>

    <div id="page-add" class="page">
      <div class="glass" style="padding: 20px; border-radius: 16px;">
        <h3>بيع منتج جديد</h3>
        <input type="file" id="file-input" accept="image/*">
        <input type="text" id="title-input" placeholder="العنوان">
        <input type="number" id="price-input" placeholder="السعر (Pi)">
        <textarea id="desc-input" rows="3" placeholder="الوصف..."></textarea>
        <button class="btn btn-main" id="pub-btn" onclick="handleUpload()">نشر</button>
      </div>
    </div>

    <div id="page-inbox" class="page">
      <h3 style="margin: 0 0 15px;">الرسائل</h3>
      <div id="inbox-list">
        <div style="text-align:center; color:var(--muted); margin-top:50px;">جاري تحميل المحادثات...</div>
      </div>
    </div>

    <div id="page-chat" class="page" style="padding: 0; padding-bottom: 140px;">
      <div style="padding: 10px; background: rgba(0,0,0,0.5); border-bottom: 1px solid var(--stroke); display:flex; align-items:center; gap:10px;">
        <button onclick="switchNav('inbox')" style="background:none; border:none; color:white;"><i class="fas fa-arrow-right"></i></button>
        <span id="chat-header-name" style="font-weight:bold;">User</span>
      </div>
      <div id="chat-messages" class="messages-area"></div>
      <div class="chat-input-area">
        <input type="text" id="msg-input" placeholder="اكتب رسالة..." style="margin:0;">
        <button class="btn-main btn" style="width: 50px;" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
      </div>
    </div>

    <div id="page-profile" class="page">
      <div class="glass" style="padding:15px; border-radius:16px; margin-bottom:15px; text-align:center;">
        <i class="fas fa-user-circle fa-3x" style="color:var(--muted)"></i>
        <h3 id="profile-name">ضيف</h3>
      </div>
      <h4>إعلاناتي</h4>
      <div class="ads-grid" id="my-ads-list"></div>
    </div>
  </main>

  <nav class="nav-bar">
    <button class="nav-btn active" onclick="switchNav('home', this)"><i class="fas fa-store"></i><span>السوق</span></button>
    <button class="nav-btn" onclick="switchNav('inbox', this)"><i class="fas fa-comment-dots"></i><span>الرسائل</span></button>
    <button class="nav-btn" onclick="switchNav('add', this)"><i class="fas fa-plus-circle"></i><span>نشر</span></button>
    <button class="nav-btn" onclick="switchNav('profile', this)"><i class="fas fa-user"></i><span>حسابي</span></button>
  </nav>

  <script>
    let _sb = null;
    let _user = null;
    let _activeChatUser = null; // المستخدم الذي نحدثه حالياً
    let _chatSubscription = null;

    // --- 1. الإعداد الأولي ---
    window.onload = async () => {
      try {
        const res = await fetch('/api/config');
        const config = await res.json();
        _sb = supabase.createClient(config.SB_URL, config.SB_ANON);
        loadAllAds();
      } catch (e) { notify("خطأ اتصال"); }
    };

    async function initPi() {
      try {
        const Pi = window.Pi;
        Pi.init({ version: "2.0", sandbox: false });
        const auth = await Pi.authenticate(['username'], (p) => {});
        _user = auth.user;
        document.getElementById('auth-ui').innerHTML = `<span style="font-size:12px; font-weight:bold; color:var(--accent)">@${_user.username}</span>`;
        document.getElementById('profile-name').innerText = `@${_user.username}`;
        notify(`أهلاً ${_user.username}`);
        loadInbox(); // تحميل الرسائل عند الدخول
      } catch (e) { alert("افتح التطبيق من Pi Browser"); }
    }

    // --- 2. التنقل ---
    function switchNav(pageId, btn) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('page-' + pageId).classList.add('active');
      
      if(btn) {
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
      }

      if(pageId === 'home') loadAllAds();
      if(pageId === 'profile' && _user) loadMyAds();
      if(pageId === 'inbox') {
          if(_user) loadInbox();
          else { notify("سجل دخول أولاً"); switchNav('home'); }
      }
      // إغلاق اشتراك الشات إذا خرجنا من صفحة الشات
      if(pageId !== 'chat' && _chatSubscription) {
          _chatSubscription.unsubscribe();
          _chatSubscription = null;
      }
    }

    // --- 3. نظام الإعلانات ---
    async function loadAllAds() {
      if(!_sb) return;
      const { data } = await _sb.from('ads').select('*').order('created_at', {ascending: false});
      renderAds(data || [], 'main-ads-list', false);
    }
    
    async function loadMyAds() {
      const { data } = await _sb.from('ads').select('*').eq('seller_username', _user.username);
      renderAds(data || [], 'my-ads-list', true);
    }

    function renderAds(list, containerId, isOwner) {
      const container = document.getElementById(containerId);
      const now = new Date();
      list.sort((a,b) => (b.promoted_until && new Date(b.promoted_until)>now) - (a.promoted_until && new Date(a.promoted_until)>now));

      container.innerHTML = list.map(ad => {
        const isPromoted = ad.promoted_until && new Date(ad.promoted_until) > now;
        return `
          <div class="ad-card ${isPromoted ? 'promoted' : ''}">
            ${isPromoted ? '<div class="crown-badge"><i class="fas fa-crown"></i></div>' : ''}
            <img class="ad-img" src="${_sb.storageUrl}/object/public/ads-images/${ad.image_url}" onerror="this.src='https://via.placeholder.com/150'">
            <div class="ad-body">
              <div class="ad-price">${ad.price} Pi</div>
              <div class="ad-title">${ad.title}</div>
              ${isOwner 
                ? `<button class="btn btn-gold" style="padding:6px; font-size:11px" onclick="promoteAd('${ad.id}')">تمييز (5 Pi)</button>`
                : `<button class="btn btn-outline" style="padding:6px; font-size:11px; width:100%" onclick="openChatWith('${ad.seller_username}')"><i class="fas fa-comment"></i> تواصل</button>`
              }
            </div>
          </div>`;
      }).join('');
    }

    async function handleUpload() {
        // (نفس كود الرفع السابق بالضبط)
        // ... (اختصاراً للمساحة، استخدم الكود من الردود السابقة هنا)
        if(!_user) return notify("سجل دخول أولاً");
        const file = document.getElementById('file-input').files[0];
        const title = document.getElementById('title-input').value;
        const price = document.getElementById('price-input').value;
        const desc = document.getElementById('desc-input').value;
        if(!file || !title) return notify("أكمل البيانات");
        
        document.getElementById('pub-btn').innerText = "...";
        try {
            const fileName = `${Date.now()}_${_user.username}.${file.name.split('.').pop()}`;
            await _sb.storage.from('ads-images').upload(fileName, file);
            await _sb.from('ads').insert([{title, price:parseFloat(price), description:desc, image_url:fileName, seller_username:_user.username}]);
            notify("تم النشر"); switchNav('home');
        } catch(e) { alert(e.message); }
        document.getElementById('pub-btn').innerText = "نشر";
    }

    // --- 4. نظام الشات المطور ---

    // A. عرض قائمة المحادثات (Inbox)
    async function loadInbox() {
      if(!_user) return;
      const listDiv = document.getElementById('inbox-list');
      listDiv.innerHTML = '<div style="text-align:center; padding:20px;">تحميل...</div>';

      // جلب كل الرسائل التي أنا طرف فيها
      const { data, error } = await _sb.from('messages')
        .select('*')
        .or(`sender_username.eq.${_user.username},receiver_username.eq.${_user.username}`)
        .order('created_at', {ascending: false});

      if(error || !data) { listDiv.innerHTML = "لا توجد رسائل"; return; }

      // استخراج قائمة المستخدمين الفريدين الذين تحدثت معهم
      const contacts = new Set();
      const conversations = [];
      
      data.forEach(msg => {
        const otherUser = msg.sender_username === _user.username ? msg.receiver_username : msg.sender_username;
        if(!contacts.has(otherUser)) {
          contacts.add(otherUser);
          conversations.push({ user: otherUser, lastMsg: msg });
        }
      });

      if(conversations.length === 0) {
          listDiv.innerHTML = '<div style="text-align:center; margin-top:50px; color:#666;">لا توجد محادثات بعد</div>';
          return;
      }

      listDiv.innerHTML = conversations.map(c => `
        <div class="chat-list-item" onclick="openChatWith('${c.user}')">
          <div class="avatar">${c.user[0].toUpperCase()}</div>
          <div style="flex:1;">
            <div style="font-weight:bold; font-size:14px;">@${c.user}</div>
            <div style="font-size:12px; color:var(--muted); overflow:hidden; white-space:nowrap; text-overflow:ellipsis; max-width:200px;">
              ${c.lastMsg.sender_username === _user.username ? 'أنت: ' : ''}${c.lastMsg.content}
            </div>
          </div>
          <div style="font-size:10px; color:var(--muted);">${new Date(c.lastMsg.created_at).toLocaleDateString()}</div>
        </div>
      `).join('');
    }

    // B. فتح محادثة مع شخص معين
    async function openChatWith(targetUser) {
      if(!_user) return notify("سجل دخول أولاً");
      if(targetUser === _user.username) return notify("لا يمكنك محادثة نفسك");

      _activeChatUser = targetUser;
      document.getElementById('chat-header-name').innerText = `@${targetUser}`;
      
      // التبديل للصفحة وتفريغ المحتوى القديم
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('page-chat').classList.add('active');
      document.getElementById('chat-messages').innerHTML = '<div style="text-align:center; padding:20px;">جاري تحميل المحادثة...</div>';

      // جلب الرسائل السابقة
      await fetchMessages();
      
      // الاشتراك في التحديثات اللحظية
      subscribeToChat();
    }

    async function fetchMessages() {
      const { data } = await _sb.from('messages')
        .select('*')
        .or(`and(sender_username.eq.${_user.username},receiver_username.eq.${_activeChatUser}),and(sender_username.eq.${_activeChatUser},receiver_username.eq.${_user.username})`)
        .order('created_at', {ascending: true});
      
      renderChatMessages(data || []);
    }

    function renderChatMessages(msgs) {
      const area = document.getElementById('chat-messages');
      area.innerHTML = msgs.map(m => {
        const isMine = m.sender_username === _user.username;
        const time = new Date(m.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        return `
          <div class="msg-bubble ${isMine ? 'msg-mine' : 'msg-theirs'}">
            ${m.content}
            <div class="msg-time">${time}</div>
          </div>
        `;
      }).join('');
      // التمرير للأسفل
      area.scrollTop = area.scrollHeight;
    }

    // C. إرسال رسالة
    async function sendMessage() {
      const input = document.getElementById('msg-input');
      const text = input.value.trim();
      if(!text || !_activeChatUser) return;

      input.value = ''; // تفريغ الحقل فوراً لتجربة المستخدم

      // إرسال لـ Supabase
      const { error } = await _sb.from('messages').insert([{
        sender_username: _user.username,
        receiver_username: _activeChatUser,
        content: text
      }]);

      if(error) {
          notify("فشل الإرسال");
          input.value = text; // إعادة النص
      }
      // لا نحتاج لإضافة الرسالة يدوياً هنا، لأن الـ Subscription سيلتقطها
    }

    // D. الاستماع اللحظي (Realtime)
    function subscribeToChat() {
      if(_chatSubscription) _chatSubscription.unsubscribe();

      _chatSubscription = _sb.channel('public:messages')
        .on('postgres_changes', { 
          event: 'INSERT', 
          schema: 'public', 
          table: 'messages',
          filter: `receiver_username=eq.${_user.username}` // أسمع للرسائل القادمة لي
        }, (payload) => {
           if(payload.new.sender_username === _activeChatUser) {
             appendMessage(payload.new);
           } else {
             notify(`رسالة جديدة من @${payload.new.sender_username}`);
           }
        })
        .on('postgres_changes', { 
          event: 'INSERT', 
          schema: 'public', 
          table: 'messages',
          filter: `sender_username=eq.${_user.username}` // أسمع للرسائل التي أرسلها أنا (لتظهر فوراً)
        }, (payload) => {
           if(payload.new.receiver_username === _activeChatUser) {
             appendMessage(payload.new);
           }
        })
        .subscribe();
    }

    function appendMessage(msg) {
      const area = document.getElementById('chat-messages');
      const isMine = msg.sender_username === _user.username;
      const time = new Date(msg.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      
      const div = document.createElement('div');
      div.className = `msg-bubble ${isMine ? 'msg-mine' : 'msg-theirs'}`;
      div.innerHTML = `${msg.content}<div class="msg-time">${time}</div>`;
      
      area.appendChild(div);
      area.scrollTop = area.scrollHeight;
    }

    // --- أدوات مساعدة ---
    function notify(msg) {
      const t = document.getElementById('toast');
      t.innerText = msg; t.style.display = 'block';
      setTimeout(()=>t.style.display='none', 3000);
    }

    // دوال الدفع (موجودة في الأكواد السابقة، أضفها هنا إذا احتجت زر التمييز)
    async function promoteAd(adId) { /* ... نفس دالة promoteAd السابقة ... */ }
  </script>
</body>
</html>
