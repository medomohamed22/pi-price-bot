<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Pi Elite Hub | 2026</title>

  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <style>
    :root{
      --bg:#070A16; --bg2:#0b1226;
      --card:rgba(255,255,255,.07); --stroke:rgba(255,255,255,.12);
      --primary:#7c3aed; --primary2:#a855f7; --accent:#00f2fe; --gold: #f59e0b;
      --text:#ffffff; --muted:#a7b0c3;
      --r:22px; --nav-h: 76px; --safe: env(safe-area-inset-bottom);
    }

    *{box-sizing:border-box; -webkit-tap-highlight-color:transparent; outline:none;}
    body{
      margin:0; color:var(--text); font-family: system-ui, -apple-system, sans-serif;
      background: radial-gradient(900px 500px at 80% -10%, rgba(124,58,237,.35), transparent 60%),
                  linear-gradient(180deg, var(--bg), var(--bg2));
      min-height: 100vh; overflow-x:hidden;
    }

    .glass{ background: var(--card); border: 1px solid var(--stroke); backdrop-filter: blur(16px); border-radius: var(--r); }

    .page{ display:none; padding: 16px 14px calc(var(--nav-h) + 20px + var(--safe)); min-height:100vh; animation: fade .3s ease; }
    .page.active{ display:block; }
    @keyframes fade{ from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:translateY(0)} }

    .topbar{ position: sticky; top:0; z-index: 50; padding: 14px 20px; background: rgba(7, 10, 22, 0.8); backdrop-filter: blur(15px); display:flex; align-items:center; justify-content:space-between; border-bottom: 1px solid var(--stroke); }
    .brand-title{ font-weight: 900; font-size: 18px; color: var(--text); }
    .brand-title i{ color: var(--accent); margin-left: 5px; }

    .login-btn{ display:inline-flex; align-items:center; gap:8px; padding: 8px 16px; border-radius: 999px; border: 1px solid var(--stroke); background: rgba(255,255,255,.06); color: white; font-weight: 700; cursor:pointer; }

    .ads-grid{ display:grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
    .ad-card{ overflow:hidden; position: relative; transition: 0.2s; display:flex; flex-direction:column; }
    .ad-card.promoted { border: 1px solid var(--gold); box-shadow: 0 0 15px rgba(245, 158, 11, 0.2); }
    .badge-gold { position: absolute; top:8px; right:8px; background:var(--gold); color:#000; font-size:10px; padding:4px 8px; border-radius:8px; font-weight:800; z-index:2; }

    .ad-thumb{ width:100%; aspect-ratio: 4/3; object-fit: cover; }
    .ad-body{ padding: 12px; flex:1; display:flex; flex-direction:column; gap:5px; }
    .price{ font-weight: 900; font-size: 16px; color: var(--accent); }
    .ad-title{ font-size: 13px; opacity: 0.9; height: 38px; overflow:hidden; }

    .btn-main{ width:100%; padding: 14px; border:none; border-radius: 16px; color: white; font-weight: 800; background: linear-gradient(135deg, var(--primary), var(--primary2)); cursor:pointer; }
    .btn-outline{ width:100%; padding: 8px; border-radius: 12px; background: rgba(255,255,255,0.05); border:1px solid var(--stroke); color:white; font-size:12px; cursor:pointer; margin-top:5px; }
    .btn-gold { width:100%; padding: 8px; border-radius: 12px; background: var(--gold); border:none; color:black; font-weight:bold; font-size:12px; cursor:pointer; margin-top:5px; }

    .chat-container{ height: calc(100vh - 200px); overflow-y:auto; padding: 15px; display:flex; flex-direction:column; gap: 10px; }
    .bubble{ max-width: 80%; padding: 10px 14px; border-radius: 18px; font-size: 14px; line-height: 1.4; }
    .bubble.me{ align-self: flex-end; background: var(--primary); color: white; border-bottom-left-radius: 4px; }
    .bubble.them{ align-self: flex-start; background: rgba(255,255,255,.1); color: white; border-bottom-right-radius: 4px; }

    .chat-input-area{ position: fixed; bottom: var(--nav-h); left:0; right:0; padding:12px; background: var(--bg); border-top: 1px solid var(--stroke); display:flex; gap:10px; }
    .chat-input-area input{ flex:1; background: rgba(255,255,255,0.05); border: 1px solid var(--stroke); padding: 12px; border-radius: 99px; color: white; }

    .tab-bar{ position: fixed; bottom:0; left:0; right:0; height: var(--nav-h); background: rgba(7,10,22,.95); border-top: 1px solid var(--stroke); display:flex; align-items:center; z-index: 1000; padding-bottom: var(--safe); }
    .tab-item{ flex:1; border:none; background:none; color: var(--muted); display:flex; flex-direction:column; align-items:center; gap:4px; font-size: 11px; cursor:pointer; }
    .tab-item.active{ color: var(--accent); }
    .tab-item i{ font-size: 20px; }

    #toast{ position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.9); color: white; padding: 10px 20px; border-radius: 50px; font-size: 13px; z-index: 9999; display: none; border: 1px solid var(--primary); }
  </style>
</head>
<body>

  <div id="toast"></div>

  <div id="page-home" class="page active">
    <div class="topbar">
      <div class="brand-title"><i class="fas fa-gem"></i> Elite Hub</div>
      <div id="auth-area"><button class="login-btn" onclick="initPi()"><i class="fas fa-wallet"></i> دخول</button></div>
    </div>
    <div class="ads-grid" id="main-ads-list"></div>
  </div>

  <div id="page-add" class="page">
    <div class="topbar"><div class="brand-title">بيع منتج</div></div>
    <div class="glass" style="padding: 20px;">
      <input type="file" id="file-input" style="margin-bottom:15px; color:var(--muted);">
      <input type="text" id="title-input" placeholder="عنوان الإعلان" style="width:100%; padding:12px; margin-bottom:10px; border-radius:12px; background:rgba(0,0,0,0.2); border:1px solid var(--stroke); color:white;">
      <input type="number" id="price-input" placeholder="السعر بـ Pi" style="width:100%; padding:12px; margin-bottom:10px; border-radius:12px; background:rgba(0,0,0,0.2); border:1px solid var(--stroke); color:white;">
      <textarea id="desc-input" placeholder="وصف المنتج..." style="width:100%; padding:12px; margin-bottom:15px; border-radius:12px; background:rgba(0,0,0,0.2); border:1px solid var(--stroke); color:white; height:100px;"></textarea>
      <button class="btn-main" id="pub-btn" onclick="handleUpload()">نشر الإعلان</button>
    </div>
  </div>

  <div id="page-inbox" class="page">
    <div class="topbar"><div class="brand-title">المحادثات</div></div>
    <div id="inbox-list"></div>
  </div>

  <div id="page-chat" class="page" style="padding:0;">
    <div class="topbar">
      <div style="display:flex; align-items:center; gap:10px;">
        <i class="fas fa-chevron-right" onclick="switchNav('inbox')"></i>
        <span id="chat-user-name">...</span>
      </div>
    </div>
    <div id="chat-messages" class="chat-container"></div>
    <div class="chat-input-area">
      <input type="text" id="msg-input" placeholder="اكتب هنا...">
      <button onclick="sendMessage()" style="background:var(--accent); border:none; width:45px; height:45px; border-radius:50%;"><i class="fas fa-paper-plane"></i></button>
    </div>
  </div>

  <div id="page-profile" class="page">
    <div class="topbar"><div class="brand-title">حسابي</div></div>
    <div id="my-ads-list" class="ads-grid"></div>
  </div>

  <div class="tab-bar">
    <button class="tab-item active" onclick="switchNav('home', this)"><i class="fas fa-th-large"></i><span>السوق</span></button>
    <button class="tab-item" onclick="switchNav('inbox', this)"><i class="fas fa-comment"></i><span>الرسائل</span></button>
    <button class="tab-item" onclick="switchNav('add', this)"><i class="fas fa-plus-circle"></i><span>بيع</span></button>
    <button class="tab-item" onclick="switchNav('profile', this)"><i class="fas fa-user"></i><span>حسابي</span></button>
  </div>

  <script>
    let _sb = null, _user = null, _activeChat = null, _sub = null;

    window.onload = async () => {
      const res = await fetch('/api/config');
      const config = await res.json();
      _sb = supabase.createClient(config.SB_URL, config.SB_ANON);
      loadAllAds();
    };

    async function initPi() {
      try {
        const Pi = window.Pi;
        Pi.init({ version: "2.0", sandbox: false });
        const auth = await Pi.authenticate(['username'], (p) => {});
        _user = auth.user;
        document.getElementById('auth-area').innerHTML = `<div class="login-btn">@${_user.username}</div>`;
        notify("أهلاً بك!");
        loadInbox();
      } catch (e) { alert("افتح من Pi Browser"); }
    }

    function switchNav(id, btn) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('page-'+id).classList.add('active');
      if(btn) {
        document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
        btn.classList.add('active');
      }
      if(id === 'home') loadAllAds();
      if(id === 'profile' && _user) loadMyAds();
      if(id === 'inbox' && _user) loadInbox();
    }

    async function loadAllAds() {
      const { data } = await _sb.from('ads').select('*').order('created_at', {ascending: false});
      renderAds(data || [], 'main-ads-list', false);
    }

    async function loadMyAds() {
      const { data } = await _sb.from('ads').select('*').eq('seller_username', _user.username);
      renderAds(data || [], 'my-ads-list', true);
    }

    function renderAds(list, divId, isOwner) {
      const container = document.getElementById(divId);
      const now = new Date();
      list.sort((a,b) => (b.promoted_until && new Date(b.promoted_until)>now) - (a.promoted_until && new Date(a.promoted_until)>now));

      container.innerHTML = list.map(ad => {
        const isP = ad.promoted_until && new Date(ad.promoted_until) > now;
        return `
          <div class="glass ad-card ${isP ? 'promoted' : ''}">
            ${isP ? '<div class="badge-gold">مميز</div>' : ''}
            <img class="ad-thumb" src="${_sb.storageUrl}/object/public/ads-images/${ad.image_url}">
            <div class="ad-body">
              <div class="price">${ad.price} Pi</div>
              <div class="ad-title">${ad.title}</div>
              ${isOwner 
                ? `<button class="btn-gold" onclick="promoteAd('${ad.id}')">تمييز الإعلان</button>`
                : `<button class="btn-outline" onclick="openChat('${ad.seller_username}')">تواصل</button>`
              }
            </div>
          </div>`;
      }).join('');
    }

    async function handleUpload() {
      if(!_user) return notify("سجل دخول أولاً");
      const file = document.getElementById('file-input').files[0];
      const title = document.getElementById('title-input').value;
      const price = document.getElementById('price-input').value;
      if(!file || !title || !price) return notify("أكمل البيانات");

      document.getElementById('pub-btn').innerText = "...";
      const name = Date.now() + '_' + _user.username;
      await _sb.storage.from('ads-images').upload(name, file);
      await _sb.from('ads').insert([{ title, price, image_url: name, seller_username: _user.username }]);
      notify("تم النشر"); switchNav('home');
    }

    // --- نظام الشات المحدث ---
    async function loadInbox() {
      const { data } = await _sb.from('messages').select('*').or(`sender_username.eq.${_user.username},receiver_username.eq.${_user.username}`).order('created_at', {ascending:false});
      const contacts = [...new Set(data.map(m => m.sender_username === _user.username ? m.receiver_username : m.sender_username))];
      
      document.getElementById('inbox-list').innerHTML = contacts.map(c => `
        <div class="glass" onclick="openChat('${c}')" style="padding:15px; margin-bottom:10px; display:flex; align-items:center; gap:12px;">
          <div style="width:40px; height:40px; border-radius:50%; background:var(--primary); display:grid; place-items:center;">${c[0].toUpperCase()}</div>
          <div><b>@${c}</b><br><small style="color:var(--muted)">اضغط لفتح المحادثة</small></div>
        </div>
      `).join('');
    }

    async function openChat(target) {
      if(!_user) return notify("سجل دخول");
      if(target === _user.username) return;
      _activeChat = target;
      document.getElementById('chat-user-name').innerText = "@" + target;
      switchNav('chat');
      
      const { data } = await _sb.from('messages').select('*').or(`and(sender_username.eq.${_user.username},receiver_username.eq.${target}),and(sender_username.eq.${target},receiver_username.eq.${_user.username})`).order('created_at', {ascending:true});
      renderMessages(data || []);
      setupRealtime();
    }

    function renderMessages(msgs) {
      const area = document.getElementById('chat-messages');
      area.innerHTML = msgs.map(m => `<div class="bubble ${m.sender_username === _user.username ? 'me' : 'them'}">${m.content}</div>`).join('');
      area.scrollTop = area.scrollHeight;
    }

    async function sendMessage() {
      const inp = document.getElementById('msg-input');
      const val = inp.value.trim();
      if(!val) return;
      inp.value = '';
      await _sb.from('messages').insert([{ sender_username: _user.username, receiver_username: _activeChat, content: val }]);
    }

    function setupRealtime() {
      if(_sub) _sb.removeChannel(_sub);
      _sub = _sb.channel('chat').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
        const m = payload.new;
        if((m.sender_username === _user.username && m.receiver_username === _activeChat) || (m.sender_username === _activeChat && m.receiver_username === _user.username)) {
          const area = document.getElementById('chat-messages');
          area.innerHTML += `<div class="bubble ${m.sender_username === _user.username ? 'me' : 'them'}">${m.content}</div>`;
          area.scrollTop = area.scrollHeight;
        }
      }).subscribe();
    }

    // --- نظام الدفع المحدث ---
    async function promoteAd(adId) {
      if(!_user) return;
      notify("فتح المحفظة...");
      try {
        await Pi.createPayment({
          amount: 5.0, memo: `PROMOTE|${adId}`, metadata: { adId }
        }, {
          onReadyForServerApproval: (pid) => fetch('/api/approve', {method:'POST', body:JSON.stringify({paymentId:pid})}),
          onReadyForServerCompletion: (pid, txid) => fetch('/api/complete', {method:'POST', body:JSON.stringify({paymentId:pid, txid})}).then(() => { notify("تم التمييز!"); loadAllAds(); }),
          onCancel: () => {},
          onError: (e) => alert(e.message)
        });
      } catch(e) {}
    }

    function notify(m) {
      const t = document.getElementById('toast'); t.innerText = m; t.style.display = 'block';
      setTimeout(() => t.style.display='none', 3000);
    }
  </script>
</body>
</html>
