<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini AI - Pi Network</title>
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <style>
        :root { --main-color: #6a0dad; --bg-color: #f4f4f9; --ai-msg: #e9e9eb; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg-color); margin: 0; display: flex; align-items: center; justify-content: center; height: 100vh; }
        
        .chat-container { width: 100%; max-width: 450px; height: 90vh; background: white; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); display: flex; flex-direction: column; overflow: hidden; position: relative; }
        
        .header { background: var(--main-color); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .points-badge { background: #ffd700; color: #333; padding: 5px 12px; border-radius: 15px; font-size: 14px; }
        
        #chat-box { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background: #fafafa; }
        .msg { padding: 10px 15px; border-radius: 15px; max-width: 80%; font-size: 15px; line-height: 1.4; }
        .user { background: var(--main-color); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .ai { background: var(--ai-msg); color: #333; align-self: flex-start; border-bottom-left-radius: 2px; }
        
        .input-area { padding: 15px; border-top: 1px solid #eee; display: flex; gap: 10px; background: white; }
        input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 25px; outline: none; }
        button#send-btn { background: var(--main-color); color: white; border: none; padding: 0 20px; border-radius: 25px; cursor: pointer; transition: 0.3s; }
        button:disabled { background: #ccc; }

        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ù†ÙØ§Ø° Ø§Ù„Ù†Ù‚Ø§Ø· */
        .pay-overlay { position: absolute; inset: 0; background: rgba(255,255,255,0.96); display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; z-index: 10; padding: 20px; }
        .pay-overlay h2 { color: var(--main-color); margin-bottom: 10px; }
        .pay-btn { background: #6a0dad; color: white; border: none; padding: 15px 30px; border-radius: 30px; font-size: 18px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

<div class="chat-container">
    <div class="header">
        <span>Gemini AI Chat</span>
        <div class="points-badge">âš¡ Ø§Ù„Ù†Ù‚Ø§Ø·: <span id="points-count">0</span></div>
    </div>
    
    <div id="chat-box">
        <div class="msg ai">Ù…Ø±Ø­Ø¨Ø§Ù‹! Ù„Ø¯ÙŠÙƒ 5 Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù…Ø¬Ø§Ù†ÙŠØ© Ù„Ù„ØªØ­Ø¯Ø« Ù…Ø¹ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ. Ø§Ø³Ø£Ù„Ù†ÙŠ Ø£ÙŠ Ø´ÙŠØ¡!</div>
    </div>

    <div id="pay-overlay" class="pay-overlay">
        <h2>Ø§Ù†ØªÙ‡Øª Ù†Ù‚Ø§Ø·Ùƒ! ğŸ’</h2>
        <p>ÙŠÙ…ÙƒÙ†Ùƒ Ø´Ø­Ù† <b>20 Ù†Ù‚Ø·Ø©</b> Ù…Ù‚Ø§Ø¨Ù„ <b>1 Pi</b> ÙÙ‚Ø· Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©.</p>
        <button class="pay-btn" onclick="handlePiPayment()">Ø§Ø´Ø­Ù† Ø§Ù„Ø¢Ù† Ø¨ÙˆØ§Ø³Ø·Ø© Pi</button>
        <p style="font-size: 12px; color: #666; margin-top: 15px;">ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø¯Ø§Ø®Ù„ Ù…ØªØµÙØ­ Pi Ù„ØªØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø¯ÙØ¹.</p>
    </div>

    <div class="input-area">
        <input type="text" id="user-input" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§...">
        <button id="send-btn" onclick="askGemini()">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>
</div>

<script>
    // 1. ØªÙ‡ÙŠØ¦Ø© Pi SDK
    const Pi = window.Pi;
    Pi.init({ version: "2.0" });

    // 2. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ù‚Ø§Ø· (LocalStorage)
    let userPoints = localStorage.getItem('chat_points');
    if (userPoints === null) {
        userPoints = 5; // Ù†Ù‚Ø§Ø· Ù…Ø¬Ø§Ù†ÙŠØ© Ù„Ù„Ù…Ø±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
        localStorage.setItem('chat_points', userPoints);
    } else {
        userPoints = parseInt(userPoints);
    }

    function updateUI() {
        document.getElementById('points-count').innerText = userPoints;
        const overlay = document.getElementById('pay-overlay');
        const sendBtn = document.getElementById('send-btn');
        const userInput = document.getElementById('user-input');

        if (userPoints <= 0) {
            overlay.style.display = 'flex';
            sendBtn.disabled = true;
            userInput.disabled = true;
        } else {
            overlay.style.display = 'none';
            sendBtn.disabled = false;
            userInput.disabled = false;
        }
    }
    updateUI();

    // 3. ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªØ­Ø¯Ø« Ù…Ø¹ Gemini
    async function askGemini() {
        const input = document.getElementById('user-input');
        const text = input.value.trim();
        if (!text || userPoints <= 0) return;

        appendMessage('user', text);
        input.value = '';
        const sendBtn = document.getElementById('send-btn');
        sendBtn.disabled = true;

        try {
            const response = await fetch('/api/gemini/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: text })
            });

            if (response.ok) {
                const data = await response.json();
                appendMessage('ai', data.reply);
                
                // Ø®ØµÙ… Ù†Ù‚Ø·Ø© ÙˆØ­ÙØ¸ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯
                userPoints--;
                localStorage.setItem('chat_points', userPoints);
                updateUI();
            } else {
                appendMessage('ai', 'Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø¯.');
            }
        } catch (error) {
            appendMessage('ai', 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±. ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹.');
        } finally {
            sendBtn.disabled = false;
        }
    }

    function appendMessage(role, text) {
        const chatBox = document.getElementById('chat-box');
        const msgDiv = document.createElement('div');
        msgDiv.className = `msg ${role}`;
        msgDiv.innerText = text;
        chatBox.appendChild(msgDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    // 4. ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø¯ÙØ¹ Ø¹Ø¨Ø± Pi Network
    async function handlePiPayment() {
        try {
            // Ø·Ù„Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª
            const user = await Pi.authenticate(['username', 'payments']);
            
            const paymentData = {
                amount: 1,
                memo: "Ø´Ø­Ù† 20 Ù†Ù‚Ø·Ø© Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ",
                metadata: { points: 20 }
            };

            const callbacks = {
                onReadyForServerApproval: async (paymentId) => {
                    await fetch('/api/pi/approve', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ paymentId })
                    });
                },
                onReadyForServerCompletion: async (paymentId, txid) => {
                    const res = await fetch('/api/pi/complete', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ paymentId, txid })
                    });
                    if (res.ok) {
                        userPoints += 20; // Ø¥Ø¶Ø§ÙØ© 20 Ù†Ù‚Ø·Ø© Ø¨Ø¹Ø¯ Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¯ÙØ¹
                        localStorage.setItem('chat_points', userPoints);
                        updateUI();
                        alert("ØªÙ… Ø´Ø­Ù† 20 Ù†Ù‚Ø·Ø© Ø¨Ù†Ø¬Ø§Ø­! Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ.");
                    }
                },
                onCancel: (paymentId) => { console.log("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¯ÙØ¹"); },
                onError: (error, payment) => { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¯ÙØ¹: " + error.message); },
            };

            Pi.createPayment(paymentData, callbacks);
        } catch (err) {
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£: ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¯Ø§Ø®Ù„ Pi Browser.");
        }
    }
</script>

</body>
</html>
