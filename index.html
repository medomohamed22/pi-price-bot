<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Pi Elite Hub | 2026</title>

  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <style>
    :root {
      --bg: #030712;
      --card: rgba(17, 24, 39, 0.75);
      --stroke: rgba(255, 255, 255, 0.1);
      --primary: #8b5cf6;
      --primary-glow: rgba(139, 92, 246, 0.4);
      --accent: #22d3ee;
      --gold: #f59e0b;
      --text: #f9fafb;
      --muted: #9ca3af;
      --nav-h: 75px;
      --safe: env(safe-area-inset-bottom);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
    
    body {
      margin: 0; color: var(--text); font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at top left, #1e1b4b, #030712);
      min-height: 100vh; overflow-x: hidden;
    }

    .glass { background: var(--card); border: 1px solid var(--stroke); backdrop-filter: blur(15px); }

    /* Header */
    .app-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 15px 20px; position: sticky; top: 0; z-index: 1000;
      border-bottom: 1px solid var(--stroke); background: rgba(3, 7, 18, 0.85);
      backdrop-filter: blur(10px);
    }

    .logo-box { display: flex; align-items: center; gap: 10px; font-weight: 800; font-size: 20px; }
    .logo-box i { color: var(--primary); text-shadow: 0 0 10px var(--primary-glow); }

    /* Pages Navigation */
    .page { display: none; padding: 20px 16px calc(var(--nav-h) + 40px + var(--safe)); animation: slideUp 0.4s ease; }
    .page.active { display: block; }
    @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

    /* Ads System */
    .ads-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
    .ad-card { border-radius: 20px; overflow: hidden; background: var(--card); border: 1px solid var(--stroke); position: relative; transition: 0.3s; }
    .ad-card.promoted { border: 2.5px solid var(--gold); box-shadow: 0 0 20px rgba(245, 158, 11, 0.2); }
    
    .crown-badge {
      position: absolute; top: 10px; right: 10px; background: var(--gold);
      color: #000; padding: 4px 8px; border-radius: 8px; font-size: 10px; font-weight: 900; z-index: 5;
    }

    .ad-img { width: 100%; height: 150px; object-fit: cover; background: #111; }
    .ad-body { padding: 12px; }
    .ad-price { font-size: 19px; font-weight: 900; color: var(--accent); margin-bottom: 4px; }
    .ad-title { font-size: 13px; opacity: 0.9; height: 35px; overflow: hidden; line-height: 1.4; }

    /* Forms & Buttons */
    .btn {
      width: 100%; padding: 14px; border: none; border-radius: 15px;
      font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
      transition: 0.2s; font-size: 14px;
    }
    .btn-main { background: linear-gradient(135deg, var(--primary), #6d28d9); color: white; }
    .btn-gold { background: var(--gold); color: #000; }
    .btn:active { transform: scale(0.97); }

    input, textarea {
      width: 100%; background: rgba(255,255,255,0.05); border: 1px solid var(--stroke);
      padding: 14px; border-radius: 15px; color: white; margin-bottom: 12px;
    }

    /* Bottom Nav */
    .nav-bar {
      position: fixed; bottom: 0; left: 0; right: 0; height: calc(var(--nav-h) + var(--safe));
      background: rgba(17, 24, 39, 0.95); border-top: 1px solid var(--stroke);
      display: flex; align-items: center; justify-content: space-around; padding-bottom: var(--safe);
    }
    .nav-btn { background: none; border: none; color: var(--muted); display: flex; flex-direction: column; align-items: center; gap: 5px; flex: 1; font-size: 11px; }
    .nav-btn.active { color: var(--primary); }
    .nav-btn i { font-size: 22px; }

    /* Toast Notification */
    #toast {
      position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
      background: rgba(0,0,0,0.9); border: 1px solid var(--primary); color: white;
      padding: 10px 25px; border-radius: 30px; font-size: 13px; z-index: 9999; display: none;
    }
  </style>
</head>
<body>

  <div id="toast"></div>

  <header class="app-header">
    <div class="logo-box"><i class="fas fa-gem"></i> Elite Hub</div>
    <div id="auth-section">
      <button class="btn-main btn" style="padding: 7px 15px; border-radius: 10px;" onclick="initPi()">Ø¯Ø®ÙˆÙ„</button>
    </div>
  </header>

  <main>
    <div id="page-home" class="page active">
      <div class="ads-grid" id="main-ads-list"></div>
    </div>

    <div id="page-add" class="page">
      <div class="glass" style="padding: 20px; border-radius: 25px;">
        <h3 style="margin-top:0">Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù† Ø¬Ø¯ÙŠØ¯</h3>
        <input type="file" id="file-input" accept="image/*">
        <input type="text" id="title-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
        <input type="number" id="price-input" placeholder="Ø§Ù„Ø³Ø¹Ø± Ø¨Ù€ Pi">
        <textarea id="desc-input" rows="4" placeholder="ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬..."></textarea>
        <button class="btn btn-main" id="publish-btn" onclick="handleUpload()">
          <i class="fas fa-plus"></i> Ù†Ø´Ø± Ø§Ù„Ø¢Ù†
        </button>
      </div>
    </div>

    <div id="page-profile" class="page">
      <div class="glass" style="padding: 15px; border-radius: 20px; margin-bottom: 20px; text-align: center;" id="user-info-card">
        <i class="fas fa-user-circle fa-3x" style="color: var(--muted);"></i>
        <p>ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø¹Ø±Ø¶ Ø¥Ø¹Ù„Ø§Ù†Ø§ØªÙƒ</p>
      </div>
      <h4 style="margin-bottom: 15px;">Ø¥Ø¹Ù„Ø§Ù†Ø§ØªÙŠ</h4>
      <div class="ads-grid" id="my-ads-list"></div>
    </div>
  </main>

  <nav class="nav-bar">
    <button class="nav-btn active" onclick="switchNav('home', this)"><i class="fas fa-store"></i>Ø§Ù„Ø³ÙˆÙ‚</button>
    <button class="nav-btn" onclick="switchNav('add', this)"><i class="fas fa-plus-circle"></i>Ù†Ø´Ø±</button>
    <button class="nav-btn" onclick="switchNav('profile', this)"><i class="fas fa-user"></i>Ø­Ø³Ø§Ø¨ÙŠ</button>
  </nav>

  <script>
    let _supabase = null;
    let _user = null;

    // 1. Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªØ´ØºÙŠÙ„ ÙˆØ¬Ù„Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    window.onload = async () => {
      try {
        const res = await fetch('/api/config');
        const config = await res.json();
        _supabase = supabase.createClient(config.SB_URL, config.SB_ANON);
        loadAllAds();
      } catch (e) { notify("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±", "#ef4444"); }
    };

    // 2. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Pi
    async function initPi() {
      try {
        const Pi = window.Pi;
        Pi.init({ version: "2.0", sandbox: false });
        const auth = await Pi.authenticate(['username'], (p) => {});
        _user = auth.user;
        
        document.getElementById('auth-section').innerHTML = `<span style="font-size:12px; font-weight:bold;">@${_user.username}</span>`;
        document.getElementById('user-info-card').innerHTML = `<h3>@${_user.username}</h3><p>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Pi Elite Hub</p>`;
        notify("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„!");
      } catch (e) { alert("ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ù† Pi Browser"); }
    }

    // 3. Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„ØµÙØ­Ø§Øª
    function switchNav(id, btn) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('page-' + id).classList.add('active');
      btn.classList.add('active');
      
      if(id === 'home') loadAllAds();
      if(id === 'profile' && _user) loadMyAds();
    }

    // 4. Ø¬Ù„Ø¨ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    async function loadAllAds() {
      if(!_supabase) return;
      const { data } = await _supabase.from('ads').select('*').order('created_at', {ascending: false});
      renderAds(data || [], 'main-ads-list', false);
    }

    async function loadMyAds() {
      const { data } = await _supabase.from('ads').select('*').eq('seller_username', _user.username);
      renderAds(data || [], 'my-ads-list', true);
    }

    function renderAds(list, gridId, isOwner) {
      const grid = document.getElementById(gridId);
      const now = new Date();
      
      // ØªØ±ØªÙŠØ¨: Ø§Ù„Ù…Ù…ÙŠØ² ÙŠØ¸Ù‡Ø± Ø£ÙˆÙ„Ø§Ù‹
      list.sort((a,b) => {
        const aP = a.promoted_until && new Date(a.promoted_until) > now;
        const bP = b.promoted_until && new Date(b.promoted_until) > now;
        return bP - aP;
      });

      grid.innerHTML = list.map(ad => {
        const isPromoted = ad.promoted_until && new Date(ad.promoted_until) > now;
        return `
          <div class="ad-card ${isPromoted ? 'promoted' : ''}">
            ${isPromoted ? '<div class="crown-badge"><i class="fas fa-crown"></i> Ù…Ù…ÙŠØ²</div>' : ''}
            <img class="ad-img" src="${_supabase.storageUrl}/object/public/ads-images/${ad.image_url}" onerror="this.src='https://via.placeholder.com/200'">
            <div class="ad-body">
              <div class="ad-price">${ad.price} Pi</div>
              <div class="ad-title">${ad.title}</div>
              ${isOwner ? `<button class="btn btn-gold" style="margin-top:10px; font-size:11px; padding:8px;" onclick="startPromotion('${ad.id}')">ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† (5 Pi)</button>` : ''}
            </div>
          </div>`;
      }).join('');
    }

    // 5. Ø±ÙØ¹ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª
    async function handleUpload() {
      if(!_user) return notify("Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹", "#f59e0b");
      
      const file = document.getElementById('file-input').files[0];
      const title = document.getElementById('title-input').value;
      const price = document.getElementById('price-input').value;
      const desc = document.getElementById('desc-input').value;

      if(!file || !title || !price) return notify("Ø£ÙƒÙ…Ù„ ÙƒØ§ÙØ© Ø§Ù„Ø­Ù‚ÙˆÙ„", "#f59e0b");

      const btn = document.getElementById('publish-btn');
      btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...';

      try {
        const fileName = `${Date.now()}_${_user.username}.${file.name.split('.').pop()}`;
        const { error: upErr } = await _supabase.storage.from('ads-images').upload(fileName, file);
        if(upErr) throw upErr;

        const { error: dbErr } = await _supabase.from('ads').insert([{
          title, price: parseFloat(price), description: desc,
          image_url: fileName, seller_username: _user.username
        }]);
        if(dbErr) throw dbErr;

        notify("âœ… ØªÙ… Ø§Ù„Ù†Ø´Ø± Ø¨Ù†Ø¬Ø§Ø­!");
        switchNav('home', document.querySelector('.nav-btn'));
      } catch (e) { notify("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø±ÙØ¹", "#ef4444"); }
      finally { btn.disabled = false; btn.innerHTML = '<i class="fas fa-plus"></i> Ù†Ø´Ø± Ø§Ù„Ø¢Ù†'; }
    }

    // 6. Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯ÙØ¹ ÙˆØ§Ù„ØªÙ…ÙŠÙŠØ² (Ù…Ø¹ ÙƒØ§Ø´Ù Ø§Ù„Ø£Ø®Ø·Ø§Ø¡)
    async function startPromotion(adId) {
      if(!_user) return;
      notify("Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©...");
      
      try {
        await Pi.createPayment({
          amount: 5.0,
          memo: `PROMOTE_AD|${adId}`, // Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„Ø³ÙŠØ±ÙØ±
          metadata: { adId: adId, username: _user.username },
        }, {
          onReadyForServerApproval: async (paymentId) => {
            const res = await fetch('/api/pi/approve', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({ paymentId })
            });
            const info = await res.json();
            if(!res.ok) {
                alert("Ø®Ø·Ø£ ÙÙŠ Ù…Ø±Ø­Ù„Ø© Approval:\n" + JSON.stringify(info));
                throw new Error("Approve Failed");
            }
            return info;
          },
          onReadyForServerCompletion: async (paymentId, txid) => {
            const res = await fetch('/api/pi/complete', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({ paymentId, txid })
            });
            const info = await res.json();
            if(!res.ok) {
                alert("Ø®Ø·Ø£ ÙÙŠ Ù…Ø±Ø­Ù„Ø© Completion:\n" + JSON.stringify(info));
                throw new Error("Complete Failed");
            }
            notify("ğŸš€ ØªÙ… ØªÙ…ÙŠÙŠØ² Ø¥Ø¹Ù„Ø§Ù†Ùƒ!");
            loadAllAds();
            return info;
          },
          onCancel: () => notify("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¯ÙØ¹", "#6b7280"),
          onError: (err) => alert("Ø®Ø·Ø£ Ù…Ù† Ù…Ø­ÙØ¸Ø© Pi:\n" + err.message)
        });
      } catch (e) { console.error(e); }
    }

    function notify(msg, bg = "#8b5cf6") {
      const t = document.getElementById('toast');
      t.textContent = msg; t.style.background = bg;
      t.style.display = 'block';
      setTimeout(() => t.style.display = 'none', 3000);
    }
  </script>
</body>
</html>
