<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pi Dev Hub</title>

<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://sdk.minepi.com/pi-sdk.js"></script>

<style>
:root{
  --p:#7B2FF7;--p2:#9B6DFF;--bg:#F4F0FF;--card:#fff;
  --text:#1F1F2E;--mut:#6B6B85;--border:#E6E0FF;
  --shadow:0 8px 24px rgba(123,47,247,.12);
  --r:16px;
}
*{box-sizing:border-box;font-family:Tajawal,system-ui}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);padding-bottom:84px}

header{
  position:sticky;top:0;z-index:9;
  background:#fff;border-bottom:1px solid var(--border);
  padding:12px 14px;display:flex;gap:10px;align-items:center
}
header h1{margin:0;font-size:18px;color:var(--p);white-space:nowrap}
header input{flex:1;padding:10px;border-radius:12px;border:1px solid var(--border);outline:none}
header input:focus{border-color:rgba(123,47,247,.5);box-shadow:0 0 0 3px rgba(123,47,247,.12)}
header button{padding:10px 14px;border-radius:12px;border:none;background:var(--p);color:#fff;cursor:pointer}
header button:disabled{opacity:.55;cursor:not-allowed}
.headerRow{display:flex;gap:10px;align-items:center;flex:1}
.headerActions{display:flex;gap:8px;align-items:center}
.chip{
  display:inline-flex;align-items:center;gap:8px;
  padding:8px 10px;border-radius:999px;
  border:1px solid var(--border);background:#fff;color:var(--text);
  box-shadow:0 4px 14px rgba(123,47,247,.08);
  font-size:13px;white-space:nowrap
}
.chip .dot{width:8px;height:8px;border-radius:99px;background:var(--mut)}
.chip.ok .dot{background:#29c36a}

main{padding:14px;max-width:1100px;margin:0 auto}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
@media (max-width:520px){
  header{padding:10px 10px}
  header h1{font-size:16px}
  .grid{grid-template-columns:1fr}
  main{padding:10px}
}

.card{
  background:var(--card);border-radius:var(--r);padding:14px;
  box-shadow:var(--shadow);border:1px solid rgba(230,224,255,.85)
}
.card h3{margin:0 0 8px;color:var(--p);font-size:16px}
.mut{color:var(--mut);font-size:13px}
.tags{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px}
.tag{
  font-size:12px;padding:6px 10px;border-radius:999px;
  background:rgba(123,47,247,.10);color:var(--p);border:1px solid rgba(123,47,247,.18);
  cursor:pointer;user-select:none
}
.row{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-top:10px}
.actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.iconBtn{
  border:1px solid var(--border);background:#fff;color:var(--text);
  padding:8px 10px;border-radius:12px;cursor:pointer
}
.iconBtn:hover{border-color:rgba(123,47,247,.35)}
.primaryBtn{
  border:none;background:var(--p);color:#fff;padding:10px 12px;border-radius:12px;cursor:pointer
}
.primaryBtn:hover{filter:brightness(.98)}
.hidden{display:none}

nav{
  position:fixed;bottom:0;left:0;right:0;z-index:8;
  background:#fff;border-top:1px solid var(--border);
  display:flex;justify-content:space-around;padding:8px
}
nav button{background:none;border:none;color:var(--mut);cursor:pointer;padding:10px 8px;border-radius:12px}
nav button.active{color:var(--p);font-weight:700;background:rgba(123,47,247,.07)}

.toast{
  position:fixed;top:14px;left:14px;right:14px;z-index:99;
  display:none;align-items:center;justify-content:space-between;gap:10px;
  background:#fff;border:1px solid var(--border);box-shadow:var(--shadow);
  padding:12px 14px;border-radius:14px
}
.toast.show{display:flex}
.toast b{color:var(--p)}
.toast .x{cursor:pointer;border:none;background:none;font-size:18px;color:var(--mut)}

.modalWrap{
  position:fixed;inset:0;z-index:98;
  background:rgba(31,31,46,.35);
  display:none;align-items:center;justify-content:center;padding:16px
}
.modalWrap.show{display:flex}
.modal{
  width:min(560px,100%);
  background:#fff;border-radius:18px;border:1px solid var(--border);
  box-shadow:0 20px 60px rgba(31,31,46,.25);
  padding:14px
}
.modalHead{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
.modalHead h2{margin:0;font-size:16px;color:var(--p)}
.closeBtn{border:none;background:none;font-size:20px;color:var(--mut);cursor:pointer}
.field{display:flex;flex-direction:column;gap:6px;margin:10px 0}
.field label{font-size:13px;color:var(--mut)}
.field input,.field textarea{
  border:1px solid var(--border);border-radius:12px;padding:10px;outline:none;background:#fff
}
.field textarea{min-height:110px;resize:vertical}
.help{font-size:12px;color:var(--mut);margin-top:6px}
.footerBtns{display:flex;gap:8px;justify-content:flex-start;margin-top:10px;flex-wrap:wrap}
.skel{
  height:110px;border-radius:16px;background:linear-gradient(90deg,#fff, #f3edff, #fff);
  border:1px solid var(--border);box-shadow:0 8px 24px rgba(123,47,247,.08);
  animation:sh 1.2s infinite linear
}
@keyframes sh{0%{background-position:0 0}100%{background-position:800px 0}}

hr{border:none;border-top:1px solid var(--border);margin:12px 0}
.small{font-size:12px}
.badge{
  display:inline-flex;align-items:center;gap:6px;
  padding:6px 10px;border-radius:999px;
  border:1px solid rgba(123,47,247,.18);
  background:rgba(123,47,247,.08);
  color:var(--p);font-size:12px
}

/* Floating + */
.fab{
  position:fixed;left:14px;bottom:84px;z-index:95;
  width:54px;height:54px;border-radius:999px;border:none;
  background:var(--p);color:#fff;font-size:28px;line-height:0;
  box-shadow:0 16px 40px rgba(123,47,247,.28);
  cursor:pointer;display:none
}
.fab:active{transform:scale(.98)}
.fabMenu{
  position:fixed;left:14px;bottom:144px;z-index:95;
  display:none;flex-direction:column;gap:10px
}
.fabItem{
  display:flex;align-items:center;gap:10px;
  background:#fff;border:1px solid var(--border);
  padding:10px 12px;border-radius:14px;box-shadow:var(--shadow);
  cursor:pointer;min-width:170px
}
.fabItem b{color:var(--p)}
.fabBackdrop{position:fixed;inset:0;z-index:94;background:transparent;display:none}

/* Chat UI */
.chatWrap{display:grid;grid-template-columns:1fr;gap:12px}
.chatBox{
  height:54vh;min-height:320px;max-height:560px;
  border:1px solid var(--border);border-radius:16px;background:#fff;
  box-shadow:var(--shadow);
  display:flex;flex-direction:column;overflow:hidden
}
.chatMsgs{padding:12px;overflow:auto;display:flex;flex-direction:column;gap:10px}
.bubble{
  max-width:80%;padding:10px 12px;border-radius:14px;border:1px solid var(--border);
  background:#fff;line-height:1.7
}
.bubble.me{margin-right:auto;background:rgba(123,47,247,.08);border-color:rgba(123,47,247,.18)}
.bubble .who{font-size:12px;color:var(--mut);margin-bottom:4px}
.bubble img{max-width:100%;border-radius:12px;border:1px solid var(--border);display:block;margin-top:8px}
.chatSend{
  border-top:1px solid var(--border);
  padding:10px;display:flex;gap:8px;align-items:center
}
.chatSend input[type="text"]{
  flex:1;border:1px solid var(--border);border-radius:12px;padding:10px;outline:none
}
.fileBtn{
  border:1px solid var(--border);background:#fff;border-radius:12px;padding:10px;cursor:pointer
}
.fileBtn input{display:none}

/* âœ… Comments modal: fixed height + scroll list (mobile friendly) */
.cList{
  max-height:42vh;
  overflow:auto;
  padding-right:4px;
}
@media (max-width:520px){
  .cList{max-height:46vh}
}
.cItem{
  padding:10px;border:1px solid var(--border);border-radius:12px;
  margin:8px 0;background:#fff
}

/* âœ… Code cards */
.codeCard{
  border:1px solid var(--border);
  border-radius:14px;
  background:#fff;
  box-shadow:var(--shadow);
  padding:12px;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.codeHead{
  display:flex;align-items:center;justify-content:space-between;gap:10px
}
.codeTitle{font-weight:900;color:var(--p)}
..codeBox{
  direction:ltr;
  font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size:12px;
  line-height:1.6;

  /* âœ… Ø£Ù‡Ù… ØªØ¹Ø¯ÙŠÙ„: Ù„Ù Ø§Ù„Ø³Ø·ÙˆØ± Ø¨Ø¯Ù„ Ù…Ø§ ØªÙƒØ³Ø± Ø§Ù„Ø´Ø§Ø´Ø© */
  white-space: pre-wrap;        /* ÙŠØ­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ù€ enter + ÙŠØ¹Ù…Ù„ wrap */
  overflow-wrap: anywhere;      /* ÙŠÙƒØ³Ø± Ø§Ù„ÙƒÙ„Ù…Ø§Øª/Ø§Ù„Ø³Ù„Ø§Ø³Ù„ Ø§Ù„Ø·ÙˆÙŠÙ„Ø© */
  word-break: break-word;       /* Ø¯Ø¹Ù… Ø¥Ø¶Ø§ÙÙŠ Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */

  /* âœ… Ù…Ø§ ÙŠØ®Ù„ÙŠØ´ Ø§Ù„Ø¨Ù„ÙˆÙƒ ÙŠØ·Ù„Ø¹ Ø¨Ø±Ø© */
  max-width: 100%;
  min-width: 0;
  overflow-x: auto;             /* Ù„Ùˆ ÙƒÙˆØ¯ Ù…Ø³ØªØ­ÙŠÙ„ ÙŠØªÙ„Ù Ø²ÙŠ base64 Ù‡ØªÙ‚Ø¯Ø± ØªØ³Ø­Ø¨ */
  -webkit-overflow-scrolling: touch;

  border:1px solid var(--border);
  background:#faf8ff;
  border-radius:12px;
  padding:10px;
  max-height:220px;
}
.iconBtn{
  font-size:13px;
  padding:6px 12px;
  min-width:56px;
  text-align:center;
  .copyBtn{
  direction: rtl;        /* ÙŠØ®Ù„ÙŠ Ø§Ù„ÙƒÙ„Ù…Ø© Ø¹Ø±Ø¨ÙŠØ© Ù…Ø¸Ø¨ÙˆØ·Ø© */
  unicode-bidi: isolate; /* ÙŠØ¹Ø²Ù„Ù‡Ø§ Ø¹Ù† Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù„ÙŠ Ø¬Ù†Ø¨Ù‡Ø§ */
  white-space: nowrap;
  min-width: 56px;
  text-align: center;
}
</style>
</head>

<body>
<div class="toast" id="toast">
  <span id="toastText"></span>
  <button class="x" onclick="hideToast()">Ã—</button>
</div>

<header>
  <h1>Pi Dev Hub</h1>
  <div class="headerRow">
    <input id="search" placeholder="Ø¨Ø­Ø«..." />
    <div class="headerActions">
      <span class="chip" id="userChip">
        <span class="dot"></span>
        <span id="userChipText">Ø¶ÙŠÙ</span>
      </span>
      <button id="loginBtn">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ </button>
      <!-- âœ… logout removed -->
    </div>
  </div>
</header>

<main>
  <!-- ØµÙØ­Ø§Øª -->
  <section id="home" class="grid page"></section>
  <section id="projects" class="grid hidden page"></section>

  <!-- âœ… Group page -->
  <section id="group" class="hidden page">
    <div class="card">
      <div class="row" style="margin-top:0">
        <div>
          <h3 style="margin:0" id="groupTitle">Ø¬Ø±ÙˆØ¨ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</h3>
          <div class="mut" id="groupSub">Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ + Ù…Ø´Ø§Ø±ÙƒØ© ØµÙˆØ±</div>
        </div>
        <div class="actions">
          <button class="iconBtn" onclick="leaveGroup()">Ù…ØºØ§Ø¯Ø±Ø©</button>
          <button class="iconBtn" onclick="show('projects', document.querySelector('[data-tab=projects]'))">Ø±Ø¬ÙˆØ¹</button>
        </div>
      </div>

      <hr />

      <div class="chatWrap">
        <div class="chatBox">
          <div class="chatMsgs" id="chatMsgs"></div>

          <div class="chatSend">
            <label class="fileBtn" title="Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØ±Ø©">
              ğŸ“
              <input id="imgInput" type="file" accept="image/*" />
            </label>

            <input id="msgText" type="text" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." />
            <button class="primaryBtn" onclick="sendMessage()">Ø¥Ø±Ø³Ø§Ù„</button>
          </div>

          <div class="help">
            âœ… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± ÙŠØªÙ… Ø¹Ù„Ù‰ Supabase Storage Bucket: <b>project_uploads</b>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- âœ… Codes page -->
  <section id="codes" class="hidden page">
    <div class="card" style="margin-bottom:14px">
      <h3 style="margin:0 0 6px">Ø£ÙƒÙˆØ§Ø¯ Pi</h3>
      <div class="mut">Ù‚Ø³Ù… Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ + Ø²Ø± Ù†Ø³Ø®. (Ø§Ù„Ø£Ø¯Ù…Ù†: <b>medomohamed22</b>)</div>
    </div>

    <div class="card" style="margin-bottom:14px">
      <h3 style="margin:0 0 6px;color:#7B2FF7">Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø£Ø¯Ù…Ù† â­</h3>
      <div class="mut">Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø±Ø³Ù…ÙŠØ© Ù…Ù†: <b>medomohamed22</b></div>
    </div>
    <section id="codesAdminGrid" class="grid"></section>

    <div class="card" style="margin:14px 0">
      <h3 style="margin:0 0 6px;color:#7B2FF7">Ø£ÙƒÙˆØ§Ø¯ Ø£Ø®Ø±Ù‰ ğŸŒ</h3>
      <div class="mut">Ù…Ø³Ø§Ù‡Ù…Ø§Øª Ø§Ù„Ù…Ø¬ØªÙ…Ø¹</div>
    </div>
    <section id="codesOtherGrid" class="grid"></section>
  </section>
</main>

<nav>
  <button data-tab="home" class="active" onclick="show('home', this)">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
  <button data-tab="projects" onclick="show('projects', this)">Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</button>
  <button data-tab="codes" onclick="show('codes', this)">Ø£ÙƒÙˆØ§Ø¯ Pi</button>
</nav>

<!-- Floating + -->
<div class="fabBackdrop" id="fabBackdrop" onclick="toggleFab(false)"></div>
<button class="fab" id="fabBtn" title="Ø¥Ø¶Ø§ÙØ©" onclick="toggleFab()">+</button>

<div class="fabMenu" id="fabMenu">
  <div class="fabItem" onclick="toggleFab(false); openCreatePost()">
    <span>ğŸ“</span>
    <div><b>Ø¥Ø¶Ø§ÙØ© Ø¨ÙˆØ³Øª</b><div class="mut small">Ù†Ù‚Ø§Ø´ + Ù„Ø§ÙŠÙƒ + ÙƒÙˆÙ…Ù†Øª</div></div>
  </div>

  <div class="fabItem" onclick="toggleFab(false); openCreateProject()">
    <span>ğŸ‘¥</span>
    <div><b>Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø±ÙˆØ¹</b><div class="mut small">Ø¬Ø±ÙˆØ¨ Ø´Ø§Øª Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©</div></div>
  </div>

  <div class="fabItem" id="addCodeItem" onclick="toggleFab(false); openCreateCode()" style="display:none">
    <span>ğŸ’¾</span>
    <div><b>Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ¯</b><div class="mut small">Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·</div></div>
  </div>
</div>

<!-- Modals -->
<div class="modalWrap" id="modalWrap" onclick="overlayClose(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modalHead">
      <h2 id="modalTitle">Modal</h2>
      <button class="closeBtn" onclick="closeModal()">Ã—</button>
    </div>
    <div id="modalBody"></div>
  </div>
</div>

<script>
const SUPABASE_URL="https://xncapmzlwuisupkjlftb.supabase.co";
const SUPABASE_ANON="sb_publishable_zPECXAiI_bDbeLtRYe3vIw_IEt_p_AS";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

const ADMIN_PI_USERNAME = "medomohamed22";

let piUser = null;
let isVerified = false;
let authUid = null;

let activeProject = null;
let activeProjectSub = null;

let state = {
  posts: [],
  projects: [],
  likesByPost: new Map(),
  commentsCount: new Map(),
  myMemberProjects: new Set(),
  codes: [],
  activeTag: null,
  q: ""
};

// ====== âœ… Realtime channels ======
let rt = { posts:null, comments:null, projects:null, codes:null };

// ====== UI ======
function escapeHtml(s){
  return String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
function toast(msg, ok=true){
  const el=document.getElementById('toast');
  if(!el) return;
  const textEl = document.getElementById('toastText');
  if(textEl){
    textEl.innerHTML = ok ? `<b>âœ”</b> ${escapeHtml(msg)}` : `<b>âš </b> ${escapeHtml(msg)}`;
  }
  el.classList.add('show');
  clearTimeout(window.__t);
  window.__t=setTimeout(()=>hideToast(), 2500);
}
function hideToast(){
  const el=document.getElementById('toast');
  if(el) el.classList.remove('show');
}
function openModal(title, innerHtml){
  const t = document.getElementById('modalTitle');
  const b = document.getElementById('modalBody');
  const w = document.getElementById('modalWrap');
  if(!t || !b || !w) return;

  t.textContent = title;
  b.innerHTML = innerHtml;
  w.classList.add('show');

  setTimeout(()=>{
    const first = document.querySelector('#modalBody input, #modalBody textarea');
    if(first) first.focus();
  }, 0);
}
function closeModal(){
  window.__openCommentsPostId = null; // âœ… Ù…Ù‡Ù…
  const w=document.getElementById('modalWrap');
  if(w) w.classList.remove('show');
}
function overlayClose(e){ if(e.target.id === 'modalWrap') closeModal(); }
window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeModal(); });

function setSkeleton(containerId, count=6){
  const c=document.getElementById(containerId);
  if(!c) return;
  c.innerHTML = new Array(count).fill(0).map(()=>`<div class="skel"></div>`).join('');
}

// ====== FAB ======
function toggleFab(force){
  const menu = document.getElementById('fabMenu');
  const back = document.getElementById('fabBackdrop');
  if(!menu || !back) return;
  const show = (typeof force === 'boolean') ? force : (menu.style.display !== 'flex');
  menu.style.display = show ? 'flex' : 'none';
  back.style.display = show ? 'block' : 'none';
}

// ====== Auth ======
async function ensureSession(){
  const { data } = await sb.auth.getSession();
  if(!data?.session){
    const r = await sb.auth.signInAnonymously();
    if(r.error) throw r.error;
  }
  const sess = await sb.auth.getSession();
  return sess.data.session;
}
async function refreshAuthUid(){
  const { data, error } = await sb.auth.getUser();
  if(error) throw error;
  authUid = data?.user?.id || null;
  return authUid;
}
function isAdmin(){
  return !!(isVerified && piUser?.username && piUser.username === ADMIN_PI_USERNAME);
}
function setUIAuthed(){
  const chip = document.getElementById('userChip');
  const chipText = document.getElementById('userChipText');
  const loginBtn = document.getElementById('loginBtn');
  const fabBtn = document.getElementById('fabBtn');
  const addCodeItem = document.getElementById('addCodeItem');

  if(isVerified && piUser?.username){
    chip?.classList.add('ok');
    if(chipText) chipText.textContent = piUser.username;
    loginBtn?.classList.add('hidden');
    if(fabBtn) fabBtn.style.display = 'block';
    if(addCodeItem) addCodeItem.style.display = 'flex'; // âœ… ÙƒÙ„ Ø§Ù„Ù†Ø§Ø³ ØªÙ‚Ø¯Ø± ØªØ¶ÙŠÙ ÙƒÙˆØ¯
  }else{
    chip?.classList.remove('ok');
    if(chipText) chipText.textContent = 'Ø¶ÙŠÙ';
    loginBtn?.classList.remove('hidden');
    if(fabBtn) fabBtn.style.display = 'none';
    if(addCodeItem) addCodeItem.style.display = 'none';
    toggleFab(false);
  }
}

// ====== âœ… FIX: show pages ÙÙ‚Ø· + renderCodes ØµØ­ ======
function show(id, btn){
  if(id !== 'group') stopProjectRealtime();

  document.querySelectorAll('main .page').forEach(s=>s.classList.add('hidden'));
  const sec = document.getElementById(id);
  if(sec) sec.classList.remove('hidden');

  document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');

  if(id === 'codes') renderCodes(); // âœ… Ø¨Ø¯Ù„ `renderCode`()
}

// ====== Helpers (prevent duplicates) ======
function unshiftUnique(list, row){
  if(!row?.id) return;
  if(list.some(x => x.id === row.id)) return;
  list.unshift(row);
}
function removeById(list, id){
  if(!id) return list;
  return list.filter(x => x.id !== id);
}

// ====== âœ… Realtime (posts/projects/codes/comments) ======
function stopRealtime(){
  Object.values(rt).forEach(ch=>{
    if(ch) sb.removeChannel(ch);
  });
  rt = { posts:null, comments:null, projects:null, codes:null };
}

function startRealtime(){
  stopRealtime();

  // âœ… posts
  rt.posts = sb.channel('rt_posts')
    .on('postgres_changes', { event:'INSERT', schema:'public', table:'posts' }, (payload)=>{
      unshiftUnique(state.posts, payload.new);
      renderPosts();
    })
    .on('postgres_changes', { event:'DELETE', schema:'public', table:'posts' }, (payload)=>{
      const id = payload.old?.id;
      state.posts = removeById(state.posts, id);
      renderPosts();
    })
    .subscribe();

  // âœ… projects
  rt.projects = sb.channel('rt_projects')
    .on('postgres_changes', { event:'INSERT', schema:'public', table:'projects' }, (payload)=>{
      unshiftUnique(state.projects, payload.new);
      renderProjects();
    })
    .on('postgres_changes', { event:'DELETE', schema:'public', table:'projects' }, (payload)=>{
      const id = payload.old?.id;
      state.projects = removeById(state.projects, id);
      renderProjects();
    })
    .subscribe();

  // âœ… codes
  rt.codes = sb.channel('rt_codes')
    .on('postgres_changes', { event:'INSERT', schema:'public', table:'pi_codes' }, (payload)=>{
      unshiftUnique(state.codes, payload.new);
      renderCodes();
    })
    .on('postgres_changes', { event:'DELETE', schema:'public', table:'pi_codes' }, (payload)=>{
      const id = payload.old?.id;
      state.codes = removeById(state.codes, id);
      renderCodes();
    })
    .subscribe();

  // âœ… comments (update counter + refresh modal if open)
  rt.comments = sb.channel('rt_comments')
    .on('postgres_changes', { event:'INSERT', schema:'public', table:'post_comments' }, (payload)=>{
      const postId = payload.new?.post_id;
      if(!postId) return;
      state.commentsCount.set(postId, (state.commentsCount.get(postId)||0) + 1);
      renderPosts();
      if(window.__openCommentsPostId === postId) openComments(postId);
    })
    .on('postgres_changes', { event:'DELETE', schema:'public', table:'post_comments' }, (payload)=>{
      const postId = payload.old?.post_id;
      if(!postId) return;
      state.commentsCount.set(postId, Math.max(0, (state.commentsCount.get(postId)||1) - 1));
      renderPosts();
      if(window.__openCommentsPostId === postId) openComments(postId);
    })
    .subscribe();
}

// ====== Load ======
async function loadAll(){
  setSkeleton('home', 6);
  setSkeleton('projects', 6);

  const adminGrid = document.getElementById('codesAdminGrid');
  const otherGrid = document.getElementById('codesOtherGrid');
  if(adminGrid) adminGrid.innerHTML = new Array(2).fill(0).map(()=>`<div class="skel"></div>`).join('');
  if(otherGrid) otherGrid.innerHTML = new Array(4).fill(0).map(()=>`<div class="skel"></div>`).join('');

  const [postsR, projectsR, likesR, commentsR, membersR, codesR] = await Promise.all([
    sb.from('posts').select('*').order('created_at',{ascending:false}),
    sb.from('projects').select('*').order('created_at',{ascending:false}),
    sb.from('post_likes').select('post_id, owner_auth_uid'),
    sb.from('post_comments').select('post_id'),
    (authUid ? sb.from('project_members').select('project_id').eq('member_auth_uid', authUid) : Promise.resolve({data:[]}))
    ,
    sb.from('pi_codes').select('*').order('created_at',{ascending:false})
  ]);

  if(postsR.error) console.error(postsR.error);
  if(projectsR.error) console.error(projectsR.error);
  if(likesR.error) console.error(likesR.error);
  if(commentsR.error) console.error(commentsR.error);
  if(membersR?.error) console.error(membersR.error);
  if(codesR.error) console.error(codesR.error);

  state.posts = postsR.data || [];
  state.projects = projectsR.data || [];

  state.likesByPost = new Map();
  (likesR.data || []).forEach(x=>{
    if(!state.likesByPost.has(x.post_id)) state.likesByPost.set(x.post_id, new Set());
    state.likesByPost.get(x.post_id).add(x.owner_auth_uid);
  });

  state.commentsCount = new Map();
  (commentsR.data || []).forEach(x=>{
    state.commentsCount.set(x.post_id, (state.commentsCount.get(x.post_id)||0) + 1);
  });

  state.myMemberProjects = new Set((membersR.data||[]).map(x=>x.project_id));
  state.codes = codesR.data || [];

  renderPosts();
  renderProjects();
  renderCodes();
}

// ====== Filters ======
function setTag(t){
  state.activeTag = t || null;
  toast(state.activeTag ? `ÙÙ„ØªØ±Ø© Ø¨Ø§Ù„ÙˆØ³Ù…: ${state.activeTag}` : 'ØªÙ… Ù…Ø³Ø­ Ø§Ù„ÙÙ„ØªØ±');
  renderPosts();
  renderProjects();
}

// ====== Posts ======
function renderPosts(){
  const c=document.getElementById('home');
  if(!c) return;

  const q = (state.q || '').toLowerCase().trim();
  const tag = state.activeTag;

  const filtered = (state.posts||[]).filter(p=>{
    const inText = !q || (p.title||'').toLowerCase().includes(q) || (p.content||'').toLowerCase().includes(q) || (p.pi_username||'').toLowerCase().includes(q);
    const inTag  = !tag || (Array.isArray(p.tags) && p.tags.includes(tag));
    return inText && inTag;
  });

  c.innerHTML = filtered.map(p=>{
    const likedSet = state.likesByPost.get(p.id) || new Set();
    const likes = likedSet.size;
    const likedByMe = authUid ? likedSet.has(authUid) : false;
    const cmCount = state.commentsCount.get(p.id) || 0;

    return `
    <div class="card">
      <h3>${escapeHtml(p.title)}</h3>
      <div class="mut">${escapeHtml(p.pi_username||'')}</div>
      <p style="margin:10px 0 0;line-height:1.7">${escapeHtml(p.content)}</p>

      <div class="tags">
        ${(p.tags||[]).slice(0,6).map(t=>`<span class="tag" onclick="setTag('${escapeHtml(t)}')">#${escapeHtml(t)}</span>`).join('')}
      </div>

      <div class="row">
        <div class="mut">${new Date(p.created_at).toLocaleString('ar-EG')}</div>
        <div class="actions">
          <button class="iconBtn" onclick="toggleLike('${p.id}')">${likedByMe ? 'ğŸ’œ' : 'ğŸ¤'} Ù„Ø§ÙŠÙƒ (${likes})</button>
          <button class="iconBtn" onclick="openComments('${p.id}')">ğŸ’¬ ÙƒÙˆÙ…Ù†Øª (${cmCount})</button>
          ${p.owner_auth_uid === authUid ? `<button class="iconBtn" onclick="deletePost('${p.id}')">ğŸ—‘ Ø­Ø°Ù</button>` : ``}
        </div>
      </div>
    </div>`;
  }).join('');

  if(!filtered.length){
    c.innerHTML = `<div class="card"><h3>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</h3><div class="mut">Ø¬Ø±Ù‘Ø¨ Ø¨Ø­Ø« Ù…Ø®ØªÙ„Ù Ø£Ùˆ Ø§Ù…Ø³Ø­ Ø§Ù„ÙÙ„ØªØ±.</div></div>`;
  }
}

async function toggleLike(postId){
  if(!isVerified) return toast('Ù„Ø§Ø²Ù… ØªØ³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Pi Ø§Ù„Ø£ÙˆÙ„', false);
  try{
    if(!authUid) await refreshAuthUid();

    const likedSet = state.likesByPost.get(postId) || new Set();
    const already = likedSet.has(authUid);

    if(already){
      const { error } = await sb.from('post_likes')
        .delete()
        .eq('post_id', postId)
        .eq('owner_auth_uid', authUid);
      if(error) throw error;
      likedSet.delete(authUid);
    }else{
      const payload = { post_id: postId, owner_auth_uid: authUid };
      const { error } = await sb.from('post_likes').insert(payload);
      if(error) throw error;
      likedSet.add(authUid);
    }

    state.likesByPost.set(postId, likedSet);
    renderPosts();
  }catch(e){
    console.error('toggleLike', e);
    toast(e?.message || 'ÙØ´Ù„ Ø§Ù„Ù„Ø§ÙŠÙƒ (RLS?)', false);
  }
}

async function openComments(postId){
  window.__openCommentsPostId = postId; // âœ… Ù…Ù‡Ù…
  try{
    const { data, error } = await sb.from('post_comments')
      .select('*')
      .eq('post_id', postId)
      .order('created_at', {ascending:true});

    if(error) throw error;

    const list = (data||[]).map(c=>`
      <div class="cItem">
        <div class="mut">${escapeHtml(c.pi_username||'')}</div>
        <div style="margin-top:6px;line-height:1.7">${escapeHtml(c.body)}</div>
        <div class="mut" style="margin-top:6px">${new Date(c.created_at).toLocaleString('ar-EG')}</div>
        ${c.owner_auth_uid === authUid ? `<div class="actions" style="margin-top:8px"><button class="iconBtn" onclick="deleteComment('${c.id}','${postId}')">Ø­Ø°Ù</button></div>` : ``}
      </div>
    `).join('');

    openModal('Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª', `
      <div class="cList">${list || `<div class="mut">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</div>`}</div>
      <hr />
      <div class="field">
        <label>Ø¥Ø¶Ø§ÙØ© ØªØ¹Ù„ÙŠÙ‚</label>
        <textarea id="c_body" placeholder="Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚..."></textarea>
      </div>
      <div class="footerBtns">
        <button class="primaryBtn" onclick="addComment('${postId}')">Ù†Ø´Ø± Ø§Ù„ØªØ¹Ù„ÙŠÙ‚</button>
        <button class="iconBtn" onclick="closeModal()">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    `);

  }catch(e){
    console.error('openComments', e);
    toast(e?.message || 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª', false);
  }
}

async function addComment(postId){
  if(!isVerified) return toast('Ù„Ø§Ø²Ù… ØªØ³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Pi Ø§Ù„Ø£ÙˆÙ„', false);
  try{
    if(!authUid) await refreshAuthUid();
    const body = (document.getElementById('c_body')?.value||'').trim();
    if(!body) return toast('Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚', false);

    const payload = {
      post_id: postId,
      owner_auth_uid: authUid,
      pi_username: piUser?.username || '',
      body
    };

    // âœ… Ù†Ø®Ù„ÙŠÙ‡Ø§ ØªØ±Ø¬Ø¹ Ø§Ù„ØµÙ
    const { data, error } = await sb.from('post_comments').insert(payload).select().single();
    if(error) throw error;

    // âœ… Update Ù…Ø­Ù„ÙŠ ÙÙˆØ±Ù‹Ø§ (ÙˆÙƒÙ…Ø§Ù† Ø§Ù„Ø±ÙŠÙ„ ØªØ§ÙŠÙ… Ù‡ÙŠØ²Ø¨Ø· Ø§Ù„Ø¨Ø§Ù‚ÙŠ)
    state.commentsCount.set(postId, (state.commentsCount.get(postId)||0) + 1);
    toast('ØªÙ… Ù†Ø´Ø± Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ âœ…');
    // Ø³ÙŠØ¨ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ù…ÙØªÙˆØ­ ÙˆØ§ØªØ­Ø¯Ø« ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ø§Ù„Ø±ÙŠÙ„ØªÙŠÙ…
    openComments(postId);

  }catch(e){
    console.error('addComment', e);
    toast(e?.message || 'ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ (RLS?)', false);
  }
}

async function deleteComment(commentId, postId){
  try{
    const { error } = await sb.from('post_comments').delete().eq('id', commentId);
    if(error) throw error;
    toast('ØªÙ… Ø­Ø°Ù Ø§Ù„ØªØ¹Ù„ÙŠÙ‚');
    // Ø§Ù„Ø±ÙŠÙ„ØªÙŠÙ… Ù‡ÙŠØ¹Ù…Ù„ ØªØ­Ø¯ÙŠØ«ØŒ Ù„ÙƒÙ† Ù„Ùˆ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ù…ÙØªÙˆØ­ Ù†Ø­Ø¯Ø« ÙÙˆØ±Ù‹Ø§
    openComments(postId);
  }catch(e){
    console.error('deleteComment', e);
    toast(e?.message || 'ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„ØªØ¹Ù„ÙŠÙ‚', false);
  }
}

async function deletePost(id){
  try{
    const { error } = await sb.from('posts').delete().eq('id', id);
    if(error) throw error;
    toast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨ÙˆØ³Øª');
    // Ø§Ù„Ø±ÙŠÙ„ØªÙŠÙ… Ù‡ÙŠØ´ÙŠÙ„Ù‡ Ù…Ù† Ø¹Ù†Ø¯ Ø§Ù„ÙƒÙ„
  }catch(e){
    console.error('deletePost', e);
    toast(e?.message || 'ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù', false);
  }
}

// ====== Projects ======
function renderProjects(){
  const c=document.getElementById('projects');
  if(!c) return;

  const q = (state.q || '').toLowerCase().trim();
  const tag = state.activeTag;

  const filtered = (state.projects||[]).filter(p=>{
    const inText = !q || (p.name||'').toLowerCase().includes(q) || (p.description||'').toLowerCase().includes(q) || (p.pi_username||'').toLowerCase().includes(q);
    const inTag  = !tag || (Array.isArray(p.stack) && p.stack.includes(tag));
    return inText && inTag;
  });

  c.innerHTML = filtered.map(p=>{
    const isMember = state.myMemberProjects.has(p.id);
    return `
    <div class="card">
      <h3>${escapeHtml(p.name)}</h3>
      <div class="mut">${escapeHtml(p.pi_username||'')}</div>
      <p style="margin:10px 0 0;line-height:1.7">${escapeHtml(p.description)}</p>

      <div class="tags">
        ${(p.stack||[]).slice(0,6).map(t=>`<span class="tag" onclick="setTag('${escapeHtml(t)}')">${escapeHtml(t)}</span>`).join('')}
      </div>

      <div class="row">
        <div class="mut">${new Date(p.created_at).toLocaleString('ar-EG')}</div>
        <div class="actions">
          ${isMember
            ? `<span class="badge">âœ… Ø¹Ø¶Ùˆ</span><button class="primaryBtn" onclick="openGroup('${p.id}','${escapeHtml(p.name)}')">ÙØªØ­ Ø§Ù„Ø¬Ø±ÙˆØ¨</button>`
            : `<button class="primaryBtn" onclick="joinGroup('${p.id}','${escapeHtml(p.name)}')">Ø§Ù†Ø¶Ù… Ù„Ù„Ø¬Ø±ÙˆØ¨</button>`
          }
          ${p.owner_auth_uid === authUid ? `<button class="iconBtn" onclick="deleteProject('${p.id}')">ğŸ—‘ Ø­Ø°Ù</button>` : ``}
        </div>
      </div>
    </div>`;
  }).join('');

  if(!filtered.length){
    c.innerHTML = `<div class="card"><h3>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹</h3><div class="mut">Ø¬Ø±Ù‘Ø¨ Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø±ÙˆØ¹ Ø¬Ø¯ÙŠØ¯.</div></div>`;
  }
}

async function joinGroup(projectId, projectName){
  if(!isVerified) return toast('Ù„Ø§Ø²Ù… ØªØ³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Pi Ø§Ù„Ø£ÙˆÙ„', false);
  try{
    if(!authUid) await refreshAuthUid();
    const payload = {
      project_id: projectId,
      member_auth_uid: authUid,
      pi_username: piUser?.username || '',
      role: 'member'
    };
    const { error } = await sb.from('project_members').insert(payload);
    if(error) throw error;

    state.myMemberProjects.add(projectId);
    toast(`Ø§Ù†Ø¶Ù…ÙŠØª Ù„Ø¬Ø±ÙˆØ¨: ${projectName} âœ…`);
    renderProjects();
    openGroup(projectId, projectName);
  }catch(e){
    console.error('joinGroup', e);
    toast(e?.message || 'ÙØ´Ù„ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… (RLS?)', false);
  }
}

async function leaveGroup(){
  if(!activeProject?.id) return;
  try{
    const pid = activeProject.id;
    const { error } = await sb.from('project_members')
      .delete()
      .eq('project_id', pid)
      .eq('member_auth_uid', authUid);
    if(error) throw error;

    state.myMemberProjects.delete(pid);
    toast('ØªÙ…Øª Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©');
    stopProjectRealtime();
    activeProject = null;
    show('projects', document.querySelector('[data-tab=projects]'));
    renderProjects();
  }catch(e){
    console.error('leaveGroup', e);
    toast(e?.message || 'ÙØ´Ù„ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©', false);
  }
}

async function deleteProject(id){
  try{
    const { error } = await sb.from('projects').delete().eq('id', id);
    if(error) throw error;
    toast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹');
    // Ø§Ù„Ø±ÙŠÙ„ØªÙŠÙ… Ù‡ÙŠØ´ÙŠÙ„Ù‡ Ù…Ù† Ø¹Ù†Ø¯ Ø§Ù„ÙƒÙ„
  }catch(e){
    console.error('deleteProject', e);
    toast(e?.message || 'ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù', false);
  }
}

// ====== Group chat (already realtime per project) ======
async function openGroup(projectId, projectName){
  activeProject = { id: projectId, name: projectName };
  document.getElementById('groupTitle').textContent = `Ø¬Ø±ÙˆØ¨: ${projectName}`;
  document.getElementById('groupSub').textContent = `Ø´Ø§Ø±Ùƒ ÙÙŠ Ø­Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© ÙˆØ¨Ù†Ø§Ø¡ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ â€” Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØ± Ù…ØªØ§Ø­`;
  show('group', null);
  await loadProjectMessages();
  startProjectRealtime(); // âœ… Ø¯Ù‡ Ø¨ÙŠØ®Ù„ÙŠ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØªØ¸Ù‡Ø± ÙÙˆØ±Ù‹Ø§ Ù„ÙƒÙ„ Ø§Ù„Ù†Ø§Ø³ ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø¬Ø±ÙˆØ¨
}

async function loadProjectMessages(){
  const wrap = document.getElementById('chatMsgs');
  if(!wrap) return;
  wrap.innerHTML = `<div class="mut">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„...</div>`;
  const { data, error } = await sb.from('project_messages')
    .select('*')
    .eq('project_id', activeProject.id)
    .order('created_at', {ascending:true});

  if(error){
    console.error(error);
    wrap.innerHTML = `<div class="mut">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</div>`;
    return;
  }
  renderMessages(data||[]);
}
function renderMessages(list){
  const wrap = document.getElementById('chatMsgs');
  if(!wrap) return;
  wrap.innerHTML = (list||[]).map(m=>{
    const me = (m.sender_auth_uid === authUid);
    return `
      <div class="bubble ${me?'me':''}">
        <div class="who">${escapeHtml(m.sender_pi_username||'')}</div>
        ${m.body ? `<div>${escapeHtml(m.body)}</div>` : ``}
        ${m.image_url ? `<img src="${escapeHtml(m.image_url)}" alt="image" />` : ``}
        <div class="mut small" style="margin-top:6px">${new Date(m.created_at).toLocaleString('ar-EG')}</div>
      </div>
    `;
  }).join('');
  wrap.scrollTop = wrap.scrollHeight + 9999;
}
function startProjectRealtime(){
  stopProjectRealtime();
  activeProjectSub = sb.channel('project_messages_'+activeProject.id)
    .on('postgres_changes',
      { event: 'INSERT', schema: 'public', table: 'project_messages', filter: `project_id=eq.${activeProject.id}` },
      (payload) => {
        const wrap = document.getElementById('chatMsgs');
        if(!wrap) return;
        const m = payload.new;
        const me = (m.sender_auth_uid === authUid);
        const html = `
          <div class="bubble ${me?'me':''}">
            <div class="who">${escapeHtml(m.sender_pi_username||'')}</div>
            ${m.body ? `<div>${escapeHtml(m.body)}</div>` : ``}
            ${m.image_url ? `<img src="${escapeHtml(m.image_url)}" alt="image" />` : ``}
            <div class="mut small" style="margin-top:6px">${new Date(m.created_at).toLocaleString('ar-EG')}</div>
          </div>
        `;
        wrap.insertAdjacentHTML('beforeend', html);
        wrap.scrollTop = wrap.scrollHeight + 9999;
      }
    )
    .subscribe();
}
function stopProjectRealtime(){
  if(activeProjectSub){
    sb.removeChannel(activeProjectSub);
    activeProjectSub = null;
  }
}

async function uploadImageToStorage(file){
  const safeName = (file.name || 'image').replace(/[^\w.\-]+/g,'_');
  const path = `${authUid}/${activeProject.id}/${Date.now()}_${safeName}`;

  const { error } = await sb.storage.from('project_uploads').upload(path, file, {
    cacheControl: '3600',
    upsert: false
  });
  if(error) throw error;

  const { data } = sb.storage.from('project_uploads').getPublicUrl(path);
  return data.publicUrl;
}

document.getElementById('imgInput')?.addEventListener('change', async (e)=>{
  const f = e.target.files?.[0];
  if(!f) return;
  if(!isVerified) return toast('Ù„Ø§Ø²Ù… ØªØ³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Pi Ø§Ù„Ø£ÙˆÙ„', false);
  if(!activeProject?.id) return toast('Ø§ÙØªØ­ Ø¬Ø±ÙˆØ¨ Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø£ÙˆÙ„', false);

  try{
    if(!authUid) await refreshAuthUid();
    toast('Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©...');
    const url = await uploadImageToStorage(f);
    await insertProjectMessage('', url);
    toast('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø© âœ…');
    e.target.value = '';
  }catch(err){
    console.error(err);
    toast(err?.message || 'ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©', false);
  }
});

async function insertProjectMessage(text, imageUrl){
  const payload = {
    project_id: activeProject.id,
    sender_auth_uid: authUid,
    sender_pi_username: piUser?.username || '',
    body: text || null,
    image_url: imageUrl || null
  };
  const { error } = await sb.from('project_messages').insert(payload);
  if(error) throw error;
}
async function sendMessage(){
  if(!isVerified) return toast('Ù„Ø§Ø²Ù… ØªØ³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Pi Ø§Ù„Ø£ÙˆÙ„', false);
  if(!activeProject?.id) return toast('Ø§ÙØªØ­ Ø¬Ø±ÙˆØ¨ Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø£ÙˆÙ„', false);

  try{
    if(!authUid) await refreshAuthUid();
    const input = document.getElementById('msgText');
    const text = (input?.value||'').trim();
    if(!text) return;
    input.value = '';
    await insertProjectMessage(text, null);
    // Ø§Ù„Ø±ÙŠÙ„ØªÙŠÙ… Ù‡ÙŠØ¸Ù‡Ø±Ù‡Ø§ Ù„Ù„Ø¬Ù…ÙŠØ¹ ÙÙˆØ±Ù‹Ø§
  }catch(e){
    console.error('sendMessage', e);
    toast(e?.message || 'ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© (RLS?)', false);
  }
}

// ====== Create Post / Project ======
function openCreatePost(){
  if(!isVerified) return toast('Ù„Ø§Ø²Ù… ØªØ³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Pi Ø§Ù„Ø£ÙˆÙ„', false);

  openModal('Ø¥Ø¶Ø§ÙØ© Ø¨ÙˆØ³Øª', `
    <div class="field">
      <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
      <input id="p_title" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Pi SDK" />
    </div>
    <div class="field">
      <label>Ø§Ù„Ù…Ø­ØªÙˆÙ‰</label>
      <textarea id="p_content" placeholder="Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨ÙˆØ³Øª..."></textarea>
    </div>
    <div class="field">
      <label>Tags (Ø§ÙØµÙ„ Ø¨ÙŠÙ†Ù‡Ù… Ø¨ÙØ§ØµÙ„Ø©)</label>
      <input id="p_tags" placeholder="pi-sdk, supabase, nextjs" />
    </div>
    <div class="footerBtns">
      <button class="primaryBtn" onclick="createPost()">Ù†Ø´Ø±</button>
      <button class="iconBtn" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  `);
}
async function createPost(){
  try{
    const title = (document.getElementById('p_title')?.value||'').trim();
    const content = (document.getElementById('p_content')?.value||'').trim();
    const tags = (document.getElementById('p_tags')?.value||'').split(',').map(s=>s.trim()).filter(Boolean);
    if(!title || !content) return toast('Ø§ÙƒØªØ¨ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ù…Ø­ØªÙˆÙ‰', false);
    if(!authUid) await refreshAuthUid();

    const payload = {
      owner_auth_uid: authUid,
      pi_uid: piUser.uid,
      pi_username: piUser.username,
      title, content, tags
    };

    const { data, error } = await sb.from('posts').insert(payload).select().single();
    if(error) throw error;

    closeModal();
    toast('ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø¨ÙˆØ³Øª âœ…');
    // Ø§Ù„Ø±ÙŠÙ„ØªÙŠÙ… Ù‡ÙŠØ¸Ù‡Ø±Ù‡ Ø¹Ù†Ø¯ Ø§Ù„ÙƒÙ„ ÙÙˆØ±Ù‹Ø§ (ÙˆØ¹Ù†Ø¯Ùƒ ÙƒÙ…Ø§Ù† ØªØ­Ø¯ÙŠØ« Ù…Ø­Ù„ÙŠ Ø³Ø±ÙŠØ¹)
    unshiftUnique(state.posts, data);
    renderPosts();

  }catch(e){
    console.error('createPost', e);
    toast(e?.message || 'ÙØ´Ù„ Ù†Ø´Ø± Ø§Ù„Ø¨ÙˆØ³Øª (RLS?)', false);
  }
}

function openCreateProject(){
  if(!isVerified) return toast('Ù„Ø§Ø²Ù… ØªØ³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Pi Ø§Ù„Ø£ÙˆÙ„', false);

  openModal('Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø±ÙˆØ¹ (ÙŠÙ†Ø´Ø¦ Ø¬Ø±ÙˆØ¨)', `
    <div class="field">
      <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</label>
      <input id="pr_name" placeholder="Ù…Ø«Ø§Ù„: Pi Shop" />
    </div>
    <div class="field">
      <label>ÙˆØµÙ Ù…Ø®ØªØµØ±</label>
      <textarea id="pr_desc" placeholder="Ø§ÙƒØªØ¨ ÙˆØµÙ Ø³Ø±ÙŠØ¹..."></textarea>
    </div>
    <div class="field">
      <label>Tech Stack (Ø§ÙØµÙ„ Ø¨ÙŠÙ†Ù‡Ù… Ø¨ÙØ§ØµÙ„Ø©)</label>
      <input id="pr_stack" placeholder="nextjs, supabase, pi-sdk" />
    </div>
    <div class="field">
      <label>Ø£Ø¯ÙˆØ§Ø± Ù…Ø·Ù„ÙˆØ¨Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
      <input id="pr_roles" placeholder="frontend, backend, uiux" />
    </div>
    <div class="footerBtns">
      <button class="primaryBtn" onclick="createProject()">Ù†Ø´Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</button>
      <button class="iconBtn" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  `);
}
async function createProject(){
  try{
    const name = (document.getElementById('pr_name')?.value||'').trim();
    const description = (document.getElementById('pr_desc')?.value||'').trim();
    const stack = (document.getElementById('pr_stack')?.value||'').split(',').map(s=>s.trim()).filter(Boolean);
    const needed_roles = (document.getElementById('pr_roles')?.value||'').split(',').map(s=>s.trim()).filter(Boolean);

    if(!name || !description) return toast('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ÙˆØ§Ù„ÙˆØµÙ', false);
    if(!authUid) await refreshAuthUid();

    const payload = {
      owner_auth_uid: authUid,
      pi_uid: piUser.uid,
      pi_username: piUser.username,
      name, description, stack, needed_roles
    };

    const { data, error } = await sb.from('projects').insert(payload).select().single();
    if(error) throw error;

    const { error: meErr } = await sb.from('project_members').insert({
      project_id: data.id,
      member_auth_uid: authUid,
      pi_username: piUser.username,
      role: 'owner'
    });
    if(meErr) throw meErr;

    closeModal();
    toast('ØªÙ… Ù†Ø´Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ âœ… ÙˆØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø±ÙˆØ¨');
    unshiftUnique(state.projects, data);
    renderProjects();
    await openGroup(data.id, data.name);

  }catch(e){
    console.error('createProject', e);
    toast(e?.message || 'ÙØ´Ù„ Ù†Ø´Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ (RLS?)', false);
  }
}

// ====== Codes ======
function codeCardHtml(x) {
  // âœ… Ø§Ù„Ø­Ø°Ù Ù„Ù„Ø£Ø¯Ù…Ù† Ø£Ùˆ Ù„ØµØ§Ø­Ø¨ Ø§Ù„ÙƒÙˆØ¯
  const canDelete = isVerified && authUid && (isAdmin() || x.owner_auth_uid === authUid);
  const official = (x.created_by_pi_username === ADMIN_PI_USERNAME);
  
  return `
    <div class="codeCard">
      <div class="codeHead">
        <div>
          <div class="codeTitle">${escapeHtml(x.title || '')}</div>
          <div class="mut small">
            ${escapeHtml(x.created_by_pi_username||'')}
            ${official ? ` <span class="badge">â­ Ø±Ø³Ù…ÙŠ</span>` : ``}
          </div>
        </div>
        <div class="actions">
          <button class="iconBtn copyBtn" data-code="${encodeURIComponent(x.code || '')}" onclick="copyFromBtn(this)">Ù†Ø³Ø®</button>
          ${
            canDelete
              ? `<button class="iconBtn" onclick="deleteCode('${x.id}','${x.owner_auth_uid || ''}')">Ø­Ø°Ù</button>`
              : ``
          }
        </div>
      </div>
      <div class="codeBox">${escapeHtml(x.code||'')}</div>
    </div>
  `;
}
function renderCodes() {
  const adminGrid = document.getElementById('codesAdminGrid');
  const otherGrid = document.getElementById('codesOtherGrid');
  if (!adminGrid || !otherGrid) return;

  const q = (state.q || '').toLowerCase().trim();

  const all = (state.codes || []).filter(x => {
    return !q ||
      (x.title || '').toLowerCase().includes(q) ||
      (x.code || '').toLowerCase().includes(q) ||
      (x.created_by_pi_username || '').toLowerCase().includes(q);
  });

  const adminList = all.filter(x => x.created_by_pi_username === ADMIN_PI_USERNAME);
  const otherList = all.filter(x => x.created_by_pi_username !== ADMIN_PI_USERNAME);

  adminGrid.innerHTML = adminList.length
    ? adminList.map(codeCardHtml).join('')
    : `<div class="card"><h3>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙƒÙˆØ§Ø¯ Ø£Ø¯Ù…Ù†</h3><div class="mut">Ù„Ø³Ù‡ Ù…ÙÙŠØ´ Ø£ÙƒÙˆØ§Ø¯ Ø±Ø³Ù…ÙŠØ©.</div></div>`;

  otherGrid.innerHTML = otherList.length
    ? otherList.map(codeCardHtml).join('')
    : `<div class="card"><h3>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙƒÙˆØ§Ø¯ Ø£Ø®Ø±Ù‰</h3><div class="mut">Ø´Ø¬Ù‘Ø¹ Ø§Ù„Ù†Ø§Ø³ ØªØ¶ÙŠÙ Ø£ÙƒÙˆØ§Ø¯.</div></div>`;
}

function copyFromBtn(btn) {
  const code = decodeURIComponent(btn.dataset.code || '');
  copyText(code);
}
function copyText(t){
  const text = String(t ?? '');
  if(navigator.clipboard?.writeText){
    navigator.clipboard.writeText(text).then(()=>toast('ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ…')).catch(()=>fallbackCopy(text));
  }else{
    fallbackCopy(text);
  }
}
function fallbackCopy(text){
  const ta=document.createElement('textarea');
  ta.value=text; document.body.appendChild(ta);
  ta.select(); document.execCommand('copy');
  ta.remove();
  toast('ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ…');
}

function openCreateCode(){
  if(!isVerified) return toast('Ù„Ø§Ø²Ù… ØªØ³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Pi Ø§Ù„Ø£ÙˆÙ„', false);

  openModal('Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ¯', `
    <div class="field">
      <label>Ø§Ø³Ù… Ø§Ù„ÙƒÙˆØ¯</label>
      <input id="cd_title" placeholder="Ù…Ø«Ø§Ù„: Pi Login snippet" />
    </div>
    <div class="field">
      <label>Ø§Ù„ÙƒÙˆØ¯</label>
      <textarea id="cd_code" placeholder="Ø§Ù„ØµÙ‚ Ø§Ù„ÙƒÙˆØ¯ Ù‡Ù†Ø§..."></textarea>
      <div class="help">Ù‡ÙŠØ¸Ù‡Ø± Ù„Ù„Ù†Ø§Ø³ Ø²Ø± Ù†Ø³Ø®.</div>
    </div>
    <div class="footerBtns">
      <button class="primaryBtn" onclick="createCode()">Ø­ÙØ¸</button>
      <button class="iconBtn" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  `);
}

async function createCode(){
  if(!isVerified) return toast('Ù„Ø§Ø²Ù… ØªØ³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Pi Ø§Ù„Ø£ÙˆÙ„', false);
  try{
    if(!authUid) await refreshAuthUid();
    const title = (document.getElementById('cd_title')?.value||'').trim();
    const code  = (document.getElementById('cd_code')?.value||'').trim();
    if(!title || !code) return toast('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ÙƒÙˆØ¯ ÙˆØ§Ù„ÙƒÙˆØ¯', false);

    const payload = {
      owner_auth_uid: authUid,
      created_by_pi_username: piUser?.username || '',
      title,
      code
    };

    const { data, error } = await sb.from('pi_codes').insert(payload).select().single();
    if(error) throw error;

    closeModal();
    toast('ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙƒÙˆØ¯ âœ…');
    unshiftUnique(state.codes, data);
    renderCodes();

  }catch(e){
    console.error('createCode', e);
    toast(e?.message || 'ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ÙƒÙˆØ¯ (RLS?)', false);
  }
}

async function deleteCode(id, ownerAuthUid) {
  // âœ… Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ø£Ø¯Ù…Ù† Ø£Ùˆ Ù„ØµØ§Ø­Ø¨ Ø§Ù„ÙƒÙˆØ¯ ÙÙ‚Ø·
  const allowed = isAdmin() || (isVerified && authUid && ownerAuthUid && ownerAuthUid === authUid);
  if (!allowed) return toast('Ø§Ù„Ø­Ø°Ù Ù„ØµØ§Ø­Ø¨ Ø§Ù„ÙƒÙˆØ¯ Ø£Ùˆ Ø§Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·', false);
  
  try {
    const { error } = await sb.from('pi_codes').delete().eq('id', id);
    if (error) throw error;
    
    toast('ØªÙ… Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ¯');
    state.codes = state.codes.filter(x => x.id !== id);
    renderCodes();
  } catch (e) {
    console.error('deleteCode', e);
    toast(e?.message || 'ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù', false);
  }
}

// ====== Pi Login + verify ======
async function verifyAndSetAuth(pi_uid, pi_username){
  const sess = await ensureSession();
  const access = sess?.access_token;
  if(!access) throw new Error('no_session');

  const r = await fetch('/api/pi/verify', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({
      pi_uid,
      pi_username,
      supabase_access_token: access
    })
  });

  const j = await r.json().catch(()=> ({}));
  if(!r.ok) throw new Error(j?.error || 'verify_failed');
}

async function login(){
  try{
    await ensureSession();
    await refreshAuthUid();

    Pi.init({version:"2.0", sandbox:false});
    const auth = await Pi.authenticate(['username'], ()=>{});
    piUser = auth.user;

    await verifyAndSetAuth(piUser.uid, piUser.username);

    isVerified = true;
    localStorage.setItem('piUser', JSON.stringify(piUser));
    localStorage.setItem('isVerified', '1');

    setUIAuthed();
    toast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ âœ…');

    // âœ… Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø´ØºÙ„ Ø±ÙŠÙ„ØªØ§ÙŠÙ… Ù„Ùˆ Ù…Ø´ Ø´ØºØ§Ù„
    startRealtime();

  }catch(e){
    console.error('login', e);
    toast('ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„/Ø§Ù„ØªØ­Ù‚Ù‚: ' + (e?.message || e), false);
  }
}

// ====== Restore + init ======
function restoreLogin(){
  try{
    const saved = localStorage.getItem('piUser');
    const v = localStorage.getItem('isVerified');
    if(saved && v === '1'){
      piUser = JSON.parse(saved);
      isVerified = true;
    }
  }catch{}
}

document.getElementById('loginBtn')?.addEventListener('click', login);

document.getElementById('search')?.addEventListener('input', (e)=>{
  state.q = e.target.value || '';
  renderPosts();
  renderProjects();
  renderCodes();
});

async function init(){
  try{
    restoreLogin();
    await ensureSession();
    await refreshAuthUid();
    setUIAuthed();

    await loadAll();

    // âœ… Ø´ØºÙ„ Ø§Ù„Ø±ÙŠÙ„ØªÙŠÙ… Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© (Ø§Ù„Ù†Ø§Ø³ ÙƒÙ„Ù‡Ø§ Ù‡ØªØ´ÙˆÙ Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª ÙÙˆØ±Ù‹Ø§)
    startRealtime();

    if(isVerified && piUser?.uid && piUser?.username){
      try{ await verifyAndSetAuth(piUser.uid, piUser.username); }catch(_){}
    }
  }catch(e){
    console.error('init', e);
    toast('Ù…Ø´ÙƒÙ„Ø© ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¬Ù„Ø³Ø©: ' + (e?.message || e), false);
  }
}
init();
</script>
</body>
</html>
