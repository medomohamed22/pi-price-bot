<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pi Elite Hub | 2026</title>
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #6d28d9; --accent: #00f2fe; --glass: rgba(255,255,255,0.1); }
        body { margin: 0; background: #0f172a; color: white; font-family: sans-serif; padding-bottom: 80px; }
        .page { display: none; padding: 20px 15px; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .glass-card { background: var(--glass); backdrop-filter: blur(10px); border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); overflow: hidden; }
        .ads-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .ad-item img { width: 100%; height: 130px; object-fit: cover; }
        
        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ */
        .nav { position: fixed; bottom: 0; width: 100%; background: rgba(15,23,42,0.9); display: flex; justify-content: space-around; padding: 15px 0; border-top: 1px solid var(--glass); z-index: 1000; }
        .nav button { background: none; border: none; color: #64748b; font-size: 12px; }
        .nav button.active { color: var(--accent); }

        /* ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© */
        .chat-box { height: 250px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 15px; padding: 10px; margin-top: 15px; border: 1px solid var(--glass); }
        .msg { margin-bottom: 10px; padding: 8px 12px; border-radius: 12px; max-width: 80%; font-size: 14px; }
        .msg.sent { background: var(--primary); align-self: flex-end; margin-right: auto; }
        .msg.received { background: #334155; align-self: flex-start; }
        
        .chat-input { display: flex; gap: 5px; margin-top: 10px; }
        input { background: rgba(255,255,255,0.05); border: 1px solid var(--glass); color: white; padding: 10px; border-radius: 10px; flex: 1; }
        .send-btn { background: var(--accent); color: black; border: none; padding: 10px; border-radius: 10px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="page-login" class="page active" style="text-align: center; padding-top: 100px;">
        <h1>Pi Elite Hub</h1>
        <button onclick="authPi()" style="padding: 15px 30px; border-radius: 25px; border: none; background: #ffc107; font-weight: bold;">Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Pi</button>
    </div>

    <div id="page-home" class="page">
        <h2>Ø§Ø­Ø¯Ø« Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</h2>
        <div id="ads-grid" class="ads-grid"></div>
    </div>

    <div id="page-details" class="page">
        <button onclick="nav('home')" style="background: none; border: none; color: var(--accent); margin-bottom: 10px;">â† Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
        <div id="details-content"></div>
        
        <div class="glass-card" style="padding: 15px; margin-top: 20px;">
            <h4>ğŸ’¬ Ø¯Ø±Ø¯Ø´Ø© Ø³Ø±ÙŠØ¹Ø© Ù…Ø¹ Ø§Ù„Ø¨Ø§Ø¦Ø¹</h4>
            <div id="chat-messages" class="chat-box"></div>
            <div class="chat-input">
                <input type="text" id="chat-input-text" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ...">
                <button class="send-btn" onclick="sendMessage()">Ø¥Ø±Ø³Ø§Ù„</button>
            </div>
        </div>
    </div>

    <nav class="nav" id="main-nav" style="display: none;">
        <button onclick="nav('home', this)" class="active"><i class="fas fa-home"></i><br>Ø§Ù„Ø³ÙˆÙ‚</button>
        <button onclick="nav('home')"><i class="fas fa-plus"></i><br>Ù†Ø´Ø±</button> <button onclick="nav('home')"><i class="fas fa-user"></i><br>Ø­Ø³Ø§Ø¨ÙŠ</button>
    </nav>

    <script>
        const SB_URL = 'https://axjkwrssmofzavaoqutq.supabase.co';
        const SB_KEY = 'sb_publishable_tiuMncgWhf1YRWoD-uYQ3Q_ziI8OKci';
        const _sb = supabase.createClient(SB_URL, SB_KEY);

        let user = null;
        let currentAd = null;

        async function authPi() {
            try {
                const Pi = window.Pi; Pi.init({ version: "2.0" });
                const auth = await Pi.authenticate(['username'], (p)=>{});
                user = auth.user;
                document.getElementById('page-login').classList.remove('active');
                document.getElementById('main-nav').style.display = 'flex';
                nav('home');
            } catch (e) { alert("Ø§ÙØªØ­ Ù…Ù† Pi Browser"); }
        }

        function nav(id, btn) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + id).classList.add('active');
            if(id === 'home') loadAds();
        }

        async function loadAds() {
            const { data } = await _sb.from('ads').select('*').order('created_at', {ascending: false});
            const grid = document.getElementById('ads-grid');
            grid.innerHTML = data.map(ad => `
                <div class="glass-card ad-item" onclick="openDetails('${ad.id}')">
                    <img src="${SB_URL}/storage/v1/object/public/ads-images/${ad.image_url}">
                    <div style="padding:10px;">
                        <div style="color:var(--accent); font-weight:bold;">${ad.price} Pi</div>
                        <div style="font-size:12px;">${ad.title}</div>
                    </div>
                </div>
            `).join('');
        }

        async function openDetails(id) {
            const { data: ad } = await _sb.from('ads').select('*').eq('id', id).single();
            currentAd = ad;
            
            document.getElementById('details-content').innerHTML = `
                <div class="glass-card">
                    <img src="${SB_URL}/storage/v1/object/public/ads-images/${ad.image_url}" style="width:100%;">
                    <div style="padding:15px;">
                        <h3>${ad.title}</h3>
                        <h2 style="color:var(--accent);">${ad.price} Pi</h2>
                        <p style="color:#94a3b8;">${ad.description}</p>
                        <p>Ø¨ÙˆØ§Ø³Ø·Ø©: @${ad.seller_username}</p>
                    </div>
                </div>
            `;
            nav('details');
            loadMessages(id);
            // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª
            _sb.from('ads').update({ views_count: (ad.views_count || 0) + 1 }).eq('id', id).then();
        }

        async function loadMessages(adId) {
            const { data } = await _sb.from('messages')
                .select('*')
                .eq('ad_id', adId)
                .order('created_at', { ascending: true });
            
            const chatBox = document.getElementById('chat-messages');
            chatBox.innerHTML = data.map(m => `
                <div class="msg ${m.sender_username === user.username ? 'sent' : 'received'}">
                    <strong>${m.sender_username}:</strong> ${m.text}
                </div>
            `).join('');
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input-text');
            const text = input.value.trim();
            if(!text || !currentAd) return;

            const { error } = await _sb.from('messages').insert([{
                ad_id: currentAd.id,
                sender_username: user.username,
                receiver_username: currentAd.seller_username,
                text: text
            }]);

            if(!error) {
                input.value = '';
                loadMessages(currentAd.id);
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙƒÙ„ 5 Ø«ÙˆØ§Ù†Ù
        setInterval(() => {
            if(document.getElementById('page-details').classList.contains('active') && currentAd) {
                loadMessages(currentAd.id);
            }
        }, 5000);

    </script>
</body>
</html>
