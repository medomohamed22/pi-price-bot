<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pi Network Donate</title>
<style>
  body { font-family: Arial; padding: 20px; }
  button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
  #log { margin-top: 20px; white-space: pre-line; background: #f3f3f3; padding: 10px; border-radius: 5px; max-height: 300px; overflow-y: auto; }
</style>
</head>
<body>

<h1>تبرع باستخدام Pi Network</h1>

<label>المبلغ: <input type="number" id="amount" value="1"></label>
<button id="donateBtn">ابدأ التبرع</button>

<div id="log"></div>

<script>
const donateBtn = document.getElementById('donateBtn');
const logEl = document.getElementById('log');
let inProgress = false;

function log(message) {
  console.log(message);
  logEl.textContent += message + "\n";
}

// هذه دالة وهمية لإنشاء الدفع من Pi Browser
// المفروض Pi Browser يعطيك paymentId و txid
async function createPiPayment(amount) {
  // هذا مثال وهمي – في الواقع تستخدم Pi SDK
  return {
    paymentId: "payment_" + Math.floor(Math.random() * 100000),
    txid: "tx_" + Math.floor(Math.random() * 100000)
  };
}

async function handleDonate() {
  if (inProgress) {
    log("هناك عملية دفع جارية. انتظر حتى تنتهي.");
    return;
  }
  inProgress = true;

  const amount = parseFloat(document.getElementById('amount').value);
  log("بدء إنشاء الدفع...");

  try {
    // 1️⃣ إنشاء الدفع (في الواقع Pi SDK)
    const { paymentId, txid } = await createPiPayment(amount);
    log(`تم إنشاء الدفع!`);
    log(`paymentId: ${paymentId}`);
    log(`txid: ${txid}`);

    // 2️⃣ approve
    log("إرسال approve إلى السيرفر...");
    const approveRes = await fetch('/api/pi/approve', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ paymentId })
    });
    const approveData = await approveRes.json();
    log("Approve response: " + JSON.stringify(approveData));

    if (!approveRes.ok) throw new Error("Approve failed");

    // 3️⃣ complete
    log("إرسال complete إلى السيرفر...");
    const completeRes = await fetch('/api/pi/complete', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ paymentId, txid })
    });
    const completeData = await completeRes.json();
    log("Complete response: " + JSON.stringify(completeData));

    if (!completeRes.ok) throw new Error("Complete failed");

    log("تم إتمام الدفع بنجاح ✅");

  } catch (err) {
    log("حدث خطأ: " + err.message);
  } finally {
    inProgress = false;
  }
}

donateBtn.addEventListener('click', handleDonate);
</script>

</body>
</html>    
