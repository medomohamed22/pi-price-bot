<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Freelance Escrow - ÙˆØ³ÙŠØ· Ø®Ø¯Ù…Ø§Øª</title>

  <!-- Pi SDK -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#0b0b14;
      --card:#141428;
      --card2:#1b1b33;
      --text:#fff;
      --muted:#a9a9c7;
      --primary:#7f5cff;
      --ok:#2ecc71;
      --warn:#f1c40f;
      --bad:#e74c3c;
      --stroke:rgba(255,255,255,.08);
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(1200px 500px at 30% -10%, rgba(127,92,255,.25), transparent 60%),
                  radial-gradient(900px 400px at 80% 10%, rgba(46,204,113,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Tajawal", Arial;
      min-height:100vh;
      display:flex;
      justify-content:center;
    }
    a{color:inherit}
    .app{
      width:100%;
      max-width:1100px;
      padding:16px 14px 90px;
    }

    /* Top bar */
    .topbar{
      position:sticky; top:0;
      padding:10px 0 12px;
      z-index:30;
      backdrop-filter: blur(10px);
      background: linear-gradient(to bottom, rgba(11,11,20,.85), rgba(11,11,20,.35));
    }
    .row{display:flex; gap:12px; align-items:center; justify-content:space-between}
    .brand{
      display:flex; align-items:center; gap:10px;
      background: rgba(255,255,255,.04);
      border:1px solid var(--stroke);
      padding:10px 12px;
      border-radius:999px;
      box-shadow: var(--shadow);
    }
    .dot{
      width:12px;height:12px;border-radius:50%;
      background: var(--primary);
      box-shadow: 0 0 18px rgba(127,92,255,.9);
    }
    .brand b{font-size:14px}
    .brand span{font-size:12px;color:var(--muted)}
    .pill{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      display:flex; gap:8px; align-items:center;
    }
    .pill small{color:var(--muted)}
    .btn{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      transition:.15s;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      font-weight:600;
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px); background: rgba(255,255,255,.09)}
    .btn.primary{background: linear-gradient(135deg, rgba(127,92,255,.95), rgba(127,92,255,.55)); border-color: rgba(127,92,255,.5)}
    .btn.ok{background: linear-gradient(135deg, rgba(46,204,113,.95), rgba(46,204,113,.45)); border-color: rgba(46,204,113,.5)}
    .btn.bad{background: linear-gradient(135deg, rgba(231,76,60,.95), rgba(231,76,60,.45)); border-color: rgba(231,76,60,.5)}
    .btn:disabled{opacity:.55; cursor:not-allowed; transform:none}
    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1.3fr .9fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
    }
    .card h2{margin:0 0 10px; font-size:16px}
    .muted{color:var(--muted)}
    .sep{height:1px;background:var(--stroke);margin:12px 0}

    /* Tabs content */
    .tabs{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:10px;
    }
    .tab{
      padding:9px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      cursor:pointer;
      font-weight:700;
      font-size:13px;
    }
    .tab.active{background: rgba(127,92,255,.22); border-color: rgba(127,92,255,.45)}
    .view{display:none}
    .view.active{display:block}

    /* Lists */
    .list{display:flex; flex-direction:column; gap:10px}
    .item{
      border:1px solid var(--stroke);
      border-radius: 14px;
      padding:12px;
      background: rgba(255,255,255,.03);
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
    }
    .item .meta{display:flex; flex-direction:column; gap:4px; min-width:0}
    .item .meta b{font-size:14px}
    .item .meta small{color:var(--muted); line-height:1.2}
    .item .actions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 8px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      font-size:12px;
      color:var(--muted);
      max-width:100%;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .badge.ok{color:#d6ffe6; border-color: rgba(46,204,113,.35); background: rgba(46,204,113,.12)}
    .badge.warn{color:#fff6cc; border-color: rgba(241,196,15,.35); background: rgba(241,196,15,.12)}
    .badge.bad{color:#ffd6d2; border-color: rgba(231,76,60,.35); background: rgba(231,76,60,.12)}
    .fields{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    @media (max-width:640px){
      .fields{grid-template-columns:1fr}
    }
    .field label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px}
    .field input,.field textarea,.field select{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      color:var(--text);
      outline:none;
    }
    .field textarea{min-height:90px; resize:vertical}
    .hint{font-size:12px; color:var(--muted); margin-top:8px; line-height:1.4}

    /* Bottom nav */
    .bottom{
      position:fixed;
      left:0; right:0; bottom:0;
      display:flex;
      justify-content:center;
      padding:10px 10px 14px;
      z-index:40;
      pointer-events:none;
    }
    .bottom .nav{
      pointer-events:auto;
      width:min(1100px, 96vw);
      border-radius: 18px;
      border:1px solid var(--stroke);
      background: rgba(20,20,40,.75);
      backdrop-filter: blur(12px);
      box-shadow: var(--shadow);
      display:flex;
      gap:8px;
      padding:8px;
    }
    .nav .navbtn{
      flex:1;
      text-align:center;
      padding:10px 8px;
      border-radius:14px;
      cursor:pointer;
      font-weight:800;
      font-size:12px;
      color:var(--muted);
      border:1px solid transparent;
      user-select:none;
    }
    .nav .navbtn.active{
      color:var(--text);
      border-color: rgba(127,92,255,.45);
      background: rgba(127,92,255,.18);
    }

    /* Modal */
    .modalWrap{
      position:fixed; inset:0;
      display:none;
      align-items:flex-end;
      justify-content:center;
      background: rgba(0,0,0,.45);
      z-index:100;
      padding:14px;
    }
    .modalWrap.show{display:flex}
    .modal{
      width:min(720px, 100%);
      border:1px solid var(--stroke);
      border-radius: 22px;
      background: rgba(20,20,40,.95);
      backdrop-filter: blur(12px);
      box-shadow: var(--shadow);
      padding:14px;
      max-height: 82vh;
      overflow:auto;
    }
    .modal header{display:flex; justify-content:space-between; align-items:center; gap:10px}
    .modal header b{font-size:15px}
    .toast{
      position:fixed;
      top:14px;
      left:50%;
      transform: translateX(-50%);
      z-index:999;
      display:none;
      background: rgba(20,20,40,.92);
      border:1px solid var(--stroke);
      border-radius: 14px;
      padding:10px 12px;
      box-shadow: var(--shadow);
      max-width: 92vw;
      color: var(--text);
    }
    .toast.show{display:block}
    .toast small{color:var(--muted)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  </style>
</head>

<body>
  <div class="toast" id="toast"></div>

  <div class="app">
    <div class="topbar">
      <div class="row">
        <div class="brand">
          <div class="dot"></div>
          <div>
            <b>Freelance Escrow</b><br>
            <span class="muted">Ù…ÙˆÙ‚Ø¹ ÙˆØ³ÙŠØ·: Ø·Ù„Ø¨ + ØªÙ†ÙÙŠØ° + Ø¯ÙØ¹ Pi + Ø³Ø­Ø¨</span>
          </div>
        </div>

        <div class="row" style="gap:8px; flex-wrap:wrap; justify-content:flex-end">
          <div class="pill">
            <small>Ø§Ù„Ø­Ø§Ù„Ø©:</small>
            <b id="statusText">ØºÙŠØ± Ù…ØªØµÙ„</b>
          </div>
          <button class="btn primary" id="btnLogin">ØªØ³Ø¬ÙŠÙ„ / Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Pi</button>
          <button class="btn" id="btnGuest">Ø¯Ø®ÙˆÙ„ ÙƒØ²Ø§Ø¦Ø±</button>
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- Main -->
      <div class="card">
        <div class="tabs">
          <div class="tab active" data-view="market">Ø§Ù„Ø³ÙˆÙ‚</div>
          <div class="tab" data-view="requests">Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
          <div class="tab" data-view="orders">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø§Ø±ÙŠØ©</div>
          <div class="tab" data-view="messages">Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</div>
        </div>

        <!-- Market -->
        <div class="view active" id="view_market">
          <h2>Ø®Ø¯Ù…Ø§Øª Ø¬Ø§Ù‡Ø²Ø© (Gigs)</h2>
          <div class="fields">
            <div class="field">
              <label>Ø¨Ø­Ø«</label>
              <input id="gigSearch" placeholder="Ù…Ø«Ø§Ù„: ØªØµÙ…ÙŠÙ… Ù„ÙˆØ¬Ùˆ / Ø¨Ø±Ù…Ø¬Ø© / Ù…ÙˆÙ†ØªØ§Ø¬..." />
            </div>
            <div class="field">
              <label>ØªØµÙ†ÙŠÙ</label>
              <select id="gigCategory">
                <option value="">Ø§Ù„ÙƒÙ„</option>
                <option>ØªØµÙ…ÙŠÙ…</option>
                <option>Ø¨Ø±Ù…Ø¬Ø©</option>
                <option>Ù…ÙˆÙ†ØªØ§Ø¬</option>
                <option>ÙƒØªØ§Ø¨Ø©</option>
                <option>ØªØ³ÙˆÙŠÙ‚</option>
              </select>
            </div>
          </div>
          <div class="sep"></div>
          <div class="list" id="gigList"></div>

          <div class="hint">
            ğŸ’¡ ÙƒØ¹Ù…ÙŠÙ„: Ø§Ø®ØªØ§Ø± Ø®Ø¯Ù…Ø© ÙˆØ§Ø¶ØºØ· <b>ØªÙˆØ¸ÙŠÙ + Ø¯ÙØ¹ Escrow</b> Ø¹Ø´Ø§Ù† Ø§Ù„ÙÙ„ÙˆØ³ ØªØ¯Ø®Ù„ ÙÙŠ ÙˆØ³ÙŠØ· Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Ù…Ø­ÙØ¸Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚).<br>
            ğŸ’¡ ÙƒÙØ±ÙŠÙ„Ø§Ù†Ø³Ø±: Ø§ÙØªØ­ <b>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</b> Ù…Ù† Ø§Ù„Ø£Ø³ÙÙ„ ÙˆØ§Ø¹Ù…Ù„ Ø®Ø¯Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©.
          </div>
        </div>

        <!-- Requests -->
        <div class="view" id="view_requests">
          <h2>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (Projects)</h2>
          <div class="row" style="gap:8px; flex-wrap:wrap">
            <button class="btn primary" id="btnNewRequest">Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</button>
            <span class="badge">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙŠÙ†Ø´Ø±ÙˆØ§ Ø·Ù„Ø¨Ø§Øªâ€¦ ÙˆØ§Ù„ÙØ±ÙŠÙ„Ø§Ù†Ø³Ø± ÙŠÙ‚Ø¯Ù‘Ù… Ø¹Ø±Ø¶</span>
          </div>
          <div class="sep"></div>
          <div class="list" id="requestList"></div>
        </div>

        <!-- Orders -->
        <div class="view" id="view_orders">
          <h2>Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø§Ø±ÙŠØ© (Escrow)</h2>
          <div class="row" style="gap:8px; flex-wrap:wrap">
            <span class="badge warn">Ø§Ù„Ø¯ÙØ¹: createPayment â†’ approve â†’ complete</span>
            <span class="badge">Ø¨Ø¹Ø¯ Ø§Ù„ØªØ³Ù„ÙŠÙ…: Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙŠØ¶ØºØ· Release Ø¹Ø´Ø§Ù† ØªØªØ³Ø¬Ù„ Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„ÙØ±ÙŠÙ„Ø§Ù†Ø³Ø±</span>
          </div>
          <div class="sep"></div>
          <div class="list" id="orderList"></div>
        </div>

        <!-- Messages -->
        <div class="view" id="view_messages">
          <h2>Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</h2>
          <div class="fields">
            <div class="field">
              <label>Order ID (Ù„Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø·Ù„Ø¨)</label>
              <input id="chatOrderId" placeholder="Ù…Ø«Ø§Ù„: 12" />
            </div>
            <div class="field">
              <label>Ø±Ø³Ø§Ù„Ø©</label>
              <input id="chatText" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." />
            </div>
          </div>
          <div class="row" style="margin-top:10px">
            <button class="btn ok" id="btnSendMsg">Ø¥Ø±Ø³Ø§Ù„</button>
            <button class="btn" id="btnLoadMsgs">ØªØ­Ø¯ÙŠØ«</button>
          </div>
          <div class="sep"></div>
          <div class="list" id="msgList"></div>
        </div>
      </div>

      <!-- Side / Dashboard -->
      <div class="card">
        <h2>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
        <div class="row" style="gap:8px; flex-wrap:wrap">
          <span class="badge" id="whoAmI">Ø¶ÙŠÙ</span>
          <span class="badge" id="roleBadge">Role: Guest</span>
        </div>

        <div class="sep"></div>

        <div class="fields">
          <div class="field">
            <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶</label>
            <input id="profileName" placeholder="Ø§Ø³Ù…Ùƒ / Ø§Ø³Ù… Ø§Ù„Ø¨Ø±Ø§Ù†Ø¯" />
          </div>
          <div class="field">
            <label>ØªØ®ØµØµÙƒ</label>
            <input id="profileTitle" placeholder="Ù…Ø«Ø§Ù„: Ù…ØµÙ…Ù… / Ù…Ø·ÙˆØ± / Ù…Ø³ÙˆÙ‘Ù‚..." />
          </div>
          <div class="field">
            <label>Pi Wallet Address (Ù„Ù„Ø³Ø­Ø¨)</label>
            <input id="profileWallet" placeholder="G..." class="mono" />
          </div>
          <div class="field">
            <label>Ù†Ø¨Ø°Ø©</label>
            <input id="profileBio" placeholder="Ù†Ø¨Ø°Ø© Ù‚ØµÙŠØ±Ø©..." />
          </div>
        </div>

        <div class="row" style="margin-top:10px; gap:8px; flex-wrap:wrap">
          <button class="btn primary" id="btnSaveProfile">Ø­ÙØ¸ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„</button>
          <button class="btn" id="btnReload">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        </div>

        <div class="sep"></div>

        <h2>Ø£Ø¶Ù Ø®Ø¯Ù…Ø© (Gig)</h2>
        <div class="fields">
          <div class="field">
            <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø®Ø¯Ù…Ø©</label>
            <input id="gigTitle" placeholder="Ù…Ø«Ø§Ù„: ØªØµÙ…ÙŠÙ… Ù„ÙˆØ¬Ùˆ Ø§Ø­ØªØ±Ø§ÙÙŠ" />
          </div>
          <div class="field">
            <label>ØªØµÙ†ÙŠÙ</label>
            <select id="gigCatNew">
              <option>ØªØµÙ…ÙŠÙ…</option><option>Ø¨Ø±Ù…Ø¬Ø©</option><option>Ù…ÙˆÙ†ØªØ§Ø¬</option><option>ÙƒØªØ§Ø¨Ø©</option><option>ØªØ³ÙˆÙŠÙ‚</option>
            </select>
          </div>
          <div class="field">
            <label>Ø§Ù„Ø³Ø¹Ø± (Pi)</label>
            <input id="gigPrice" type="number" step="0.01" placeholder="Ù…Ø«Ø§Ù„: 5" />
          </div>
          <div class="field">
            <label>Ù…Ø¯Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ… (Ø£ÙŠØ§Ù…)</label>
            <input id="gigDays" type="number" placeholder="Ù…Ø«Ø§Ù„: 3" />
          </div>
          <div class="field" style="grid-column:1/-1">
            <label>ÙˆØµÙ</label>
            <textarea id="gigDesc" placeholder="Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø©â€¦"></textarea>
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn ok" id="btnCreateGig">Ù†Ø´Ø± Ø§Ù„Ø®Ø¯Ù…Ø©</button>
        </div>

        <div class="sep"></div>

        <h2>Ø§Ù„Ù…Ø­ÙØ¸Ø© (Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ ÙˆØ§Ù„Ø³Ø­Ø¨)</h2>
        <div class="row" style="gap:8px; flex-wrap:wrap">
          <span class="badge ok">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø­: <b id="balanceText">0</b> Pi</span>
          <span class="badge">Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ù…Ù†ØµØ©: <b id="feeText">10%</b></span>
        </div>
        <div class="fields" style="margin-top:10px">
          <div class="field">
            <label>Ù…Ø¨Ù„Øº Ø§Ù„Ø³Ø­Ø¨ (Pi)</label>
            <input id="withdrawAmount" type="number" step="0.01" placeholder="Ù…Ø«Ø§Ù„: 1.5" />
          </div>
          <div class="field">
            <label>Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
            <input id="withdrawTo" placeholder="Pi Wallet Address" class="mono" />
          </div>
        </div>
        <div class="row" style="margin-top:10px; gap:8px; flex-wrap:wrap">
          <button class="btn primary" id="btnWithdraw">Ø³Ø­Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</button>
        </div>

        <div class="hint">
          âš ï¸ Ø§Ù„Ø³Ø­Ø¨ Ø¨ÙŠØ³ØªØ®Ø¯Ù… Ø¨Ø§Ùƒ Ø¥Ù†Ø¯Ùƒ (Stellar/Pi Testnet) ÙˆØ¨ÙŠØ­Ø³Ø¨ Ø§Ù„Ø±ØµÙŠØ¯ Ù…Ù† Ø¬Ø¯ÙˆÙ„ <b>donations</b> Ù…Ø·Ø±ÙˆØ­ Ù…Ù†Ù‡ <b>withdrawals</b> (Ø²ÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù„ÙŠ Ø¹Ù†Ø¯Ùƒ).<br>
          Ø¥Ø­Ù†Ø§ Ù‡Ù†Ø³ØªØºÙ„ <b>donations</b> ÙƒÙ€ â€œledger Ù„Ù„Ø£Ø±Ø¨Ø§Ø­â€ Ø¨Ø¹Ø¯ Ù…Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙŠØ¹Ù…Ù„ Release.
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom nav -->
  <div class="bottom">
    <div class="nav">
      <div class="navbtn active" data-view="market">Ø§Ù„Ø³ÙˆÙ‚</div>
      <div class="navbtn" data-view="requests">Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
      <div class="navbtn" data-view="orders">Ø§Ù„Ù€ Escrow</div>
      <div class="navbtn" data-view="messages">Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</div>
      <div class="navbtn" id="navDash">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modalWrap" id="modalWrap">
    <div class="modal" id="modal">
      <header>
        <b id="modalTitle">Modal</b>
        <button class="btn" id="btnCloseModal">Ø¥ØºÙ„Ø§Ù‚</button>
      </header>
      <div class="sep"></div>
      <div id="modalBody"></div>
    </div>
  </div>

<script>
/** ===========================
 *  CONFIG
 *  =========================== */
const SUPABASE_URL = "https://axjkwrssmofzavaoqutq.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_tiuMncgWhf1YRWoD-uYQ3Q_ziI8OKci";

/**
 * Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ Netlify redirects Ø²ÙŠ Ø§Ù„Ù„ÙŠ Ø§Ù†Øª ÙƒØ§ØªØ¨Ù‡:
 * /api/pi/approve -> /.netlify/functions/approve
 * /api/pi/complete -> /.netlify/functions/complete
 * ÙˆØ®Ù„Ù‘ÙŠ Ø§Ù„Ø³Ø­Ø¨:
 * /api/withdraw -> /.netlify/functions/withdraw
 */
const API_BASE = ""; // ÙØ§Ø¶ÙŠ = Ù†ÙØ³ Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ†

const PLATFORM_FEE = 0.10; // 10% Ø¹Ù…ÙˆÙ„Ø©

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/** ===========================
 *  STATE
 *  =========================== */
let state = {
  user: null, // {uid, username, isGuest}
  profile: null,
  gigs: [],
  requests: [],
  orders: [],
};

const $ = (id)=>document.getElementById(id);

function toast(html, ms=2600){
  const t = $("toast");
  t.innerHTML = html;
  t.classList.add("show");
  clearTimeout(toast._t);
  toast._t = setTimeout(()=>t.classList.remove("show"), ms);
}

function setStatus(text){
  $("statusText").textContent = text;
}

function requireUser(){
  if(!state.user){
    toast("<b>Ù„Ø§Ø²Ù… ØªØ³Ø¬Ù„ Ø¯Ø®ÙˆÙ„</b><br><small>Ø§Ø¶ØºØ· ØªØ³Ø¬ÙŠÙ„ / Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Pi Ø£Ùˆ Ø¯Ø®ÙˆÙ„ ÙƒØ²Ø§Ø¦Ø±</small>");
    throw new Error("Not logged in");
  }
}

/** ===========================
 *  NAV / VIEWS
 *  =========================== */
function setView(name){
  document.querySelectorAll(".tab").forEach(t=>t.classList.toggle("active", t.dataset.view===name));
  document.querySelectorAll(".navbtn").forEach(t=>t.classList.toggle("active", t.dataset.view===name));
  document.querySelectorAll(".view").forEach(v=>v.classList.toggle("active", v.id==="view_"+name));
}

document.querySelectorAll(".tab").forEach(t=>{
  t.addEventListener("click", ()=> setView(t.dataset.view));
});
document.querySelectorAll(".navbtn").forEach(t=>{
  if(t.id==="navDash") return;
  t.addEventListener("click", ()=> setView(t.dataset.view));
});
$("navDash").addEventListener("click", ()=>{
  toast("<b>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</b><br><small>Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ† / ØªØ­Øª Ø­Ø³Ø¨ Ø­Ø¬Ù… Ø§Ù„Ø´Ø§Ø´Ø©</small>", 1800);
});

/** ===========================
 *  MODAL
 *  =========================== */
function openModal(title, bodyHTML){
  $("modalTitle").textContent = title;
  $("modalBody").innerHTML = bodyHTML;
  $("modalWrap").classList.add("show");
}
function closeModal(){ $("modalWrap").classList.remove("show"); }
$("btnCloseModal").addEventListener("click", closeModal);
$("modalWrap").addEventListener("click", (e)=>{ if(e.target.id==="modalWrap") closeModal(); });

/** ===========================
 *  PI LOGIN (supports old & newer styles)
 *  =========================== */
async function piLogin(){
  if(!window.Pi){
    toast("<b>Pi SDK Ù…Ø´ Ù…ØªØ§Ø­</b><br><small>Ø§ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Pi Browser Ø£Ùˆ ÙØ¹Ù‘Ù„ sdk.minepi.com</small>", 3500);
    return;
  }

  // Ø¨Ø¹Ø¶ Ø§Ù„Ø¥ØµØ¯Ø§Ø±Ø§Øª: Pi.authenticate(scopes, onIncompletePaymentFound)
  // ÙˆØ¨Ø¹Ø¶Ù‡Ø§: Pi.connect()
  try{
    setStatus("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...");
    let authRes = null;

    if(typeof Pi.authenticate === "function"){
      // scopes Ù…Ù…ÙƒÙ† ØªÙƒÙˆÙ†: ["username","payments"]
      authRes = await Pi.authenticate(["username","payments"], (payment)=> {
        // optional: handle incomplete payments
        console.log("Incomplete payment:", payment);
      });
      // authRes: { user: { uid, username }, accessToken, ... }
    } else if(typeof Pi.connect === "function"){
      authRes = await Pi.connect();
      // Ø¨Ø¹Ø¶ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª ØªØ®Ø²Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Pi.user
    }

    const u = authRes?.user || Pi?.user || Pi?.PiSdkBase?.user;
    if(!u?.uid){
      setStatus("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„");
      toast("<b>ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</b><br><small>Ø¬Ø±Ù‘Ø¨ ØªØ§Ù†ÙŠ Ù…Ù† Pi Browser</small>", 3500);
      return;
    }

    state.user = { uid: u.uid, username: u.username || "pi-user", isGuest:false };
    $("whoAmI").textContent = `@${state.user.username}`;
    $("roleBadge").textContent = "Role: User";
    setStatus("Ù…ØªØµÙ„ Ø¨Ù€ Pi");
    toast("<b>ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</b><br><small>Ø¯Ù„ÙˆÙ‚ØªÙŠ ØªÙ‚Ø¯Ø± ØªØ¯ÙØ¹ ÙˆØªØªØ¹Ø§Ù…Ù„ ÙƒÙØ±ÙŠÙ„Ø§Ù†Ø³Ø±/Ø¹Ù…ÙŠÙ„</small>");

    await ensureProfile();
    await reloadAll();
  }catch(err){
    console.error(err);
    setStatus("ØºÙŠØ± Ù…ØªØµÙ„");
    toast("<b>Ø­ØµÙ„ Ø®Ø·Ø£</b><br><small>"+(err?.message||"")+"</small>", 3500);
  }
}

function guestLogin(){
  const gid = "guest_" + Math.random().toString(16).slice(2,10);
  state.user = { uid: gid, username: "guest", isGuest:true };
  $("whoAmI").textContent = `Guest`;
  $("roleBadge").textContent = "Role: Guest";
  setStatus("Ø²Ø§Ø¦Ø±");
  toast("<b>Ø¯Ø®Ù„Øª ÙƒØ²Ø§Ø¦Ø±</b><br><small>ØªÙ‚Ø¯Ø± ØªØªØµÙØ­ ÙˆØªØ¹Ù…Ù„ Ø·Ù„Ø¨/ØªÙˆØ¸ÙŠÙØŒ Ø§Ù„Ø¯ÙØ¹ ÙŠØ­ØªØ§Ø¬ Pi</small>", 3200);
  ensureProfile().then(reloadAll);
}

$("btnLogin").addEventListener("click", piLogin);
$("btnGuest").addEventListener("click", guestLogin);

/** ===========================
 *  SUPABASE HELPERS
 *  =========================== */
async function ensureProfile(){
  requireUser();
  const uid = state.user.uid;

  const { data, error } = await sb.from("profiles").select("*").eq("pi_user_id", uid).maybeSingle();
  if(error){ console.warn(error); }

  if(!data){
    const payload = {
      pi_user_id: uid,
      username: state.user.username,
      display_name: state.user.username,
      title: "",
      bio: "",
      wallet_address: "",
      created_at: new Date().toISOString()
    };
    const ins = await sb.from("profiles").insert(payload).select().single();
    state.profile = ins.data || payload;
  } else {
    state.profile = data;
  }

  // fill UI
  $("profileName").value = state.profile.display_name || "";
  $("profileTitle").value = state.profile.title || "";
  $("profileBio").value = state.profile.bio || "";
  $("profileWallet").value = state.profile.wallet_address || "";
  $("withdrawTo").value = state.profile.wallet_address || "";

  $("feeText").textContent = Math.round(PLATFORM_FEE*100) + "%";
}

async function reloadAll(){
  await Promise.all([loadGigs(), loadRequests(), loadOrders(), refreshBalance()]);
}

$("btnReload").addEventListener("click", reloadAll);

$("btnSaveProfile").addEventListener("click", async ()=>{
  try{
    requireUser();
    const uid = state.user.uid;
    const payload = {
      pi_user_id: uid,
      username: state.user.username,
      display_name: $("profileName").value.trim(),
      title: $("profileTitle").value.trim(),
      bio: $("profileBio").value.trim(),
      wallet_address: $("profileWallet").value.trim(),
      updated_at: new Date().toISOString()
    };
    const { error } = await sb.from("profiles").upsert(payload, { onConflict: "pi_user_id" });
    if(error) throw error;
    toast("<b>ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„</b><br><small>Ø¬Ø§Ù‡Ø² Ù„Ù„Ø´ØºÙ„</small>");
    await ensureProfile();
  }catch(err){
    console.error(err);
    toast("<b>Ø®Ø·Ø£</b><br><small>"+(err.message||"")+"</small>", 3500);
  }
});

/** ===========================
 *  GIGS
 *  =========================== */
async function loadGigs(){
  const q = $("gigSearch").value.trim();
  const cat = $("gigCategory").value.trim();

  let query = sb.from("gigs").select("*").order("created_at", { ascending:false }).limit(50);
  if(q) query = query.ilike("title", `%${q}%`);
  if(cat) query = query.eq("category", cat);

  const { data, error } = await query;
  if(error){ console.warn(error); state.gigs=[]; }
  else state.gigs = data || [];

  renderGigs();
}

function renderGigs(){
  const el = $("gigList");
  if(!state.gigs.length){
    el.innerHTML = `<div class="item"><div class="meta"><b>Ù…ÙÙŠØ´ Ø®Ø¯Ù…Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</b><small class="muted">Ø§Ø¨Ø¯Ø£ ÙˆØ§Ø¹Ù…Ù„ Ø®Ø¯Ù…Ø© Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</small></div></div>`;
    return;
  }

  el.innerHTML = state.gigs.map(g=>{
    const price = Number(g.price_pi||0).toFixed(2);
    const days = g.delivery_days || 0;
    return `
      <div class="item">
        <div class="meta" style="min-width:0">
          <b>${escapeHtml(g.title||"")}</b>
          <small>${escapeHtml(g.description||"")}</small>
          <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:6px">
            <span class="badge">ØªØµÙ†ÙŠÙ: <b>${escapeHtml(g.category||"")}</b></span>
            <span class="badge ok">Ø§Ù„Ø³Ø¹Ø±: <b>${price}</b> Pi</span>
            <span class="badge warn">ØªØ³Ù„ÙŠÙ…: <b>${days}</b> ÙŠÙˆÙ…</span>
            <span class="badge">Seller: <b>@${escapeHtml(g.seller_username||"")}</b></span>
          </div>
        </div>
        <div class="actions">
          <button class="btn primary" onclick="hireGig(${g.id})">ØªÙˆØ¸ÙŠÙ + Ø¯ÙØ¹ Escrow</button>
        </div>
      </div>
    `;
  }).join("");
}

$("gigSearch").addEventListener("input", debounce(loadGigs, 250));
$("gigCategory").addEventListener("change", loadGigs);

$("btnCreateGig").addEventListener("click", async ()=>{
  try{
    requireUser();
    if(!state.profile) await ensureProfile();

    const title = $("gigTitle").value.trim();
    const desc = $("gigDesc").value.trim();
    const category = $("gigCatNew").value.trim();
    const price = parseFloat($("gigPrice").value || "0");
    const days = parseInt($("gigDays").value || "0", 10);

    if(!title || !desc || !category || !(price>0)){
      toast("<b>Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©</b><br><small>Ø§ÙƒØªØ¨ Ø¹Ù†ÙˆØ§Ù† ÙˆÙˆØµÙ ÙˆØ³Ø¹Ø±</small>", 3000);
      return;
    }

    const payload = {
      title, description: desc, category,
      price_pi: price,
      delivery_days: days || 3,
      seller_id: state.user.uid,
      seller_username: state.user.username,
      created_at: new Date().toISOString()
    };

    const { error } = await sb.from("gigs").insert(payload);
    if(error) throw error;

    $("gigTitle").value=""; $("gigDesc").value=""; $("gigPrice").value=""; $("gigDays").value="";
    toast("<b>ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø®Ø¯Ù…Ø©</b><br><small>Ù‡ØªØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ø³ÙˆÙ‚</small>");
    await loadGigs();
  }catch(err){
    console.error(err);
    toast("<b>Ø®Ø·Ø£</b><br><small>"+(err.message||"")+"</small>", 3500);
  }
});

async function hireGig(gigId){
  try{
    requireUser();
    if(state.user.isGuest){
      openModal("Ù„Ø§Ø²Ù… Pi Ù„Ù„Ø¯ÙØ¹", `
        <div class="muted">ØªÙ‚Ø¯Ø± ØªØªØµÙØ­ ÙƒØ²Ø§Ø¦Ø±â€¦ Ù„ÙƒÙ† Ø§Ù„Ø¯ÙØ¹ Escrow ÙŠØ­ØªØ§Ø¬ ØªØ³Ø¬ÙŠÙ„ Pi.</div>
        <div class="sep"></div>
        <button class="btn primary" onclick="closeModal(); piLogin();">Ø³Ø¬Ù„ Ø¨Ù€ Pi</button>
      `);
      return;
    }

    const gig = state.gigs.find(x=>x.id===gigId);
    if(!gig) return;

    openModal("ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªÙˆØ¸ÙŠÙ ÙˆØ§Ù„Ø¯ÙØ¹ Escrow", `
      <div class="item">
        <div class="meta">
          <b>${escapeHtml(gig.title)}</b>
          <small>${escapeHtml(gig.description)}</small>
          <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px">
            <span class="badge ok">Ø§Ù„Ù…Ø¨Ù„Øº: <b>${Number(gig.price_pi).toFixed(2)}</b> Pi</span>
            <span class="badge">Seller: <b>@${escapeHtml(gig.seller_username)}</b></span>
          </div>
        </div>
      </div>

      <div class="sep"></div>

      <div class="fields">
        <div class="field" style="grid-column:1/-1">
          <label>Ù…ØªØ·Ù„Ø¨Ø§ØªÙƒ</label>
          <textarea id="orderRequirements" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø¨Ø§Ù„ØªÙØµÙŠÙ„â€¦"></textarea>
        </div>
      </div>

      <div class="row" style="margin-top:10px; gap:8px; flex-wrap:wrap">
        <button class="btn ok" onclick="createOrderAndPay(${gig.id})">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨ + Ø¯ÙØ¹</button>
        <button class="btn" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
      </div>

      <div class="hint">
        Ø§Ù„Ø¯ÙØ¹ Ù‡ÙŠØ¹Ù…Ù„ createPaymentØŒ ÙˆØ¨Ø¹Ø¯Ù‡Ø§ Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯ Ù‡ÙŠØ¹Ù…Ù„ approve/complete ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† callbacks.
      </div>
    `);

  }catch(err){
    console.error(err);
  }
}

async function createOrderAndPay(gigId){
  try{
    requireUser();
    const gig = state.gigs.find(x=>x.id===gigId);
    const req = (document.getElementById("orderRequirements")?.value || "").trim();
    if(!req){
      toast("<b>Ø§ÙƒØªØ¨ Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª</b><br><small>Ø¹Ø´Ø§Ù† Ø§Ù„Ø·Ù„Ø¨ ÙŠØ¨Ù‚Ù‰ ÙˆØ§Ø¶Ø­</small>");
      return;
    }

    // 1) create order in DB
    const payload = {
      gig_id: gig.id,
      buyer_id: state.user.uid,
      buyer_username: state.user.username,
      seller_id: gig.seller_id,
      seller_username: gig.seller_username,
      amount_pi: gig.price_pi,
      requirements: req,
      status: "pending_payment",
      created_at: new Date().toISOString()
    };

    const ins = await sb.from("orders").insert(payload).select().single();
    if(ins.error) throw ins.error;

    closeModal();
    toast("<b>ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨</b><br><small>Ù‡Ù†Ø¨Ø¯Ø£ Ø§Ù„Ø¯ÙØ¹ Escrow</small>");

    // 2) start Pi payment
    await startPiPaymentForOrder(ins.data);

  }catch(err){
    console.error(err);
    toast("<b>Ø®Ø·Ø£</b><br><small>"+(err.message||"")+"</small>", 3500);
  }
}

async function startPiPaymentForOrder(order){
  if(!window.Pi) throw new Error("Pi SDK not available");
  if(typeof Pi.createPayment !== "function") throw new Error("Pi.createPayment ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");

  const amount = Number(order.amount_pi);
  const memo = `order_${order.id}`; // Ù…Ù‡Ù…: memo Ù‚ØµÙŠØ± ÙˆÙˆØ§Ø¶Ø­
  const metadata = { order_id: order.id, seller_id: order.seller_id, buyer_id: order.buyer_id };

  // Pi SDK: createPayment(paymentData, callbacks)
  // docs show paymentCallbacks incl: onReadyForServerApproval, onReadyForServerCompletion, onCancel, onError î¨1î¨‚
  return Pi.createPayment({
    amount,
    memo,
    metadata,
  }, {
    onReadyForServerApproval: async (paymentId) => {
      try{
        toast("<b>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¯ÙØ¹</b><br><small>Approve...</small>", 2200);
        await apiPost("/api/pi/approve", { paymentId });
        await sb.from("orders").update({ payment_id: paymentId }).eq("id", order.id);
      }catch(e){
        console.error(e);
        toast("<b>Approve ÙØ´Ù„</b><br><small>"+(e.message||"")+"</small>", 3500);
        throw e;
      }
    },
    onReadyForServerCompletion: async (paymentId, txid) => {
      try{
        toast("<b>Ø¬Ø§Ø±ÙŠ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¯ÙØ¹</b><br><small>Complete...</small>", 2200);
        const res = await apiPost("/api/pi/complete", { paymentId, txid });
        await sb.from("orders").update({
          payment_id: paymentId,
          txid,
          status: "paid",
          paid_at: new Date().toISOString()
        }).eq("id", order.id);

        toast("<b>ØªÙ… Ø§Ù„Ø¯ÙØ¹ âœ…</b><br><small>Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù‚Ù‰ Paid ÙÙŠ Escrow</small>", 3200);
        await loadOrders();
      }catch(e){
        console.error(e);
        toast("<b>Complete ÙØ´Ù„</b><br><small>"+(e.message||"")+"</small>", 3500);
        throw e;
      }
    },
    onCancel: async () => {
      toast("<b>ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¯ÙØ¹</b><br><small>Ø§Ù„Ø·Ù„Ø¨ Ù„Ø³Ù‡ Pending</small>", 3000);
    },
    onError: async (err) => {
      console.error(err);
      toast("<b>Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¯ÙØ¹</b><br><small>"+(err?.message||"")+"</small>", 3500);
    }
  });
}

/** ===========================
 *  REQUESTS (Projects)
 *  =========================== */
$("btnNewRequest").addEventListener("click", ()=>{
  try{
    requireUser();
    openModal("Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯", `
      <div class="fields">
        <div class="field">
          <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø·Ù„Ø¨</label>
          <input id="reqTitle" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø­ØªØ§Ø¬ ØªØµÙ…ÙŠÙ… UI Ù„ØµÙØ­Ø© Landing" />
        </div>
        <div class="field">
          <label>ØªØµÙ†ÙŠÙ</label>
          <select id="reqCat">
            <option>ØªØµÙ…ÙŠÙ…</option><option>Ø¨Ø±Ù…Ø¬Ø©</option><option>Ù…ÙˆÙ†ØªØ§Ø¬</option><option>ÙƒØªØ§Ø¨Ø©</option><option>ØªØ³ÙˆÙŠÙ‚</option>
          </select>
        </div>
        <div class="field">
          <label>Ù…ÙŠØ²Ø§Ù†ÙŠØ© (Pi)</label>
          <input id="reqBudget" type="number" step="0.01" placeholder="Ù…Ø«Ø§Ù„: 8" />
        </div>
        <div class="field">
          <label>Ù…Ø¯Ø© (Ø£ÙŠØ§Ù…)</label>
          <input id="reqDays" type="number" placeholder="Ù…Ø«Ø§Ù„: 5" />
        </div>
        <div class="field" style="grid-column:1/-1">
          <label>ØªÙØ§ØµÙŠÙ„</label>
          <textarea id="reqDesc" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø¨Ø§Ù„ØªÙØµÙŠÙ„â€¦"></textarea>
        </div>
      </div>
      <div class="row" style="margin-top:10px; gap:8px; flex-wrap:wrap">
        <button class="btn ok" onclick="createRequest()">Ù†Ø´Ø± Ø§Ù„Ø·Ù„Ø¨</button>
        <button class="btn" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    `);
  }catch(e){}
});

async function createRequest(){
  try{
    requireUser();
    const title = $("reqTitle").value.trim();
    const category = $("reqCat").value.trim();
    const budget = parseFloat($("reqBudget").value || "0");
    const days = parseInt($("reqDays").value || "0",10);
    const desc = $("reqDesc").value.trim();

    if(!title || !desc || !(budget>0)){
      toast("<b>Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©</b><br><small>Ø§ÙƒØªØ¨ Ø¹Ù†ÙˆØ§Ù†/ØªÙØ§ØµÙŠÙ„/Ù…ÙŠØ²Ø§Ù†ÙŠØ©</small>", 3200);
      return;
    }

    const payload = {
      title, category, budget_pi: budget,
      expected_days: days||5,
      description: desc,
      buyer_id: state.user.uid,
      buyer_username: state.user.username,
      status: "open",
      created_at: new Date().toISOString()
    };

    const { error } = await sb.from("requests").insert(payload);
    if(error) throw error;

    closeModal();
    toast("<b>ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø·Ù„Ø¨</b><br><small>Ø§Ù„ÙØ±ÙŠÙ„Ø§Ù†Ø³Ø± ÙŠÙ‚Ø¯Ø± ÙŠÙ‚Ø¯Ù‘Ù… Ø¹Ø±Ø¶</small>");
    await loadRequests();
  }catch(err){
    console.error(err);
    toast("<b>Ø®Ø·Ø£</b><br><small>"+(err.message||"")+"</small>", 3500);
  }
}

async function loadRequests(){
  const { data, error } = await sb.from("requests").select("*").order("created_at",{ascending:false}).limit(50);
  if(error){ console.warn(error); state.requests=[]; }
  else state.requests = data || [];
  renderRequests();
}

function renderRequests(){
  const el = $("requestList");
  if(!state.requests.length){
    el.innerHTML = `<div class="item"><div class="meta"><b>Ù…ÙÙŠØ´ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</b><small class="muted">Ø§Ù†Ø´Ø± Ø£ÙˆÙ„ Ø·Ù„Ø¨</small></div></div>`;
    return;
  }

  el.innerHTML = state.requests.map(r=>{
    const budget = Number(r.budget_pi||0).toFixed(2);
    const isOwner = state.user && r.buyer_id === state.user.uid;
    return `
      <div class="item">
        <div class="meta" style="min-width:0">
          <b>${escapeHtml(r.title||"")}</b>
          <small>${escapeHtml(r.description||"")}</small>
          <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:6px">
            <span class="badge">ØªØµÙ†ÙŠÙ: <b>${escapeHtml(r.category||"")}</b></span>
            <span class="badge ok">Ù…ÙŠØ²Ø§Ù†ÙŠØ©: <b>${budget}</b> Pi</span>
            <span class="badge warn">Ù…Ø¯Ø©: <b>${r.expected_days||0}</b> ÙŠÙˆÙ…</span>
            <span class="badge">Buyer: <b>@${escapeHtml(r.buyer_username||"")}</b></span>
            <span class="badge ${r.status==='open'?'ok':'warn'}">Status: <b>${escapeHtml(r.status||"")}</b></span>
          </div>
        </div>
        <div class="actions">
          <button class="btn primary" onclick="openOffer(${r.id})">Ù‚Ø¯Ù‘Ù… Ø¹Ø±Ø¶</button>
          ${isOwner ? `<button class="btn" onclick="viewOffers(${r.id})">Ø´ÙˆÙ Ø§Ù„Ø¹Ø±ÙˆØ¶</button>` : ``}
        </div>
      </div>
    `;
  }).join("");
}

async function openOffer(requestId){
  try{
    requireUser();
    const r = state.requests.find(x=>x.id===requestId);
    if(!r) return;

    openModal("ØªÙ‚Ø¯ÙŠÙ… Ø¹Ø±Ø¶", `
      <div class="item">
        <div class="meta">
          <b>${escapeHtml(r.title)}</b>
          <small class="muted">Ù…ÙŠØ²Ø§Ù†ÙŠØ©: ${Number(r.budget_pi).toFixed(2)} Pi</small>
        </div>
      </div>
      <div class="sep"></div>
      <div class="fields">
        <div class="field">
          <label>Ø§Ù„Ø³Ø¹Ø± (Pi)</label>
          <input id="offerPrice" type="number" step="0.01" value="${Number(r.budget_pi).toFixed(2)}" />
        </div>
        <div class="field">
          <label>Ø§Ù„Ù…Ø¯Ø© (Ø£ÙŠØ§Ù…)</label>
          <input id="offerDays" type="number" value="${r.expected_days||5}" />
        </div>
        <div class="field" style="grid-column:1/-1">
          <label>Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¹Ø±Ø¶</label>
          <textarea id="offerMsg" placeholder="Ø§Ø´Ø±Ø­ Ù‡ØªØ³Ù„Ù… Ø§Ø²Ø§ÙŠâ€¦"></textarea>
        </div>
      </div>
      <div class="row" style="margin-top:10px; gap:8px; flex-wrap:wrap">
        <button class="btn ok" onclick="submitOffer(${r.id})">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ø±Ø¶</button>
        <button class="btn" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    `);
  }catch(e){}
}

async function submitOffer(requestId){
  try{
    requireUser();
    const price = parseFloat($("offerPrice").value || "0");
    const days = parseInt($("offerDays").value || "0",10);
    const msg = $("offerMsg").value.trim();
    if(!(price>0) || !msg){
      toast("<b>Ø§ÙƒØªØ¨ Ø§Ù„Ø³Ø¹Ø± ÙˆØ§Ù„Ø±Ø³Ø§Ù„Ø©</b>", 2500);
      return;
    }
    const payload = {
      request_id: requestId,
      seller_id: state.user.uid,
      seller_username: state.user.username,
      price_pi: price,
      delivery_days: days||5,
      message: msg,
      status: "sent",
      created_at: new Date().toISOString()
    };
    const { error } = await sb.from("offers").insert(payload);
    if(error) throw error;

    closeModal();
    toast("<b>ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ø±Ø¶</b><br><small>Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙŠÙ‚Ø¯Ø± ÙŠÙ‚Ø¨Ù„</small>");
  }catch(err){
    console.error(err);
    toast("<b>Ø®Ø·Ø£</b><br><small>"+(err.message||"")+"</small>", 3500);
  }
}

async function viewOffers(requestId){
  try{
    requireUser();
    const { data, error } = await sb.from("offers").select("*").eq("request_id", requestId).order("created_at",{ascending:false});
    if(error) throw error;

    const r = state.requests.find(x=>x.id===requestId);
    const html = `
      <div class="item"><div class="meta">
        <b>${escapeHtml(r?.title||("Request #"+requestId))}</b>
        <small class="muted">Ø§Ø®ØªØ± Ø¹Ø±Ø¶ ÙˆØ§Ø¹Ù…Ù„ Ø¹Ù‚Ø¯ (Order) + Escrow</small>
      </div></div>
      <div class="sep"></div>
      <div class="list">
        ${(data||[]).map(o=>`
          <div class="item">
            <div class="meta">
              <b>@${escapeHtml(o.seller_username||"")}</b>
              <small>${escapeHtml(o.message||"")}</small>
              <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:6px">
                <span class="badge ok">Ø§Ù„Ø³Ø¹Ø±: <b>${Number(o.price_pi).toFixed(2)}</b> Pi</span>
                <span class="badge warn">Ø§Ù„Ù…Ø¯Ø©: <b>${o.delivery_days||0}</b> ÙŠÙˆÙ…</span>
              </div>
            </div>
            <div class="actions">
              <button class="btn primary" onclick="acceptOffer(${requestId}, ${o.id})">Ù‚Ø¨ÙˆÙ„ + Ø¥Ù†Ø´Ø§Ø¡ Order</button>
            </div>
          </div>
        `).join("") || `<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶</div>`}
      </div>
    `;
    openModal("Ø§Ù„Ø¹Ø±ÙˆØ¶", html);
  }catch(err){
    console.error(err);
    toast("<b>Ø®Ø·Ø£</b><br><small>"+(err.message||"")+"</small>", 3500);
  }
}

async function acceptOffer(requestId, offerId){
  try{
    requireUser();
    if(state.user.isGuest){
      toast("<b>Ù„Ø§Ø²Ù… Pi Ø¹Ø´Ø§Ù† ØªÙƒÙ…Ù„</b>", 2500);
      return;
    }

    const offer = (await sb.from("offers").select("*").eq("id", offerId).single()).data;
    const req = (await sb.from("requests").select("*").eq("id", requestId).single()).data;
    if(!offer || !req) throw new Error("Offer/Request not found");

    // create order from offer
    const payload = {
      request_id: requestId,
      offer_id: offerId,
      buyer_id: req.buyer_id,
      buyer_username: req.buyer_username,
      seller_id: offer.seller_id,
      seller_username: offer.seller_username,
      amount_pi: offer.price_pi,
      requirements: req.description,
      status: "pending_payment",
      created_at: new Date().toISOString()
    };

    const ins = await sb.from("orders").insert(payload).select().single();
    if(ins.error) throw ins.error;

    // close request
    await sb.from("requests").update({ status: "in_progress" }).eq("id", requestId);
    await sb.from("offers").update({ status: "accepted" }).eq("id", offerId);

    closeModal();
    toast("<b>ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Order</b><br><small>Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¯ÙØ¹ Escrow</small>");

    await startPiPaymentForOrder(ins.data);
    await loadOrders();
    await loadRequests();
  }catch(err){
    console.error(err);
    toast("<b>Ø®Ø·Ø£</b><br><small>"+(err.message||"")+"</small>", 3500);
  }
}

/** ===========================
 *  ORDERS (ESCROW)
 *  =========================== */
async function loadOrders(){
  // Ù„Ùˆ user Ù…ÙˆØ¬ÙˆØ¯: Ù†Ø¬ÙŠØ¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù„ÙŠ Ù‡Ùˆ Ø·Ø±Ù ÙÙŠÙ‡Ø§
  if(!state.user){
    state.orders = [];
    renderOrders();
    return;
  }

  const uid = state.user.uid;
  const { data, error } = await sb
    .from("orders")
    .select("*")
    .or(`buyer_id.eq.${uid},seller_id.eq.${uid}`)
    .order("created_at",{ascending:false})
    .limit(80);

  if(error){ console.warn(error); state.orders=[]; }
  else state.orders = data || [];
  renderOrders();
}

function renderOrders(){
  const el = $("orderList");
  if(!state.user){
    el.innerHTML = `<div class="item"><div class="meta"><b>Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„</b><small class="muted">Ø¹Ø´Ø§Ù† ØªØ´ÙˆÙ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</small></div></div>`;
    return;
  }
  if(!state.orders.length){
    el.innerHTML = `<div class="item"><div class="meta"><b>Ù…ÙÙŠØ´ Orders</b><small class="muted">Ø§Ø¨Ø¯Ø£ Ø¨ØªÙˆØ¸ÙŠÙ Ø®Ø¯Ù…Ø© Ø£Ùˆ Ù‚Ø¨ÙˆÙ„ Ø¹Ø±Ø¶</small></div></div>`;
    return;
  }

  el.innerHTML = state.orders.map(o=>{
    const mineBuyer = o.buyer_id === state.user.uid;
    const mineSeller = o.seller_id === state.user.uid;
    const amount = Number(o.amount_pi||0).toFixed(2);

    const statusClass =
      o.status==="paid" ? "ok" :
      o.status==="released" ? "ok" :
      o.status==="delivered" ? "warn" :
      o.status==="disputed" ? "bad" :
      "warn";

    return `
      <div class="item">
        <div class="meta" style="min-width:0">
          <b>Order #${o.id} â€¢ ${mineBuyer ? "Ø£Ù†Øª Ø§Ù„Ø¹Ù…ÙŠÙ„" : "Ø£Ù†Øª Ø§Ù„ÙØ±ÙŠÙ„Ø§Ù†Ø³Ø±"}</b>
          <small>${escapeHtml(o.requirements||"")}</small>
          <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:6px">
            <span class="badge ok">Ø§Ù„Ù…Ø¨Ù„Øº: <b>${amount}</b> Pi</span>
            <span class="badge ${statusClass}">Status: <b>${escapeHtml(o.status||"")}</b></span>
            <span class="badge">Buyer: <b>@${escapeHtml(o.buyer_username||"")}</b></span>
            <span class="badge">Seller: <b>@${escapeHtml(o.seller_username||"")}</b></span>
            ${o.payment_id ? `<span class="badge mono">paymentId: ${escapeHtml(o.payment_id)}</span>` : ``}
            ${o.txid ? `<span class="badge mono">txid: ${escapeHtml(o.txid)}</span>` : ``}
          </div>
        </div>
        <div class="actions">
          ${mineBuyer && o.status==="pending_payment" ? `<button class="btn primary" onclick="resumePay(${o.id})">Ø§Ø¯ÙØ¹ Escrow</button>` : ``}
          ${mineSeller && o.status==="paid" ? `<button class="btn ok" onclick="markDelivered(${o.id})">ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</button>` : ``}
          ${mineBuyer && o.status==="delivered" ? `<button class="btn ok" onclick="releasePayment(${o.id})">Release (ØµØ±Ù Ù„Ù„ÙØ±ÙŠÙ„Ø§Ù†Ø³Ø±)</button>` : ``}
          ${mineBuyer && (o.status==="paid"||o.status==="delivered") ? `<button class="btn bad" onclick="openDispute(${o.id})">ÙØªØ­ Ù†Ø²Ø§Ø¹</button>` : ``}
        </div>
      </div>
    `;
  }).join("");
}

async function resumePay(orderId){
  try{
    requireUser();
    if(state.user.isGuest){ toast("<b>Ù„Ø§Ø²Ù… Pi</b>", 2000); return; }
    const order = state.orders.find(x=>x.id===orderId);
    if(!order) return;
    await startPiPaymentForOrder(order);
  }catch(err){
    console.error(err);
  }
}

async function markDelivered(orderId){
  try{
    requireUser();
    await sb.from("orders").update({ status:"delivered", delivered_at: new Date().toISOString() }).eq("id", orderId);
    toast("<b>ØªÙ… ÙˆØ¶Ø¹ Ø§Ù„Ø·Ù„Ø¨ ÙƒÙ€ Delivered</b>");
    await loadOrders();
  }catch(err){
    console.error(err);
    toast("<b>Ø®Ø·Ø£</b><br><small>"+(err.message||"")+"</small>", 3500);
  }
}

async function releasePayment(orderId){
  try{
    requireUser();
    const order = state.orders.find(x=>x.id===orderId);
    if(!order) return;
    if(order.buyer_id !== state.user.uid) throw new Error("Only buyer can release");

    // 1) update order status
    await sb.from("orders").update({ status:"released", released_at: new Date().toISOString() }).eq("id", orderId);

    // 2) credit seller in "donations" ledger (so your withdraw backend works)
    const gross = Number(order.amount_pi||0);
    const net = +(gross * (1-PLATFORM_FEE)).toFixed(7);

    const payload = {
      pi_user_id: order.seller_id,
      username: order.seller_username,
      amount: net,
      type: "earning",
      order_id: order.id,
      txid: order.txid || null,
      created_at: new Date().toISOString()
    };

    await sb.from("donations").insert(payload);

    toast(`<b>ØªÙ… Release âœ…</b><br><small>Ø§ØªØ³Ø¬Ù„Øª Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„ÙØ±ÙŠÙ„Ø§Ù†Ø³Ø±: ${net} Pi</small>`, 3600);
    await loadOrders();
    await refreshBalance();
  }catch(err){
    console.error(err);
    toast("<b>Release ÙØ´Ù„</b><br><small>"+(err.message||"")+"</small>", 3800);
  }
}

async function openDispute(orderId){
  openModal("ÙØªØ­ Ù†Ø²Ø§Ø¹", `
    <div class="muted">Ø§ÙƒØªØ¨ Ø³Ø¨Ø¨ Ø§Ù„Ù†Ø²Ø§Ø¹â€¦ (Ù†Ø³Ø®Ø© Ø¨Ø³ÙŠØ·Ø©)</div>
    <div class="sep"></div>
    <div class="field">
      <label>Ø§Ù„Ø³Ø¨Ø¨</label>
      <textarea id="disputeReason" placeholder="Ø§Ø´Ø±Ø­ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©â€¦"></textarea>
    </div>
    <div class="row" style="margin-top:10px; gap:8px; flex-wrap:wrap">
      <button class="btn bad" onclick="submitDispute(${orderId})">Ø¥Ø±Ø³Ø§Ù„</button>
      <button class="btn" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  `);
}

async function submitDispute(orderId){
  try{
    requireUser();
    const reason = $("disputeReason").value.trim();
    if(!reason){ toast("<b>Ø§ÙƒØªØ¨ Ø§Ù„Ø³Ø¨Ø¨</b>", 2000); return; }
    await sb.from("orders").update({ status:"disputed", dispute_reason: reason, disputed_at: new Date().toISOString() }).eq("id", orderId);
    closeModal();
    toast("<b>ØªÙ… ÙØªØ­ Ù†Ø²Ø§Ø¹</b><br><small>Ù…Ø­ØªØ§Ø¬ Admin flow Ù„Ø­Ù„Ù‡ (Ù…Ù…ÙƒÙ† Ø£Ø¶ÙŠÙÙ‡)</small>", 3600);
    await loadOrders();
  }catch(err){
    console.error(err);
    toast("<b>Ø®Ø·Ø£</b><br><small>"+(err.message||"")+"</small>", 3500);
  }
}

/** ===========================
 *  MESSAGES
 *  =========================== */
$("btnSendMsg").addEventListener("click", async ()=>{
  try{
    requireUser();
    const orderId = parseInt($("chatOrderId").value||"0",10);
    const text = $("chatText").value.trim();
    if(!orderId || !text){
      toast("<b>Ø§ÙƒØªØ¨ Order ID ÙˆØ§Ù„Ø±Ø³Ø§Ù„Ø©</b>", 2500);
      return;
    }
    const payload = {
      order_id: orderId,
      sender_id: state.user.uid,
      sender_username: state.user.username,
      text,
      created_at: new Date().toISOString()
    };
    const { error } = await sb.from("messages").insert(payload);
    if(error) throw error;
    $("chatText").value="";
    await loadMsgs();
  }catch(err){
    console.error(err);
    toast("<b>Ø®Ø·Ø£</b><br><small>"+(err.message||"")+"</small>", 3500);
  }
});

$("btnLoadMsgs").addEventListener("click", loadMsgs);

async function loadMsgs(){
  try{
    requireUser();
    const orderId = parseInt($("chatOrderId").value||"0",10);
    if(!orderId){ toast("<b>Ø§ÙƒØªØ¨ Order ID</b>", 2200); return; }

    const { data, error } = await sb.from("messages").select("*").eq("order_id", orderId).order("created_at",{ascending:false}).limit(50);
    if(error) throw error;

    const el = $("msgList");
    el.innerHTML = (data||[]).map(m=>{
      const mine = m.sender_id === state.user.uid;
      return `
        <div class="item">
          <div class="meta">
            <b>${mine ? "Ø£Ù†Øª" : "@"+escapeHtml(m.sender_username||"")}</b>
            <small>${escapeHtml(m.text||"")}</small>
            <small class="muted">${new Date(m.created_at).toLocaleString("ar-EG")}</small>
          </div>
        </div>
      `;
    }).join("") || `<div class="muted">Ù„Ø§ Ø±Ø³Ø§Ø¦Ù„</div>`;
  }catch(err){
    console.error(err);
  }
}

/** ===========================
 *  WALLET / BALANCE + WITHDRAW
 *  uses your backend logic: balance = sum(donations)-sum(withdrawals)
 *  =========================== */
async function refreshBalance(){
  if(!state.user){ $("balanceText").textContent="0"; return; }
  try{
    const uid = state.user.uid;

    const { data: d1 } = await sb.from("donations").select("amount").eq("pi_user_id", uid);
    const { data: d2 } = await sb.from("withdrawals").select("amount").eq("pi_user_id", uid);

    const totalIn = (d1||[]).reduce((s,r)=> s + parseFloat(r.amount||0), 0);
    const totalOut = (d2||[]).reduce((s,r)=> s + parseFloat(r.amount||0), 0);
    const bal = (totalIn - totalOut);

    $("balanceText").textContent = bal.toFixed(2);
  }catch(err){
    console.warn(err);
  }
}

$("btnWithdraw").addEventListener("click", async ()=>{
  try{
    requireUser();
    if(state.user.isGuest){
      toast("<b>Ø§Ù„Ø³Ø­Ø¨ ÙŠØ­ØªØ§Ø¬ Pi User</b>", 2500);
      return;
    }

    const amount = parseFloat($("withdrawAmount").value || "0");
    const walletAddress = $("withdrawTo").value.trim() || $("profileWallet").value.trim();

    if(!(amount>0) || !walletAddress){
      toast("<b>Ø§ÙƒØªØ¨ Ù…Ø¨Ù„Øº ÙˆØ¹Ù†ÙˆØ§Ù† Ø§Ù„Ø³Ø­Ø¨</b>", 2600);
      return;
    }

    toast("<b>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø³Ø­Ø¨...</b><br><small>Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ù„ÙˆÙƒØ´ÙŠÙ†</small>", 3500);

    const res = await apiPost("/api/withdraw", {
      uid: state.user.uid,
      username: state.user.username,
      amount: amount,
      walletAddress
    });

    if(res?.success){
      toast("<b>ØªÙ… Ø§Ù„Ø³Ø­Ø¨ âœ…</b><br><small class='mono'>txid: "+escapeHtml(res.txid||"")+"</small>", 5000);
      // Ø³Ø¬Ù„ Ø§Ù„Ø³Ø­Ø¨ ÙÙŠ DB Ø¨ÙŠØ­ØµÙ„ Ù…Ù† Ø§Ù„Ø¨Ø§Ùƒ Ø§Ù†Ø¯ Ø¨ØªØ§Ø¹Ùƒ Ø¨Ø§Ù„ÙØ¹Ù„
      await refreshBalance();
    }else{
      toast("<b>Ø§Ù„Ø³Ø­Ø¨ ÙØ´Ù„</b><br><small>"+escapeHtml(JSON.stringify(res))+"</small>", 5000);
    }
  }catch(err){
    console.error(err);
    toast("<b>Ø®Ø·Ø£</b><br><small>"+(err.message||"")+"</small>", 4000);
  }
});

/** ===========================
 *  API helper
 *  =========================== */
async function apiPost(path, body){
  const r = await fetch(API_BASE + path, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(body)
  });
  let data = null;
  try{ data = await r.json(); }catch(e){ data = await r.text(); }
  if(!r.ok){
    const msg = typeof data==="string" ? data : (data?.error?.error_message || data?.error?.message || JSON.stringify(data));
    throw new Error(msg || ("HTTP "+r.status));
  }
  return data;
}

/** ===========================
 *  UTIL
 *  =========================== */
function debounce(fn, ms){
  let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); };
}
function escapeHtml(s){
  return (s??"").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

/** ===========================
 *  INIT
 *  =========================== */
(async ()=>{
  // load public lists first (works even as guest)
  await loadGigs();
  await loadRequests();

  // default: no user
  setStatus("ØºÙŠØ± Ù…ØªØµÙ„");
})();
</script>

</body>
</html>
