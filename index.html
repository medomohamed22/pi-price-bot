<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Pi Elite Hub 2026 | Featured Ads</title>

  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <style>
    :root{
      --bg:#070A16;
      --bg2:#0b1226;
      --card:rgba(255,255,255,.07);
      --stroke:rgba(255,255,255,.12);
      --primary:#7c3aed;
      --primary2:#a855f7;
      --accent:#00f2fe;
      --gold:#f59e0b;
      --text:#ffffff;
      --muted:#a7b0c3;
      --r:22px;
      --nav-h: 76px;
      --safe: env(safe-area-inset-bottom);
    }

    *{box-sizing:border-box; -webkit-tap-highlight-color:transparent; outline:none;}
    body{
      margin:0; color:var(--text); font-family: system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at top, #1e1b4b, var(--bg));
      min-height:100vh; overflow-x:hidden;
    }

    .glass{ background: var(--card); border: 1px solid var(--stroke); backdrop-filter: blur(16px); border-radius: var(--r); }

    .page{ display:none; padding: 10px 14px calc(var(--nav-h) + 26px + var(--safe)); animation: fade .25s ease; }
    .page.active{ display:block; }
    @keyframes fade{ from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:translateY(0)} }

    /* Top AppBar */
    .app-bar {
      display: flex; justify-content: space-between; align-items: center;
      padding: 15px; margin-bottom: 15px; position: sticky; top: 0; z-index: 100;
    }

    .btn-login-top {
      background: var(--primary); color: white; border: none; padding: 8px 15px;
      border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 13px;
    }

    .ad-card.featured {
      border: 2px solid var(--gold);
      background: linear-gradient(145deg, rgba(245, 158, 11, 0.1), var(--card));
      box-shadow: 0 0 20px rgba(245, 158, 11, 0.15);
    }
    .featured-label {
      position: absolute; top: 10px; left: 10px;
      background: var(--gold); color: #000;
      padding: 4px 10px; border-radius: 8px;
      font-size: 10px; font-weight: 900; z-index: 5;
    }

    .ads-grid{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .ad-card{ position:relative; overflow:hidden; transition: transform .2s; }
    .ad-thumb{ width:100%; height:140px; object-fit:cover; display:block; }
    .ad-body{ padding: 12px; }
    .ad-title{ font-size: 13px; font-weight: 600; height: 34px; overflow: hidden; margin-bottom: 5px; }
    .price{ color: var(--accent); font-weight: 900; font-size: 16px; }

    .btn-main{
      width:100%; padding: 14px; border:none; border-radius: 16px;
      color: white; font-weight: 800; background: linear-gradient(90deg, var(--primary), var(--primary2));
      cursor:pointer;
    }
    .btn-gold{ background: linear-gradient(90deg, #f59e0b, #d97706); color: #000; font-weight: 900; }
    .btn-delete{ background: rgba(239, 68, 68, 0.1); border: 1px solid #ef4444; color: #ef4444; padding: 8px; border-radius: 10px; }

    .tab-bar{
      position: fixed; bottom:0; left:0; right:0; height: var(--nav-h);
      background: rgba(7,10,22,0.9); border-top: 1px solid var(--stroke);
      display:flex; align-items:center; justify-content:space-around; z-index: 1000;
      padding-bottom: var(--safe); backdrop-filter: blur(10px);
    }
    .tab-item{ color: var(--muted); display:flex; flex-direction:column; align-items:center; font-size: 11px; background:none; border:none; flex:1;}
    .tab-item.active{ color: var(--accent); }
    .tab-item i{ font-size: 20px; margin-bottom: 4px; }

    .toast{
      position: fixed; bottom: 100px; left: 20px; right: 20px;
      background: rgba(0,0,0,0.8); color: #fff; padding: 12px;
      border-radius: 12px; text-align: center; display: none; z-index: 2000;
    }
  </style>
</head>
<body>

  <div id="toast" class="toast"></div>

  <div class="app-bar glass">
    <div style="display: flex; align-items: center; gap: 10px;">
      <span style="font-size: 24px;">ðŸ’ </span>
      <b>Ø³ÙˆÙ‚ Ø§Ù„Ù†Ø®Ø¨Ø©</b>
    </div>
    <div id="auth-section">
      <button class="btn-login-top" id="login-btn" onclick="initPi()">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
      <span id="user-tag" style="display: none; font-size: 12px;" class="muted">@guest</span>
    </div>
  </div>

  <div id="page-home" class="page active">
    <div id="ads-grid" class="ads-grid"></div>
  </div>

  <div id="page-add" class="page">
    <div class="glass" style="padding: 20px;">
      <h3>Ø§Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù†Ùƒ</h3>
      <input type="file" id="p-img" accept="image/*" style="margin-bottom:10px" />
      <input type="text" id="p-title" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†" style="width:100%; padding:12px; margin-bottom:10px; border-radius:10px; background:rgba(255,255,255,0.05); border:1px solid var(--stroke); color:white;"/>
      <input type="number" id="p-price" placeholder="Ø§Ù„Ø³Ø¹Ø± Ø¨Ù€ Pi" style="width:100%; padding:12px; margin-bottom:10px; border-radius:10px; background:rgba(255,255,255,0.05); border:1px solid var(--stroke); color:white;"/>
      <textarea id="p-desc" placeholder="ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ..." style="width:100%; padding:12px; margin-bottom:15px; border-radius:10px; background:rgba(255,255,255,0.05); border:1px solid var(--stroke); color:white; height:100px;"></textarea>
      <button class="btn-main" onclick="uploadAd()">Ù†Ø´Ø± Ø§Ù„Ø¢Ù†</button>
    </div>
  </div>

  <div id="page-profile" class="page">
    <div class="glass" style="padding:15px; margin-bottom:15px;">
        <h3 style="margin-top:0">Ø¥Ø¹Ù„Ø§Ù†Ø§ØªÙŠ</h3>
        <button class="btn-main btn-gold" onclick="requestWithdraw()">Ø·Ù„Ø¨ Ø³Ø­Ø¨ Ø±ØµÙŠØ¯</button>
    </div>
    <div id="my-ads-grid" class="ads-grid"></div>
  </div>

  <nav class="tab-bar" id="navbar">
    <button class="tab-item active" onclick="nav('home', this)"><i class="fas fa-store"></i>Ø§Ù„Ø³ÙˆÙ‚</button>
    <button class="tab-item" onclick="nav('add', this)"><i class="fas fa-plus-circle"></i>Ù†Ø´Ø±</button>
    <button class="tab-item" onclick="nav('profile', this)"><i class="fas fa-user-circle"></i>Ø­Ø³Ø§Ø¨ÙŠ</button>
  </nav>

  <script>
    const SB_URL = 'https://axjkwrssmofzavaoqutq.supabase.co';
    const SB_KEY = 'sb_publishable_tiuMncgWhf1YRWoD-uYQ3Q_ziI8OKci'; 
    const _sb = supabase.createClient(SB_URL, SB_KEY);

    let user = null;
    let allAds = [];

    // Initialize Ads on Load
    window.onload = () => {
        loadAds();
    };

    async function initPi(){
      try {
        const Pi = window.Pi;
        Pi.init({ version: "2.0" });
        const auth = await Pi.authenticate(['username'], (payment) => {});
        user = auth.user;
        
        // Update UI after login
        document.getElementById('login-btn').style.display = 'none';
        document.getElementById('user-tag').style.display = 'block';
        document.getElementById('user-tag').textContent = `@${user.username}`;
        
        toast("Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ " + user.username);
        if(document.getElementById('page-profile').classList.contains('active')) loadMyAds();
      } catch (e) {
        alert("ÙŠØ±Ø¬Ù‰ ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ù† Ø¯Ø§Ø®Ù„ Pi Browser Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
      }
    }

    function nav(id, btn){
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('page-' + id).classList.add('active');
      if(btn){
        document.querySelectorAll('.tab-item').forEach(i => i.classList.remove('active'));
        btn.classList.add('active');
      }
      if(id === 'home') loadAds();
      if(id === 'profile') {
          if(!user) toast("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");
          else loadMyAds();
      }
    }

    async function loadAds(){
      const { data, error } = await _sb.from('ads').select('*').order('created_at', {ascending: false});
      if(data) {
        allAds = data;
        renderGrid(allAds, 'ads-grid', false);
      }
    }

    async function loadMyAds(){
      if(!user) return;
      const { data } = await _sb.from('ads').select('*').eq('seller_username', user.username);
      renderGrid(data || [], 'my-ads-grid', true);
    }

    function renderGrid(data, containerId, isOwner){
      const container = document.getElementById(containerId);
      const now = new Date();
      
      const sorted = data.sort((a, b) => {
        const aF = a.featured_until && new Date(a.featured_until) > now;
        const bF = b.featured_until && new Date(b.featured_until) > now;
        return bF - aF;
      });

      container.innerHTML = sorted.map(ad => {
        const isFeatured = ad.featured_until && new Date(ad.featured_until) > now;
        return `
          <div class="glass ad-card ${isFeatured ? 'featured' : ''}">
            ${isFeatured ? '<div class="featured-label"><i class="fas fa-crown"></i> Ù…Ù…ÙŠØ²</div>' : ''}
            <img class="ad-thumb" src="${SB_URL}/storage/v1/object/public/ads-images/${ad.image_url}" onerror="this.src='https://via.placeholder.com/150'">
            <div class="ad-body">
              <div class="ad-title">${ad.title}</div>
              <div class="price">${ad.price} Pi</div>
              ${isOwner ? `
                <div style="margin-top:10px; display:flex; gap:5px;">
                   <button class="btn-delete" onclick="deleteAd('${ad.id}')"><i class="fas fa-trash"></i></button>
                   <button class="btn-main btn-gold" style="font-size:10px; padding:5px;" onclick="featureAd('${ad.id}')">ØªÙ…ÙŠØ² Ø¨Ù€ 5 Pi</button>
                </div>
              ` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    async function featureAd(adId) {
      if(!user) return toast("Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");
      try {
        const payment = await Pi.createPayment({
          amount: 5.0,
          memo: "ØªÙ…ÙŠÙŠØ² Ø¥Ø¹Ù„Ø§Ù† Ù„Ù…Ø¯Ø© 3 Ø£ÙŠØ§Ù…",
          metadata: { adId: adId, type: "feature_ad" },
        }, {
          onReadyForServerApproval: (paymentId) => {
            fetch('/api/pi/approve', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({ paymentId, adId })
            });
          },
          onReadyForServerCompletion: (paymentId, txid) => {
            fetch('/api/pi/complete', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({ paymentId, txid, adId })
            }).then(() => {
              toast("ØªÙ… Ø§Ù„ØªÙ…ÙŠÙŠØ² Ø¨Ù†Ø¬Ø§Ø­! â­");
              loadAds();
            });
          },
          onCancel: (pId) => toast("ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡"),
          onError: (err, p) => toast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¯ÙØ¹")
        });
      } catch (e) { toast("ÙØ´Ù„ Ø¨Ø¯Ø¡ Ø§Ù„Ø¯ÙØ¹"); }
    }

    async function uploadAd(){
      if(!user) return toast("Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ù„Ù†Ø´Ø±");
      toast("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù†Ø´Ø±...");
    }

    function toast(msg){
      const t = document.getElementById('toast');
      t.textContent = msg; t.style.display = 'block';
      setTimeout(() => t.style.display = 'none', 3000);
    }
  </script>
</body>
</html>
