<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Gemini AI Chat</title>

<!-- Pi Network SDK -->
<script src="https://sdk.minepi.com/pi-sdk.js"></script>

<style>
:root{
  --primary:#7f5cff;
  --bg:#0f0f1a;
  --card:#1a1a2e;
  --ai:#2a2a40;
  --user:#7f5cff;
}
*{box-sizing:border-box}
body{
  margin:0;
  background:var(--bg);
  font-family: system-ui, -apple-system;
  height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  color:#ffffff;
}
.chat{
  width:100%;
  max-width:420px;
  height:100vh;
  background:var(--card);
  display:flex;
  flex-direction:column;
  position:relative;
}
.header{
  padding:14px;
  text-align:center;
  background:linear-gradient(135deg,var(--primary),#b48cff);
  font-weight:bold;
  position:relative;
}
#pointsDisplay{
  position:absolute;
  right:15px;
  top:14px;
  font-size:14px;
  font-weight:normal;
}
.messages{
  flex:1;
  padding:12px;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.msg{
  padding:12px 14px;
  border-radius:14px;
  max-width:90%;
  line-height:1.6;
  word-wrap:break-word;
  color:#ffffff;
  animation:fadeUp .25s ease;
}
.user{background:var(--user);align-self:flex-end;}
.ai{background:var(--ai);align-self:flex-start;}
.input-box{
  display:flex;
  gap:8px;
  padding:10px;
  background:#141423;
}
input{
  flex:1;
  padding:12px;
  border-radius:12px;
  border:none;
  outline:none;
  font-size:15px;
  color:#ffffff;
  background:#0f0f1a;
}
input::placeholder{color:#cccccc;}
button{
  padding:12px 16px;
  border-radius:12px;
  border:none;
  background:var(--primary);
  color:#ffffff;
  font-weight:bold;
  cursor:pointer;
  transition:0.2s;
}
button:hover{
  transform:scale(1.05);
}
.typing{display:flex;gap:6px;}
.dot{
  width:6px;height:6px;
  background:#ffffff;
  border-radius:50%;
  animation:blink 1.4s infinite both;
}
.dot:nth-child(2){animation-delay:.2s;}
.dot:nth-child(3){animation-delay:.4s;}
@keyframes blink{
  0%{opacity:.2}
  20%{opacity:1}
  100%{opacity:.2}
}
@keyframes fadeUp{
  from{opacity:0; transform:translateY(6px)}
  to{opacity:1; transform:translateY(0)}
}
/* Overlay Ø§Ù„Ø¯ÙØ¹ */
#payOverlay{
  position:absolute;
  top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.85);
  display:none;flex-direction:column;
  justify-content:center;align-items:center;color:white;
  text-align:center;z-index:50;padding:20px;
}
#payOverlay button{
  margin-top:10px;
}
</style>
</head>

<body>

<div class="chat">
  <div class="header">Gemini AI
    <span id="pointsDisplay"></span>
  </div>

  <div class="messages" id="messages">
    <div class="msg ai">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ! Ù„Ø¯ÙŠÙƒ 5 Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù…Ø¬Ø§Ù†ÙŠØ©. Ø§Ø³Ø£Ù„Ù†ÙŠ Ø£ÙŠ Ø´ÙŠØ¡.</div>
  </div>

  <div id="payOverlay">
    <h3>âš ï¸ Ø§Ù†ØªÙ‡Øª Ù†Ù‚Ø§Ø·Ùƒ!</h3>
    <p>Ø§Ø´Ø­Ù† Ø§Ù„Ø¢Ù† Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
    <p><b>1 Pi = 20 Ù†Ù‚Ø·Ø©</b></p>
    <button onclick="handlePayment()">Ø§Ø´Ø­Ù† 20 Ù†Ù‚Ø·Ø© Ø¨ÙˆØ§Ø³Ø·Ø© Pi</button>
  </div>

  <div class="input-box">
    <input id="input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ...">
    <button onclick="send()">â¤</button>
  </div>
</div>

<script>
Pi.init({version:"2.0"}); // ØªÙ‡ÙŠØ¦Ø© Pi SDK

const messagesDiv = document.getElementById("messages");
const input = document.getElementById("input");
const payOverlay = document.getElementById("payOverlay");

// Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
let userPoints = localStorage.getItem("chatPoints");
if(userPoints===null){ userPoints=5; localStorage.setItem("chatPoints",userPoints); }
else userPoints=parseInt(userPoints);

function updatePoints(){document.getElementById("pointsDisplay").innerText=`Ø§Ù„Ù†Ù‚Ø§Ø·: ${userPoints}`;}
updatePoints();

// Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
let history = JSON.parse(localStorage.getItem("chatHistory")||"[]");
history.forEach(m=>addMsg(m.text,m.role));
function save(){localStorage.setItem("chatHistory",JSON.stringify(history));}

// Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø©
function addMsg(text,role){
  const div=document.createElement("div");
  div.className=`msg ${role}`;
  div.innerText=text;
  messagesDiv.appendChild(div);
  messagesDiv.scrollTop=messagesDiv.scrollHeight;
}

// ØªØ£Ø«ÙŠØ± Ø§Ù†ØªØ¸Ø§Ø±
function typing(){
  const div=document.createElement("div");
  div.className="msg ai typing";
  div.innerHTML=`<div class="dot"></div><div class="dot"></div><div class="dot"></div>`;
  messagesDiv.appendChild(div);
  messagesDiv.scrollTop=messagesDiv.scrollHeight;
  return div;
}

// Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
async function send(){
  if(userPoints<=0){payOverlay.style.display="flex"; return;}
  const text=input.value.trim();
  if(!text) return;
  input.value="";
  addMsg(text,"user");
  history.push({role:"user",text}); save();
  userPoints--; localStorage.setItem("chatPoints",userPoints); updatePoints();

  const loader = typing();
  try{
    const res = await fetch("/api/gemini/chat",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({message:text})
    });
    const data = await res.json();
    loader.remove();
    const reply = data.reply||"âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø¯ Ù…Ù† Gemini";
    addMsg(reply,"ai");
    history.push({role:"ai",text:reply}); save();
  }catch{
    loader.remove();
    addMsg("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„","ai");
  }
}

// Ø§Ù„Ø¯ÙØ¹ Ø¨ÙˆØ§Ø³Ø·Ø© Pi
async function handlePayment(){
  try{
    const user = await Pi.authenticate(["username","payments"]);
    const paymentData = {amount:1,memo:"Ø´Ø±Ø§Ø¡ 20 Ù†Ù‚Ø·Ø©",metadata:{points:20}};
    const callbacks = {
      onReadyForServerApproval: async(paymentId)=>{
        await fetch("/api/pi/approve",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({paymentId})});
      },
      onReadyForServerCompletion: async(paymentId,txid)=>{
        await fetch("/api/pi/complete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({paymentId,txid})});
        userPoints+=20; localStorage.setItem("chatPoints",userPoints); updatePoints();
        payOverlay.style.display="none";
        addMsg("âœ… ØªÙ… Ø´Ø­Ù† 20 Ù†Ù‚Ø·Ø© Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰","ai");
      },
      onCancel:()=>alert("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¯ÙØ¹"),
      onError:(err)=>alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¯ÙØ¹")
    };
    Pi.createPayment(paymentData,callbacks);
  }catch{alert("ÙŠØ¬Ø¨ ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Ø¯Ø§Ø®Ù„ Pi Browser");}
}

// Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø±Ø³Ø§Ù„Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter
input.addEventListener("keydown",e=>{if(e.key==="Enter") send();});
</script>

</body>
</html>
